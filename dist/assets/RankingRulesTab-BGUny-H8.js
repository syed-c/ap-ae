import{b as J,u as C,c as P,j as e}from"./chunk-CPh6voF3.js";import{r as o}from"./chunk-CffrGP6S.js";import{B,T as $,Z as z,i,I as X,a2 as Y,a3 as ee,a5 as se,a6 as ae,a7 as te,n as F,o as W,C as V,t as ie,s as n,b as p}from"./index-DflORfjh.js";import{C as m,d as x,a as g,b as f,c as j}from"./chunk-Dwq_v72W.js";import{S as le}from"./chunk-FxOzQZIr.js";import{S as q}from"./chunk-DfjE-bP6.js";import{T as re,a as ne,b as S,c,d as ce,e as l}from"./chunk-NLs5Ye4A.js";import{T as de,a as oe,b as v,c as N}from"./chunk-k8HiDHrE.js";import{R as A}from"./chunk-BOvFDp2b.js";import{S as me}from"./chunk-C7BdFRQZ.js";import{S as xe}from"./chunk-C2VW2Ml6.js";import{T as ue}from"./chunk-DbdCK11k.js";import{E as he}from"./chunk-CcezodbN.js";import{C as pe}from"./chunk-wy0nNZZG.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-Drd-rt-S.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";const ge=[{key:"verification_status",label:"Verification Status",description:"Verified profiles rank highest",weight:40,maxWeight:50,icon:W},{key:"claim_status",label:"Claim Status",description:"Claimed profiles rank above unclaimed",weight:25,maxWeight:30,icon:V},{key:"profile_completeness",label:"Profile Completeness",description:"Complete profiles with photos, services, etc.",weight:15,maxWeight:20,icon:pe},{key:"review_score",label:"Review Score",description:"Google rating and review count",weight:10,maxWeight:15,icon:F},{key:"responsiveness",label:"Lead Responsiveness",description:"How quickly clinic responds to leads",weight:5,maxWeight:10,icon:ie},{key:"freshness",label:"Profile Freshness",description:"Recently updated profiles get boost",weight:5,maxWeight:10,icon:A}],fe=[{key:"verified_badge",label:"Verified Badge",description:"+50% score for verified clinics",multiplier:1.5,enabled:!0},{key:"featured_placement",label:"Featured Placement",description:"+100% score for featured/sponsored",multiplier:2,enabled:!0},{key:"area_sponsor",label:"Area Sponsor",description:"+75% score when sponsoring an area",multiplier:1.75,enabled:!0},{key:"high_response_rate",label:"High Response Rate",description:"+20% for >90% lead response",multiplier:1.2,enabled:!0}],je=[{key:"duplicate_flag",label:"Duplicate Flag",description:"-80% for duplicate listings",penalty:.8,enabled:!0},{key:"spam_reports",label:"Spam Reports",description:"-50% for spam flags",penalty:.5,enabled:!0},{key:"negative_feedback",label:"High Negative Feedback",description:"-30% for excessive private complaints",penalty:.3,enabled:!0},{key:"incomplete_profile",label:"Incomplete Profile",description:"-20% for profiles missing key info",penalty:.2,enabled:!0},{key:"stale_profile",label:"Stale Profile",description:"-10% for profiles not updated in 6mo",penalty:.1,enabled:!0}];function Ie(){const E=J(),[H,I]=o.useState("factors"),[u,_]=o.useState(ge),[d,b]=o.useState(fe),[h,R]=o.useState(je),[r,K]=o.useState("");C({queryKey:["ranking-rules"],queryFn:async()=>{const{data:s}=await n.from("global_settings").select("value").eq("key","ranking_rules").maybeSingle();if(s?.value){const a=typeof s.value=="string"?JSON.parse(s.value):s.value;a.factors&&_(a.factors),a.boosts&&b(a.boosts),a.penalties&&R(a.penalties)}return s}});const{data:M}=C({queryKey:["cities-preview"],queryFn:async()=>{const{data:s}=await n.from("cities").select("id, name, slug").eq("is_active",!0);return s||[]}}),{data:y,refetch:D}=C({queryKey:["ranking-preview",r],queryFn:async()=>{let s=n.from("clinics").select(`
          id, name, slug, address, claim_status, verification_status,
          rating, review_count,
          city:cities(name)
        `).eq("is_active",!0).order("verification_status",{ascending:!1}).order("claim_status",{ascending:!1}).order("rating",{ascending:!1}).limit(20);r&&(s=s.eq("city_id",r));const{data:a}=await s;return a||[]},enabled:!!r}),T=P({mutationFn:async()=>{const s={factors:u,boosts:d,penalties:h},{data:a}=await n.from("global_settings").select("id").eq("key","ranking_rules").maybeSingle();a?await n.from("global_settings").update({value:s,updated_at:new Date().toISOString()}).eq("id",a.id):await n.from("global_settings").insert({key:"ranking_rules",value:s})},onSuccess:()=>{p.success("Ranking rules saved to database"),E.invalidateQueries({queryKey:["ranking-rules"]})},onError:s=>p.error(s.message)}),w=P({mutationFn:async()=>0,onSuccess:()=>{p.success("Ranking calculation initiated"),D()},onError:s=>p.error(s.message)}),L=(s,a)=>{_(u.map(t=>t.key===s?{...t,weight:a}:t))},Q=(s,a)=>{b(d.map(t=>t.key===s?{...t,enabled:a}:t))},U=(s,a)=>{b(d.map(t=>t.key===s?{...t,multiplier:a}:t))},O=(s,a)=>{R(h.map(t=>t.key===s?{...t,enabled:a}:t))},k=u.reduce((s,a)=>s+a.weight,0),Z=s=>{switch(s){case"verified":return e.jsxs(i,{className:"bg-teal/20 text-teal",children:[e.jsx(W,{className:"h-3 w-3 mr-1"}),"Verified"]});case"pending":return e.jsx(i,{className:"bg-gold/20 text-gold",children:"Pending"});default:return e.jsx(i,{variant:"outline",children:"Unverified"})}},G=s=>{switch(s){case"claimed":return e.jsxs(i,{className:"bg-primary/20 text-primary",children:[e.jsx(V,{className:"h-3 w-3 mr-1"}),"Claimed"]});case"pending":return e.jsx(i,{className:"bg-gold/20 text-gold",children:"Pending"});default:return e.jsx(i,{variant:"outline",children:"Unclaimed"})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-display font-bold text-foreground",children:"Ranking Rules"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Control how clinics are ranked in search and listings"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(B,{variant:"outline",onClick:()=>w.mutate(),disabled:w.isPending,children:[e.jsx(A,{className:`h-4 w-4 mr-2 ${w.isPending?"animate-spin":""}`}),"Recalculate All"]}),e.jsxs(B,{onClick:()=>T.mutate(),disabled:T.isPending,children:[e.jsx(me,{className:"h-4 w-4 mr-2"}),"Save Rules"]})]})]}),e.jsx(m,{className:"card-modern",children:e.jsx(x,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx($,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-bold",children:["Total Weight: ",k,"%"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:k===100?"✓ Weights are balanced":k>100?"⚠️ Weights exceed 100%":"⚠️ Weights below 100%"})]})]}),e.jsxs("div",{className:"flex gap-6 text-sm",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"font-bold text-teal",children:d.filter(s=>s.enabled).length}),e.jsx("p",{className:"text-muted-foreground",children:"Active Boosts"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"font-bold text-coral",children:h.filter(s=>s.enabled).length}),e.jsx("p",{className:"text-muted-foreground",children:"Active Penalties"})]})]})]})})}),e.jsxs(de,{value:H,onValueChange:I,children:[e.jsxs(oe,{className:"grid w-full grid-cols-4 rounded-xl",children:[e.jsxs(v,{value:"factors",className:"rounded-xl",children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Base Factors"]}),e.jsxs(v,{value:"boosts",className:"rounded-xl",children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Boosts"]}),e.jsxs(v,{value:"penalties",className:"rounded-xl",children:[e.jsx(ue,{className:"h-4 w-4 mr-2"}),"Penalties"]}),e.jsxs(v,{value:"preview",className:"rounded-xl",children:[e.jsx(he,{className:"h-4 w-4 mr-2"}),"Preview"]})]}),e.jsx(N,{value:"factors",className:"mt-4",children:e.jsxs(m,{className:"card-modern",children:[e.jsxs(g,{children:[e.jsx(f,{className:"text-lg",children:"Base Ranking Factors"}),e.jsx(j,{children:"Adjust the weight of each factor in the ranking algorithm"})]}),e.jsx(x,{className:"space-y-6",children:u.map(s=>{const a=s.icon;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(a,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold",children:s.label}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.description})]})]}),e.jsxs(i,{variant:"outline",className:"text-lg font-bold px-4",children:[s.weight,"%"]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-sm text-muted-foreground w-8",children:"0%"}),e.jsx(le,{value:[s.weight],onValueChange:([t])=>L(s.key,t),max:s.maxWeight,step:1,className:"flex-1"}),e.jsxs("span",{className:"text-sm text-muted-foreground w-12",children:[s.maxWeight,"%"]})]})]},s.key)})})]})}),e.jsx(N,{value:"boosts",className:"mt-4",children:e.jsxs(m,{className:"card-modern",children:[e.jsxs(g,{children:[e.jsx(f,{className:"text-lg",children:"Ranking Boosts"}),e.jsx(j,{children:"Score multipliers for premium or high-performing clinics"})]}),e.jsx(x,{className:"space-y-4",children:d.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(q,{checked:s.enabled,onCheckedChange:a=>Q(s.key,a)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold",children:s.label}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.description})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Multiplier:"}),e.jsx(X,{type:"number",value:s.multiplier,onChange:a=>U(s.key,parseFloat(a.target.value)||1),className:"w-20 text-center",step:.1,min:1,max:5,disabled:!s.enabled}),e.jsx("span",{className:"text-sm font-medium",children:"x"})]})]},s.key))})]})}),e.jsx(N,{value:"penalties",className:"mt-4",children:e.jsxs(m,{className:"card-modern",children:[e.jsxs(g,{children:[e.jsx(f,{className:"text-lg",children:"Ranking Penalties"}),e.jsx(j,{children:"Score deductions for problematic listings"})]}),e.jsx(x,{className:"space-y-4",children:h.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(q,{checked:s.enabled,onCheckedChange:a=>O(s.key,a)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold",children:s.label}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.description})]})]}),e.jsxs(i,{variant:s.enabled?"destructive":"outline",className:"px-4",children:["-",Math.round(s.penalty*100),"%"]})]},s.key))})]})}),e.jsx(N,{value:"preview",className:"mt-4",children:e.jsxs(m,{className:"card-modern",children:[e.jsx(g,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(f,{className:"text-lg",children:"Ranking Preview"}),e.jsx(j,{children:"See how clinics rank with current rules"})]}),e.jsx("div",{className:"flex gap-4",children:e.jsxs(Y,{value:r,onValueChange:K,children:[e.jsx(ee,{className:"w-48",children:e.jsx(se,{placeholder:"Select city"})}),e.jsx(ae,{children:M?.map(s=>e.jsx(te,{value:s.id,children:s.name},s.id))})]})})]})}),e.jsx(x,{className:"p-0",children:e.jsxs(re,{children:[e.jsx(ne,{children:e.jsxs(S,{children:[e.jsx(c,{className:"w-12",children:"#"}),e.jsx(c,{children:"Clinic"}),e.jsx(c,{children:"Location"}),e.jsx(c,{children:"Verification"}),e.jsx(c,{children:"Claim"}),e.jsx(c,{children:"Rating"})]})}),e.jsxs(ce,{children:[y?.map((s,a)=>e.jsxs(S,{children:[e.jsx(l,{className:"font-bold",children:a+1}),e.jsxs(l,{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground truncate max-w-[200px]",children:s.address})]}),e.jsx(l,{className:"text-muted-foreground",children:s.city?.name||"-"}),e.jsx(l,{children:Z(s.verification_status||"unverified")}),e.jsx(l,{children:G(s.claim_status||"unclaimed")}),e.jsx(l,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(F,{className:"h-4 w-4 text-gold fill-gold"}),e.jsx("span",{className:"font-medium",children:s.rating||0}),e.jsxs("span",{className:"text-muted-foreground text-xs",children:["(",s.review_count||0,")"]})]})})]},s.id)),(!y||y.length===0)&&e.jsx(S,{children:e.jsx(l,{colSpan:6,className:"text-center py-8 text-muted-foreground",children:r?"No clinics found in this city":"Select a city to preview rankings"})})]})]})})]})})]})]})}export{Ie as default};
