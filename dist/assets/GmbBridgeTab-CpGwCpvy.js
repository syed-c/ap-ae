import{j as e}from"./chunk-CPh6voF3.js";import{r as n}from"./chunk-CffrGP6S.js";import{b as _e}from"./chunk-DlLtMEml.js";import{am as Ee,an as Re,L as D,p as le,a as B,a2 as F,a3 as M,a5 as O,a6 as L,a7 as _,B as C,F as ne,Z as $e,w as ie,C as Ge,b7 as De,x as Be,n as Fe,i as ce,G as Me,b as o,s as Y}from"./index-DflORfjh.js";import{C as N,d as y,a as oe,b as de}from"./chunk-Dwq_v72W.js";import{T as Oe,a as Le,b as me,c as E,d as qe,e as R}from"./chunk-NLs5Ye4A.js";import{A as he,a as xe}from"./chunk-BY_S87Nl.js";import{T as ue}from"./chunk-DbdCK11k.js";import{I as ze}from"./chunk-I1o_Hd8I.js";import{D as pe}from"./chunk-z-mlRDN4.js";import"./chunk-BSjc5zjM.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-Drd-rt-S.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";function is(){const{data:q}=Ee(),[p,ge]=n.useState(""),{data:z}=Re(p||void 0),[g,K]=n.useState(""),{data:P}=_e(g||void 0),[A,H]=n.useState(""),[Z,fe]=n.useState("dentist"),[S,w]=n.useState(!1),[J,Q]=n.useState(!1),[f,d]=n.useState([]),[W,v]=n.useState(null),[b,j]=n.useState(new Set),[je,I]=n.useState(!1),[Ne,T]=n.useState(null),[X,k]=n.useState(""),$=n.useMemo(()=>q?.find(s=>s.id===p)??null,[q,p]),ee=n.useMemo(()=>z?.find(s=>s.id===g)??null,[z,g]),ye=n.useMemo(()=>P?.find(s=>s.id===A)??null,[P,A]),Se=["dentist","dental clinic","orthodontist","dental surgeon","pediatric dentist","cosmetic dentist","endodontist","periodontist","prosthodontist","oral surgeon","dental office","family dentist","emergency dentist"],be=[{value:"dentist",label:"Dentist"},{value:"dental clinic",label:"Dental Clinic"},{value:"orthodontist",label:"Orthodontist"},{value:"dental surgeon",label:"Dental Surgeon"},{value:"pediatric dentist",label:"Pediatric Dentist"},{value:"cosmetic dentist",label:"Cosmetic Dentist"}],U=(s,t)=>{const r=new Map;for(const a of s)r.set(a.place_id,a);for(const a of t)r.set(a.place_id,a);return Array.from(r.values())},se=async(s={})=>{if(!p||!g)throw new Error("Please select a state and city");const t=ee?.name||"",r=ye?.name||"",a=$?.abbreviation||$?.name||"",{data:l,error:m}=await Y.functions.invoke("gmb-import",{body:{action:"search",category:Z,city:t,state:a,area:r,pageToken:s.pageToken}});if(m)throw m;if(l?.requiresSetup)throw I(!0),T(l?.solution||l?.setupInstructions||null),new Error(l?.error||"Google Places API key not configured");if(!l?.success)throw(l?.error?.includes("referer restrictions")||l?.error?.includes("REQUEST_DENIED"))&&(I(!0),T(l?.solution||"Your Google API key has HTTP referrer restrictions. Create a new key with NO restrictions or IP restrictions only.")),new Error(l?.error||"Search failed");return I(!1),T(null),{results:l.results||[],nextPageToken:l.next_page_token||null}},te=async(s=!1)=>{w(!0);try{const{results:t,nextPageToken:r}=await se({pageToken:s&&W||void 0});v(r),s?d(a=>{const l=U(a,t);return o.success(`Fetched ${l.length} results`),l}):(d(t),j(new Set),o.success(`Fetched ${t.length} results`))}catch(t){const r=t instanceof Error?t.message:"Search failed";o.error(r)}finally{w(!1)}},we=async()=>{w(!0);try{d([]),j(new Set),v(null);let s=null,t=[];for(let r=0;r<5;r++){k(`Fetching page ${r+1}...`);const{results:a,nextPageToken:l}=await se({pageToken:s||void 0});if(t=U(t,a),s=l,!s)break}d(t),v(s),k(""),o.success(`Fetched ${t.length} results`)}catch(s){const t=s instanceof Error?s.message:"Search failed";o.error(t),k("")}finally{w(!1)}},ve=async()=>{if(!p||!g){o.error("Please select a state and city");return}w(!0),d([]),j(new Set),v(null);let s=[];const t=P?.length?P:[{id:"",name:""}],r=Se;try{let a=0;const l=r.length*t.length;for(const m of r)for(const c of t){a++,k(`Searching "${m}" in ${c.name||"city"} (${a}/${l})...`);try{const i=ee?.name||"",x=c.name||"",G=$?.abbreviation||$?.name||"";let u=null;for(let ae=0;ae<3;ae++){const{data:h,error:re}=await Y.functions.invoke("gmb-import",{body:{action:"search",category:m,city:i,state:G,area:x,pageToken:u||void 0}});if(re)throw re;if(h?.requiresSetup)throw I(!0),T(h?.solution||h?.setupInstructions||null),new Error(h?.error||"API key not configured");if(!h?.success){if(h?.error?.includes("referer restrictions"))throw I(!0),T(h?.solution||"Your API key has HTTP referrer restrictions."),new Error(h?.error);break}const Te=h.results||[];if(s=U(s,Te),u=h.next_page_token||null,s.length%50===0&&d([...s]),!u)break}}catch(i){if(i instanceof Error&&i.message.includes("API key"))throw i;console.warn(`Search failed for ${m} in ${c.name}:`,i)}}d(s),k(""),o.success(`Found ${s.length} unique dental practices!`)}catch(a){const l=a instanceof Error?a.message:"Search failed";o.error(l),k("")}finally{w(!1)}},ke=(s,t)=>{const r=[];for(let a=0;a<s.length;a+=t)r.push(s.slice(a,a+t));return r},Ce=async()=>{if(b.size===0){o.error("Please select places to import");return}Q(!0);const s=Array.from(b),t=ke(s,50),r=new Set;let a=0,l=0;const m=[];try{for(let c=0;c<t.length;c++){const i=t[c],{data:x,error:G}=await Y.functions.invoke("gmb-import",{body:{action:"import",placeIds:i,cityId:g,...A?{areaId:A}:{}}});if(G)throw G;if(!x?.success)throw new Error(x?.error||"Import failed");a+=x.imported||0,l+=x.duplicates||0;for(const u of x.imported_place_ids||[])r.add(u);for(const u of x.duplicate_place_ids||[])r.add(u);for(const u of x.errors||[])m.push(u);o.success(`Imported batch ${c+1}/${t.length}`)}o.success(`Imported ${a} clinics. ${l} duplicates skipped.`),d(c=>c.map(i=>({...i,already_imported:r.has(i.place_id)?!0:i.already_imported}))),j(new Set),m.length>0&&o.error(`Some imports failed (${m.length}). Check audit logs for details.`)}catch(c){const i=c instanceof Error?c.message:"Import failed";o.error(i)}finally{Q(!1)}},Pe=s=>{const t=new Set(b);t.has(s)?t.delete(s):t.add(s),j(t)},Ae=()=>{const s=f.filter(t=>!t.already_imported).map(t=>t.place_id);j(new Set(s))},V=f.filter(s=>!s.already_imported).length,Ie=f.filter(s=>s.already_imported).length;return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-display font-bold text-foreground",children:"Google Bridge"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Import clinics from Google Business Profiles"})]})}),je&&e.jsx(N,{className:"card-modern border-destructive/50 bg-destructive/5",children:e.jsxs(y,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ue,{className:"h-5 w-5 text-destructive"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-destructive",children:"API Key Configuration Required"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:Ne||"Please add GOOGLE_PLACES_API_KEY in backend secrets to enable Google import."})]})]}),e.jsxs("div",{className:"bg-muted/50 rounded-lg p-3 text-sm space-y-2",children:[e.jsx("p",{className:"font-medium text-foreground",children:"How to fix:"}),e.jsxs("ol",{className:"list-decimal list-inside space-y-1 text-muted-foreground",children:[e.jsxs("li",{children:["Go to ",e.jsx("a",{href:"https://console.cloud.google.com/apis/credentials",target:"_blank",rel:"noopener noreferrer",className:"text-primary underline",children:"Google Cloud Console â†’ Credentials"})]}),e.jsx("li",{children:"Create a new API Key (or edit existing)"}),e.jsxs("li",{children:['Under "Application restrictions", select ',e.jsx("strong",{children:'"None"'})," or ",e.jsx("strong",{children:'"IP addresses"'})]}),e.jsxs("li",{children:[e.jsx("strong",{children:'Do NOT use "HTTP referrers"'})," - this doesn't work with server-side API calls"]}),e.jsxs("li",{children:['Under "API restrictions", enable ',e.jsx("strong",{children:"Places API"})," and ",e.jsx("strong",{children:"Maps JavaScript API"})]}),e.jsxs("li",{children:["Add the new key to backend secrets as ",e.jsx("code",{className:"bg-background px-1 rounded",children:"GOOGLE_PLACES_API_KEY"})]})]})]})]})}),e.jsxs(he,{className:"bg-primary/5 border-primary/20",children:[e.jsx(ze,{className:"h-4 w-4 text-primary"}),e.jsxs(xe,{className:"text-sm",children:[e.jsx("strong",{children:"Note:"})," Google Places API returns max 60 results per search query. Use ",e.jsx("strong",{children:'"Super Search"'})," to search across all dental categories (dentist, orthodontist, surgeon, etc.) and all areas to find MORE listings. For large cities, run Super Search multiple times or search specific areas."]})]}),X&&e.jsxs(he,{className:"bg-muted border-muted-foreground/20",children:[e.jsx(D,{className:"h-4 w-4 animate-spin text-primary"}),e.jsx(xe,{className:"text-sm font-medium",children:X})]}),e.jsxs(N,{className:"card-modern",children:[e.jsx(oe,{children:e.jsxs(de,{className:"text-lg flex items-center gap-2",children:[e.jsx(le,{className:"h-5 w-5"}),"Search Parameters"]})}),e.jsx(y,{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-5",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{children:"Category"}),e.jsxs(F,{value:Z,onValueChange:fe,children:[e.jsx(M,{children:e.jsx(O,{})}),e.jsx(L,{children:be.map(s=>e.jsx(_,{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{children:"State"}),e.jsxs(F,{value:p,onValueChange:s=>{ge(s),K(""),H(""),d([]),j(new Set),v(null)},children:[e.jsx(M,{children:e.jsx(O,{placeholder:"Select state"})}),e.jsx(L,{children:q?.map(s=>e.jsx(_,{value:s.id,children:s.name},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{children:"City"}),e.jsxs(F,{value:g,onValueChange:s=>{K(s),H(""),d([]),j(new Set),v(null)},disabled:!p,children:[e.jsx(M,{children:e.jsx(O,{placeholder:p?"Select city":"Select state first"})}),e.jsx(L,{children:z?.map(s=>e.jsx(_,{value:s.id,children:s.name},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{children:"Area (Optional)"}),e.jsxs(F,{value:A||"all",onValueChange:s=>H(s==="all"?"":s),disabled:!g,children:[e.jsx(M,{children:e.jsx(O,{placeholder:"All areas"})}),e.jsxs(L,{children:[e.jsx(_,{value:"all",children:"All Areas"}),P?.map(s=>e.jsx(_,{value:s.id,children:s.name},s.id))]})]})]}),e.jsxs("div",{className:"flex items-end gap-2 flex-wrap",children:[e.jsxs(C,{onClick:()=>te(!1),disabled:S,size:"sm",children:[S?e.jsx(D,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(le,{className:"h-4 w-4 mr-2"}),"Search"]}),e.jsxs(C,{variant:"outline",onClick:we,disabled:S,size:"sm",children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"Fetch All Pages"]}),e.jsxs(C,{variant:"default",onClick:ve,disabled:S,size:"sm",className:"bg-gradient-to-r from-primary to-teal text-white",children:[e.jsx($e,{className:"h-4 w-4 mr-2"}),"Super Search (All Categories)"]})]})]})})]}),f.length>0&&e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsx(N,{className:"card-modern",children:e.jsxs(y,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(ie,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:f.length}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Found"})]})]})}),e.jsx(N,{className:"card-modern",children:e.jsxs(y,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-teal-light flex items-center justify-center",children:e.jsx(Ge,{className:"h-6 w-6 text-teal"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:V}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"New Listings"})]})]})}),e.jsx(N,{className:"card-modern",children:e.jsxs(y,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-gold-light flex items-center justify-center",children:e.jsx(ue,{className:"h-6 w-6 text-gold"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:Ie}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Already Imported"})]})]})}),e.jsx(N,{className:"card-modern",children:e.jsxs(y,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-blue-light flex items-center justify-center",children:e.jsx(pe,{className:"h-6 w-6 text-blue-custom"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:b.size}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selected"})]})]})})]}),f.length>0&&e.jsxs(N,{className:"card-modern",children:[e.jsxs(oe,{className:"flex flex-row items-center justify-between",children:[e.jsx(de,{className:"text-lg",children:"Search Results"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(C,{variant:"outline",size:"sm",onClick:Ae,disabled:V===0,children:["Select All New (",V,")"]}),e.jsxs(C,{size:"sm",onClick:Ce,disabled:J||b.size===0,children:[J?e.jsx(D,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(pe,{className:"h-4 w-4 mr-2"}),"Import Selected (",b.size,")"]})]})]}),e.jsx(y,{className:"p-0",children:e.jsxs(Oe,{children:[e.jsx(Le,{children:e.jsxs(me,{children:[e.jsx(E,{className:"w-12"}),e.jsx(E,{children:"Business"}),e.jsx(E,{children:"Address"}),e.jsx(E,{children:"Rating"}),e.jsx(E,{children:"Status"})]})}),e.jsx(qe,{children:f.map(s=>e.jsxs(me,{className:s.already_imported?"opacity-50":"",children:[e.jsx(R,{children:e.jsx(De,{checked:b.has(s.place_id),onCheckedChange:()=>Pe(s.place_id),disabled:s.already_imported})}),e.jsx(R,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(ie,{className:"h-5 w-5 text-primary"})}),e.jsx("div",{children:e.jsx("p",{className:"font-medium",children:s.name})})]})}),e.jsx(R,{children:e.jsxs("div",{className:"flex items-center gap-1 text-sm text-muted-foreground",children:[e.jsx(Be,{className:"h-3 w-3"}),e.jsx("span",{className:"truncate max-w-64",children:s.address})]})}),e.jsx(R,{children:s.rating&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Fe,{className:"h-4 w-4 fill-gold text-gold"}),e.jsx("span",{className:"font-medium",children:s.rating.toFixed(1)}),e.jsxs("span",{className:"text-muted-foreground text-sm",children:["(",s.reviews_count||0,")"]})]})}),e.jsx(R,{children:s.already_imported?e.jsx(ce,{variant:"secondary",children:"Already Imported"}):e.jsx(ce,{className:"bg-teal/20 text-teal",children:"New"})})]},s.place_id))})]})}),W&&e.jsx("div",{className:"p-4 border-t flex justify-center",children:e.jsxs(C,{variant:"outline",onClick:()=>te(!0),disabled:S,children:[S?e.jsx(D,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(ne,{className:"h-4 w-4 mr-2"}),"Load More Results"]})})]}),f.length===0&&!S&&e.jsx(N,{className:"card-modern",children:e.jsxs(y,{className:"p-12 text-center",children:[e.jsx(Me,{className:"h-16 w-16 mx-auto mb-4 text-muted-foreground opacity-50"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No Results Yet"}),e.jsx("p",{className:"text-muted-foreground",children:"Select a category and location, then click Search to find businesses"})]})})]})}export{is as default};
