import{b as pe,u as J,c as j,j as e}from"./chunk-CPh6voF3.js";import{r as y}from"./chunk-CffrGP6S.js";import{C as u,d as x,a as P,b as B}from"./chunk-Dwq_v72W.js";import{B as h,a9 as Q,bc as H,Z as k,aa as L,ab as I,ac as K,i as v,a as c,I as G,a2 as ge,a3 as je,a5 as fe,a6 as _e,a7 as r,al as U,bA as $,C as Ne,t as z,Q as A,m as V,T as ye,p as ve,A as Z,U as we,s as p,bI as g}from"./index-DflORfjh.js";import{S as X}from"./chunk-DfjE-bP6.js";import{T as W,a as Y,b as f,c as n,d as ee,e as i}from"./chunk-NLs5Ye4A.js";import{T as be,a as Se,b as D,c as E}from"./chunk-k8HiDHrE.js";import{R as Ce}from"./chunk-BOvFDp2b.js";import{T as Re}from"./chunk-C4_bt_FT.js";import{P as Te}from"./chunk-HAC-i_a2.js";import{B as se}from"./chunk-Bl7VVhKV.js";import{C as ke}from"./chunk-CbEmr7WL.js";import{S as Ae}from"./chunk-B51FxpoB.js";import{T as De}from"./chunk-BRVan1jG.js";import{A as Ee,S as Oe,B as qe}from"./chunk-C2VW2Ml6.js";import{F as Me}from"./chunk-BP9BFbSw.js";import{D as Fe}from"./chunk-CedtSHBb.js";import{M as Je}from"./chunk-B7d2qnKb.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-Drd-rt-S.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";const Pe=[{name:"GMB Import Job",description:"Import new clinic listings from Google Business Profile",rule_type:"gmb_import",trigger_config:{schedule:"daily",time:"02:00"},action_config:{max_per_run:100,cities:["los-angeles","san-francisco","boston"]}},{name:"Unclaimed Outreach",description:"Send outreach emails to unclaimed GMB listings",rule_type:"unclaimed_outreach",trigger_config:{schedule:"daily",time:"10:00",days_since_import:3},action_config:{max_sends_per_day:50,template:"claim_invitation"}},{name:"Duplicate Detection",description:"Scan for potential duplicate clinic listings",rule_type:"duplicate_detection",trigger_config:{schedule:"weekly",day:"monday",time:"03:00"},action_config:{similarity_threshold:.8}},{name:"SEO Audit Job",description:"Run SEO audits on location and service pages",rule_type:"seo_audit",trigger_config:{schedule:"weekly",day:"sunday",time:"04:00"},action_config:{check_meta:!0,check_content:!0,check_links:!0}},{name:"Review Funnel Report",description:"Generate weekly report on review funnel performance",rule_type:"review_report",trigger_config:{schedule:"weekly",day:"monday",time:"08:00"},action_config:{send_email:!0,recipients:["admin@appointpanda.ae"]}},{name:"Verification Expiry Reminder",description:"Remind clinics about expiring verifications",rule_type:"verification_reminder",trigger_config:{schedule:"daily",time:"09:00",days_before_expiry:30},action_config:{template:"verification_reminder",max_sends:20}},{name:"Lead Follow-up",description:"Follow up on leads that have not been contacted",rule_type:"lead_followup",trigger_config:{hours_since_created:24},action_config:{max_per_run:50}}];function os(){const m=pe(),[ae,te]=y.useState("rules"),[ie,_]=y.useState(!1),[re,b]=y.useState(!1),[w,S]=y.useState(null),[t,d]=y.useState({name:"",description:"",rule_type:"lead_followup",trigger_config:"{}",action_config:"{}",is_enabled:!0}),{data:o,isLoading:ne}=J({queryKey:["automation-rules"],queryFn:async()=>{const{data:s,error:a}=await p.from("automation_rules").select("*").order("created_at",{ascending:!1});if(a)throw a;return s}}),{data:N,isLoading:Be}=J({queryKey:["automation-logs"],queryFn:async()=>{const{data:s,error:a}=await p.from("automation_logs").select("*").order("executed_at",{ascending:!1}).limit(50);if(a)throw a;return s}}),O=j({mutationFn:async s=>{const{error:a}=await p.from("automation_rules").insert([{name:s.name,description:s.description||null,rule_type:s.rule_type,trigger_type:s.rule_type||"manual",action_type:"notification",trigger_config:JSON.parse(s.trigger_config),action_config:JSON.parse(s.action_config),is_enabled:s.is_enabled}]);if(a)throw a},onSuccess:()=>{m.invalidateQueries({queryKey:["automation-rules"]}),_(!1),R(),g({title:"Rule created successfully"})},onError:s=>{g({title:"Error creating rule",description:s.message,variant:"destructive"})}}),q=j({mutationFn:async({id:s,data:a})=>{const{error:l}=await p.from("automation_rules").update(a).eq("id",s);if(l)throw l},onSuccess:()=>{m.invalidateQueries({queryKey:["automation-rules"]}),_(!1),S(null),R(),g({title:"Rule updated successfully"})}}),le=j({mutationFn:async({id:s,enabled:a})=>{const{error:l}=await p.from("automation_rules").update({is_enabled:a}).eq("id",s);if(l)throw l},onSuccess:()=>{m.invalidateQueries({queryKey:["automation-rules"]})}}),ce=j({mutationFn:async s=>{const{error:a}=await p.from("automation_rules").delete().eq("id",s);if(a)throw a},onSuccess:()=>{m.invalidateQueries({queryKey:["automation-rules"]}),g({title:"Rule deleted successfully"})}}),M=j({mutationFn:async s=>{const{data:a,error:l}=await p.functions.invoke("run-automation",{body:{ruleId:s,action:"execute-rule"}});if(l)throw l;return a},onSuccess:s=>{m.invalidateQueries({queryKey:["automation-rules"]}),m.invalidateQueries({queryKey:["automation-logs"]}),g({title:"Rule executed",description:s.success?"Completed successfully":s.error})},onError:s=>g({title:"Execution failed",description:s.message,variant:"destructive"})}),C=j({mutationFn:async()=>{const{data:s,error:a}=await p.functions.invoke("run-automation",{body:{action:"run-all"}});if(a)throw a;return s},onSuccess:s=>{m.invalidateQueries({queryKey:["automation-rules"]}),m.invalidateQueries({queryKey:["automation-logs"]}),g({title:"All rules executed",description:`${s.executed} rules processed`})}}),R=()=>{d({name:"",description:"",rule_type:"lead_followup",trigger_config:"{}",action_config:"{}",is_enabled:!0})},de=s=>{S(s),d({name:s.name,description:s.description||"",rule_type:s.rule_type,trigger_config:JSON.stringify(s.trigger_config,null,2),action_config:JSON.stringify(s.action_config,null,2),is_enabled:s.is_enabled}),_(!0)},oe=s=>{d({name:s.name,description:s.description,rule_type:s.rule_type,trigger_config:JSON.stringify(s.trigger_config,null,2),action_config:JSON.stringify(s.action_config,null,2),is_enabled:!1}),b(!1),_(!0)},me=()=>{w?q.mutate({id:w.id,data:{name:t.name,description:t.description||null,rule_type:t.rule_type,trigger_config:JSON.parse(t.trigger_config),action_config:JSON.parse(t.action_config),is_enabled:t.is_enabled}}):O.mutate(t)},T=s=>{switch(s){case"lead_followup":return e.jsx(we,{className:"h-4 w-4"});case"appointment_reminder":return e.jsx(V,{className:"h-4 w-4"});case"review_request":return e.jsx(Je,{className:"h-4 w-4"});case"email_notification":return e.jsx(Z,{className:"h-4 w-4"});case"gmb_import":return e.jsx(Fe,{className:"h-4 w-4"});case"unclaimed_outreach":return e.jsx(Z,{className:"h-4 w-4"});case"duplicate_detection":return e.jsx(ve,{className:"h-4 w-4"});case"seo_audit":return e.jsx(Me,{className:"h-4 w-4"});case"review_report":return e.jsx(ye,{className:"h-4 w-4"});case"verification_reminder":return e.jsx(qe,{className:"h-4 w-4"});default:return e.jsx(k,{className:"h-4 w-4"})}},F=s=>s.schedule==="hourly"?"Every hour":s.schedule==="daily"?`Daily at ${s.time||"00:00"}`:s.schedule==="weekly"?`${s.day||"Monday"} at ${s.time||"00:00"}`:s.hours_since_created?`${s.hours_since_created}h after event`:"Manual",ue=N?.filter(s=>s.status==="success").length||0,xe=N?.filter(s=>s.status==="failed").length||0,he=o?.filter(s=>s.is_enabled).length||0;return ne?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-display font-bold text-foreground",children:"AI Automation Center"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Automate workflows and AI-assisted tasks"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{variant:"outline",onClick:()=>C.mutate(),disabled:C.isPending,children:[e.jsx(Ce,{className:`h-4 w-4 mr-2 ${C.isPending?"animate-spin":""}`}),"Run All Enabled"]}),e.jsxs(Q,{open:re,onOpenChange:b,children:[e.jsx(H,{asChild:!0,children:e.jsxs(h,{variant:"outline",children:[e.jsx(k,{className:"h-4 w-4 mr-2"}),"Quick Setup"]})}),e.jsxs(L,{className:"max-w-2xl",children:[e.jsx(I,{children:e.jsx(K,{children:"Job Presets"})}),e.jsx("div",{className:"grid gap-3 py-4",children:Pe.map((s,a)=>e.jsx("button",{onClick:()=>oe(s),className:"p-4 rounded-xl border border-border hover:border-primary hover:bg-primary/5 transition-all text-left",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-lg bg-primary/10 flex items-center justify-center",children:T(s.rule_type)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:s.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.description})]}),e.jsxs(v,{variant:"outline",className:"capitalize",children:[e.jsx(Re,{className:"h-3 w-3 mr-1"}),s.trigger_config.schedule||"event"]})]})},a))})]})]}),e.jsxs(Q,{open:ie,onOpenChange:s=>{_(s),s||(S(null),R())},children:[e.jsx(H,{asChild:!0,children:e.jsxs(h,{className:"gap-2",children:[e.jsx(Te,{className:"h-4 w-4"}),"New Automation"]})}),e.jsxs(L,{className:"max-w-2xl",children:[e.jsx(I,{children:e.jsx(K,{children:w?"Edit Automation":"Create Automation"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Name"}),e.jsx(G,{value:t.name,onChange:s=>d({...t,name:s.target.value}),placeholder:"Automation name"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Description"}),e.jsx(G,{value:t.description,onChange:s=>d({...t,description:s.target.value}),placeholder:"Brief description"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Rule Type"}),e.jsxs(ge,{value:t.rule_type,onValueChange:s=>d({...t,rule_type:s}),children:[e.jsx(je,{children:e.jsx(fe,{})}),e.jsxs(_e,{children:[e.jsx(r,{value:"lead_followup",children:"Lead Follow-up"}),e.jsx(r,{value:"appointment_reminder",children:"Appointment Reminder"}),e.jsx(r,{value:"review_request",children:"Review Request"}),e.jsx(r,{value:"email_notification",children:"Email Notification"}),e.jsx(r,{value:"data_cleanup",children:"Data Cleanup"}),e.jsx(r,{value:"report_generation",children:"Report Generation"}),e.jsx(r,{value:"gmb_import",children:"GMB Import"}),e.jsx(r,{value:"unclaimed_outreach",children:"Unclaimed Outreach"}),e.jsx(r,{value:"duplicate_detection",children:"Duplicate Detection"}),e.jsx(r,{value:"seo_audit",children:"SEO Audit"}),e.jsx(r,{value:"review_report",children:"Review Report"}),e.jsx(r,{value:"verification_reminder",children:"Verification Reminder"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Trigger Configuration (JSON)"}),e.jsx(U,{value:t.trigger_config,onChange:s=>d({...t,trigger_config:s.target.value}),placeholder:'{"schedule": "daily", "time": "10:00"}',rows:4,className:"font-mono text-sm"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Schedule options: hourly, daily (with time), weekly (with day + time)"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{children:"Action Configuration (JSON)"}),e.jsx(U,{value:t.action_config,onChange:s=>d({...t,action_config:s.target.value}),placeholder:'{"max_per_run": 50, "template": "welcome"}',rows:4,className:"font-mono text-sm"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(c,{children:"Enabled"}),e.jsx(X,{checked:t.is_enabled,onCheckedChange:s=>d({...t,is_enabled:s})})]}),e.jsxs(h,{onClick:me,className:"w-full",disabled:O.isPending||q.isPending,children:[w?"Update":"Create"," Automation"]})]})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsx(u,{className:"card-modern",children:e.jsxs(x,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(se,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:o?.length||0}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Rules"})]})]})}),e.jsx(u,{className:"card-modern",children:e.jsxs(x,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-teal-light flex items-center justify-center",children:e.jsx($,{className:"h-6 w-6 text-teal"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:he}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Active"})]})]})}),e.jsx(u,{className:"card-modern",children:e.jsxs(x,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-blue-light flex items-center justify-center",children:e.jsx(Ne,{className:"h-6 w-6 text-blue-custom"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:ue}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Successful Runs"})]})]})}),e.jsx(u,{className:"card-modern",children:e.jsxs(x,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-coral-light flex items-center justify-center",children:e.jsx(ke,{className:"h-6 w-6 text-coral"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:xe}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Failed"})]})]})})]}),e.jsxs(be,{value:ae,onValueChange:te,children:[e.jsxs(Se,{className:"grid w-full grid-cols-3 rounded-xl",children:[e.jsx(D,{value:"rules",className:"rounded-xl",children:"Automation Rules"}),e.jsx(D,{value:"logs",className:"rounded-xl",children:"Execution Logs"}),e.jsx(D,{value:"schedules",className:"rounded-xl",children:"Schedules"})]}),e.jsx(E,{value:"rules",className:"mt-4",children:e.jsx(u,{className:"card-modern",children:e.jsx(x,{className:"p-0",children:e.jsxs(W,{children:[e.jsx(Y,{children:e.jsxs(f,{children:[e.jsx(n,{children:"Rule"}),e.jsx(n,{children:"Type"}),e.jsx(n,{children:"Schedule"}),e.jsx(n,{children:"Status"}),e.jsx(n,{children:"Runs"}),e.jsx(n,{children:"Last Run"}),e.jsx(n,{className:"text-right",children:"Actions"})]})}),e.jsxs(ee,{children:[o?.map(s=>e.jsxs(f,{children:[e.jsxs(i,{children:[e.jsx("div",{className:"font-medium",children:s.name}),s.description&&e.jsx("p",{className:"text-xs text-muted-foreground",children:s.description})]}),e.jsx(i,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[T(s.rule_type),e.jsx("span",{className:"text-sm capitalize",children:s.rule_type.replace(/_/g," ")})]})}),e.jsx(i,{children:e.jsxs(v,{variant:"outline",className:"text-xs",children:[e.jsx(z,{className:"h-3 w-3 mr-1"}),F(s.trigger_config)]})}),e.jsx(i,{children:e.jsx(X,{checked:s.is_enabled,onCheckedChange:a=>le.mutate({id:s.id,enabled:a})})}),e.jsx(i,{children:e.jsx(v,{variant:"outline",children:s.run_count})}),e.jsx(i,{className:"text-muted-foreground",children:s.last_run_at?A(new Date(s.last_run_at),"MMM d, HH:mm"):"Never"}),e.jsxs(i,{className:"text-right",children:[e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>M.mutate(s.id),disabled:M.isPending,children:e.jsx($,{className:"h-4 w-4"})}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>de(s),children:e.jsx(Ae,{className:"h-4 w-4"})}),e.jsx(h,{variant:"ghost",size:"sm",className:"text-destructive",onClick:()=>ce.mutate(s.id),children:e.jsx(De,{className:"h-4 w-4"})})]})]},s.id)),(!o||o.length===0)&&e.jsx(f,{children:e.jsxs(i,{colSpan:7,className:"text-center py-8 text-muted-foreground",children:[e.jsx(se,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No automation rules configured"}),e.jsxs(h,{variant:"outline",className:"mt-3",onClick:()=>b(!0),children:[e.jsx(k,{className:"h-4 w-4 mr-2"}),"Start with a Preset"]})]})})]})]})})})}),e.jsx(E,{value:"logs",className:"mt-4",children:e.jsx(u,{className:"card-modern",children:e.jsx(x,{className:"p-0",children:e.jsxs(W,{children:[e.jsx(Y,{children:e.jsxs(f,{children:[e.jsx(n,{children:"Time"}),e.jsx(n,{children:"Rule"}),e.jsx(n,{children:"Status"}),e.jsx(n,{children:"Details"}),e.jsx(n,{children:"Error"})]})}),e.jsxs(ee,{children:[N?.map(s=>{const a=o?.find(l=>l.id===s.rule_id);return e.jsxs(f,{children:[e.jsx(i,{className:"text-muted-foreground",children:A(new Date(s.executed_at||""),"MMM d, HH:mm:ss")}),e.jsx(i,{className:"font-medium",children:a?.name||"Unknown"}),e.jsx(i,{children:s.status==="success"?e.jsx(v,{className:"bg-teal/20 text-teal",children:"Success"}):e.jsx(v,{variant:"destructive",children:"Failed"})}),e.jsx(i,{className:"text-muted-foreground text-sm max-w-[200px] truncate",children:s.details?JSON.stringify(s.details):"-"}),e.jsx(i,{className:"text-coral text-sm",children:s.error_message||"-"})]},s.id)}),(!N||N.length===0)&&e.jsx(f,{children:e.jsxs(i,{colSpan:5,className:"text-center py-8 text-muted-foreground",children:[e.jsx(Ee,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No execution logs yet"})]})})]})]})})})}),e.jsx(E,{value:"schedules",className:"mt-4",children:e.jsxs("div",{className:"grid gap-4",children:[e.jsxs(u,{className:"card-modern",children:[e.jsx(P,{children:e.jsxs(B,{className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-5 w-5"}),"Scheduled Jobs Overview"]})}),e.jsx(x,{children:e.jsxs("div",{className:"space-y-4",children:[o?.filter(s=>s.is_enabled&&s.trigger_config.schedule).map(s=>e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl bg-muted/50",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-lg bg-primary/10 flex items-center justify-center",children:T(s.rule_type)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:F(s.trigger_config)})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-sm font-medium",children:[s.run_count," runs"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Last: ",s.last_run_at?A(new Date(s.last_run_at),"MMM d, HH:mm"):"Never"]})]})]},s.id)),(!o||o.filter(s=>s.is_enabled&&s.trigger_config.schedule).length===0)&&e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(z,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No scheduled jobs active"})]})]})})]}),e.jsxs(u,{className:"card-modern",children:[e.jsx(P,{children:e.jsxs(B,{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"h-5 w-5"}),"Global Thresholds"]})}),e.jsx(x,{children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-4 rounded-xl bg-muted/50",children:[e.jsx(c,{className:"text-sm text-muted-foreground",children:"Max Emails/Day"}),e.jsx("p",{className:"text-2xl font-bold",children:"100"})]}),e.jsxs("div",{className:"p-4 rounded-xl bg-muted/50",children:[e.jsx(c,{className:"text-sm text-muted-foreground",children:"Max Actions/Hour"}),e.jsx("p",{className:"text-2xl font-bold",children:"50"})]}),e.jsxs("div",{className:"p-4 rounded-xl bg-muted/50",children:[e.jsx(c,{className:"text-sm text-muted-foreground",children:"Retry on Failure"}),e.jsx("p",{className:"text-2xl font-bold",children:"3x"})]}),e.jsxs("div",{className:"p-4 rounded-xl bg-muted/50",children:[e.jsx(c,{className:"text-sm text-muted-foreground",children:"Cool-down Period"}),e.jsx("p",{className:"text-2xl font-bold",children:"5 min"})]})]})})]})]})})]})]})}export{os as default};
