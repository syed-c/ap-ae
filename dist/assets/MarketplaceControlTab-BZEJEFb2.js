import{b as U,u as E,c as v,j as e}from"./chunk-CPh6voF3.js";import{r as p}from"./chunk-CffrGP6S.js";import{B as c,m as w,o as z,G as $,n as J,T as X,a as Y,i as l,p as Z,I as ee,aK as se,E as ae,a9 as ie,aa as ne,ab as te,ac as re,ad as le,ae as ce,s as m,b as x}from"./index-DflORfjh.js";import{C as o,d,a as y,b as k,c as _}from"./chunk-Dwq_v72W.js";import{S as oe}from"./chunk-FxOzQZIr.js";import{S as de}from"./chunk-CzOt8Wyl.js";import{S as R}from"./chunk-CQtADEjB.js";import{T as me,a as xe,b as C,c as S}from"./chunk-k8HiDHrE.js";import{T as he,a as ge,b as q,c as u,d as ue,e as j}from"./chunk-NLs5Ye4A.js";import{c as T}from"./chunk-BSjc5zjM.js";import{R as je}from"./chunk-BOvFDp2b.js";import{C as A}from"./chunk-DI0yTdYZ.js";import{S as fe}from"./chunk-DpLtiXM0.js";import{S as pe}from"./chunk-Beq7cUgv.js";import{T as be}from"./chunk-DbdCK11k.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-Drd-rt-S.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";const Ne=[{key:"insurance_match",label:"Insurance Match",description:"Boost for matching user insurance",weight:30,maxWeight:50},{key:"availability",label:"Availability Score",description:"Earlier available slots rank higher",weight:20,maxWeight:40},{key:"distance",label:"Distance",description:"Closer clinics rank higher",weight:15,maxWeight:30},{key:"reviews",label:"Review Score",description:"Higher ratings boost ranking",weight:20,maxWeight:40},{key:"trust",label:"Trust Score",description:"Verified profiles, responsiveness",weight:10,maxWeight:20},{key:"admin_boost",label:"Admin Boost",description:"Manual ranking adjustment",weight:5,maxWeight:50}];function Ve(){const B=U(),[t,G]=p.useState(null),[P,f]=p.useState(!1),[M,O]=p.useState(""),[h,L]=p.useState(Ne),V=async()=>{const s=[];let a=0;const r=1e3;let i=!0;for(;i;){const{data:n,error:W}=await m.from("clinics").select(`
          id, name, slug, gmb_connected, verification_status, claimed_by,
          dentist_settings (booking_enabled)
        `).eq("is_active",!0).order("name").range(a,a+r-1);if(W)throw W;n&&n.length>0?(s.push(...n),a+=r,i=n.length===r):i=!1}return s.map(n=>({id:n.id,name:n.name,slug:n.slug,booking_enabled:n.dentist_settings?.booking_enabled??!0,gmb_connected:n.gmb_connected,verification_status:n.verification_status,claimed_by:n.claimed_by}))},{data:g,isLoading:H}=E({queryKey:["marketplace-clinics-unlimited"],queryFn:V});E({queryKey:["ranking-weights"],queryFn:async()=>{const{data:s,error:a}=await m.from("global_settings").select("value").eq("key","ranking_weights").single();if(a&&a.code!=="PGRST116")throw a;return s?.value}});const D=v({mutationFn:async s=>{const a=Object.fromEntries(s.map(i=>[i.key,i.weight])),{error:r}=await m.from("global_settings").upsert({key:"ranking_weights",value:a,updated_at:new Date().toISOString()});if(r)throw r;await T({action:"update_ranking_weights",entityType:"global_settings",entityId:"ranking_weights",newValues:a})},onSuccess:()=>{B.invalidateQueries({queryKey:["ranking-weights"]}),x.success("Ranking weights updated")},onError:s=>{x.error(s.message||"Failed to update weights")}}),F=v({mutationFn:async({clinicId:s,enabled:a})=>{const{data:r}=await m.from("dentist_settings").select("id").eq("clinic_id",s).single();if(r){const{error:i}=await m.from("dentist_settings").update({booking_enabled:a}).eq("clinic_id",s);if(i)throw i}else{const{error:i}=await m.from("dentist_settings").insert({clinic_id:s,booking_enabled:a});if(i)throw i}await T({action:a?"admin_force_booking_on":"admin_force_booking_off",entityType:"clinic",entityId:s,newValues:{booking_enabled:a}})},onSuccess:()=>{B.invalidateQueries({queryKey:["marketplace-clinics"]}),f(!1),x.success("Booking status updated")},onError:s=>{x.error(s.message||"Failed to update")}}),b=v({mutationFn:async()=>{x.info("GMB sync queued for all connected clinics"),await T({action:"trigger_gmb_sync_all",entityType:"system"})},onSuccess:()=>{x.success("GMB sync initiated")}}),N=g?.filter(s=>s.name.toLowerCase().includes(M.toLowerCase()))||[],I=g?.filter(s=>s.verification_status==="verified").length||0,K=g?.filter(s=>s.gmb_connected).length||0,Q=g?.filter(s=>s.booking_enabled).length||0;return H?e.jsxs("div",{className:"space-y-6",children:[e.jsx(R,{className:"h-12 w-64"}),e.jsx("div",{className:"grid gap-4 md:grid-cols-4",children:[1,2,3,4].map(s=>e.jsx(R,{className:"h-24"},s))})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-display font-bold text-foreground",children:"Marketplace Control"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage ranking, booking enforcement, and platform-wide controls"})]}),e.jsxs(c,{variant:"outline",onClick:()=>b.mutate(),disabled:b.isPending,children:[e.jsx(je,{className:`h-4 w-4 mr-2 ${b.isPending?"animate-spin":""}`}),"Sync All GMB"]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsx(o,{className:"card-modern",children:e.jsx(d,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(w,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:Q}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Booking Enabled"})]})]})})}),e.jsx(o,{className:"card-modern",children:e.jsx(d,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-teal/10 flex items-center justify-center",children:e.jsx(z,{className:"h-5 w-5 text-teal"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:I}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Verified Clinics"})]})]})})}),e.jsx(o,{className:"card-modern",children:e.jsx(d,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-gold/10 flex items-center justify-center",children:e.jsx($,{className:"h-5 w-5 text-gold"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:K}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"GMB Connected"})]})]})})}),e.jsx(o,{className:"card-modern",children:e.jsx(d,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-coral/10 flex items-center justify-center",children:e.jsx(J,{className:"h-5 w-5 text-coral"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:g?.length||0}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total Clinics"})]})]})})})]}),e.jsxs(me,{defaultValue:"ranking",className:"space-y-4",children:[e.jsxs(xe,{children:[e.jsxs(C,{value:"ranking",className:"gap-2",children:[e.jsx(X,{className:"h-4 w-4"}),"Ranking Weights"]}),e.jsxs(C,{value:"booking",className:"gap-2",children:[e.jsx(w,{className:"h-4 w-4"}),"Booking Control"]}),e.jsxs(C,{value:"overrides",className:"gap-2",children:[e.jsx(A,{className:"h-4 w-4"}),"Manual Overrides"]})]}),e.jsx(S,{value:"ranking",children:e.jsxs(o,{className:"card-modern",children:[e.jsxs(y,{children:[e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"h-5 w-5 text-primary"}),"Ranking Algorithm Weights"]}),e.jsx(_,{children:"Adjust how different factors influence search result ordering"})]}),e.jsxs(d,{className:"space-y-6",children:[h.map((s,a)=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(Y,{className:"font-medium",children:s.label}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.description})]}),e.jsxs(l,{variant:"outline",children:[s.weight,"%"]})]}),e.jsx(oe,{value:[s.weight],onValueChange:([r])=>{const i=[...h];i[a]={...s,weight:r},L(i)},max:s.maxWeight,step:1,className:"w-full"})]},s.key)),e.jsx(de,{}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Total Weight"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Should ideally sum to 100%"})]}),e.jsxs(l,{variant:h.reduce((s,a)=>s+a.weight,0)===100?"default":"destructive",children:[h.reduce((s,a)=>s+a.weight,0),"%"]})]}),e.jsx(c,{onClick:()=>D.mutate(h),disabled:D.isPending,className:"w-full",children:"Save Ranking Weights"})]})]})}),e.jsx(S,{value:"booking",children:e.jsxs(o,{className:"card-modern",children:[e.jsxs(y,{children:[e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(w,{className:"h-5 w-5 text-primary"}),"Booking Enforcement"]}),e.jsx(_,{children:"Force booking on/off for specific clinics"})]}),e.jsxs(d,{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Z,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ee,{placeholder:"Search clinics...",value:M,onChange:s=>O(s.target.value),className:"pl-9"})]})}),e.jsx("div",{className:"border rounded-xl overflow-hidden",children:e.jsxs(he,{children:[e.jsx(ge,{children:e.jsxs(q,{children:[e.jsx(u,{children:"Clinic"}),e.jsx(u,{children:"Verified"}),e.jsx(u,{children:"GMB"}),e.jsx(u,{children:"Booking"}),e.jsx(u,{children:"Actions"})]})}),e.jsx(ue,{children:N.slice(0,50).map(s=>e.jsxs(q,{children:[e.jsx(j,{className:"font-medium",children:s.name}),e.jsx(j,{children:s.verification_status==="verified"?e.jsxs(l,{className:"bg-teal/20 text-teal border-0",children:[e.jsx(se,{className:"h-3 w-3 mr-1"}),"Verified"]}):e.jsx(l,{variant:"outline",children:"Pending"})}),e.jsx(j,{children:s.gmb_connected?e.jsx(l,{className:"bg-primary/20 text-primary border-0",children:"Connected"}):e.jsx(l,{variant:"secondary",children:"Not Connected"})}),e.jsx(j,{children:s.booking_enabled?e.jsx(l,{className:"bg-emerald-100 text-emerald-700 border-0",children:"Enabled"}):e.jsx(l,{variant:"destructive",children:"Disabled"})}),e.jsx(j,{children:e.jsx(c,{variant:"ghost",size:"sm",onClick:()=>{G(s),f(!0)},children:e.jsx(pe,{className:"h-4 w-4"})})})]},s.id))})]})}),N.length>50&&e.jsxs("p",{className:"text-sm text-muted-foreground text-center",children:["Showing 50 of ",N.length," clinics. Use search to find specific clinics."]})]})]})}),e.jsx(S,{value:"overrides",children:e.jsxs(o,{className:"card-modern",children:[e.jsxs(y,{children:[e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(A,{className:"h-5 w-5 text-gold"}),"Manual Ranking Overrides"]}),e.jsx(_,{children:"Pin clinics to top positions or apply permanent boosts"})]}),e.jsx(d,{children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ae,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),e.jsx("p",{className:"text-muted-foreground mb-2",children:"Use the Pinned Profiles and Top Dentists tabs for manual ranking control"}),e.jsxs("div",{className:"flex gap-2 justify-center",children:[e.jsx(c,{variant:"outline",onClick:()=>window.location.href="/admin?tab=pinned-profiles",children:"Pinned Profiles"}),e.jsx(c,{variant:"outline",onClick:()=>window.location.href="/admin?tab=top-dentists",children:"Top Dentists"})]})]})})]})})]}),e.jsx(ie,{open:P,onOpenChange:f,children:e.jsxs(ne,{children:[e.jsxs(te,{children:[e.jsx(re,{children:"Clinic Override"}),e.jsxs(le,{children:["Force booking settings for ",t?.name]})]}),t&&e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl border",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Current Status"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Booking is ",t.booking_enabled?"enabled":"disabled"]})]}),e.jsx(l,{variant:t.booking_enabled?"default":"destructive",children:t.booking_enabled?"ON":"OFF"})]}),e.jsx("div",{className:"p-3 rounded-lg bg-amber/10 border border-amber/20",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(be,{className:"h-4 w-4 text-amber shrink-0 mt-0.5"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"This will override the dentist's own booking preference. Use only when necessary for platform compliance."})]})})]}),e.jsxs(ce,{className:"flex-col sm:flex-row gap-2",children:[e.jsx(c,{variant:"outline",onClick:()=>f(!1),children:"Cancel"}),e.jsxs(c,{variant:t?.booking_enabled?"destructive":"default",onClick:()=>{t&&F.mutate({clinicId:t.id,enabled:!t.booking_enabled})},disabled:F.isPending,children:[t?.booking_enabled?"Force Disable":"Force Enable"," Booking"]})]})]})})]})}export{Ve as default};
