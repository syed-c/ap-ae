import{b as ie,j as e}from"./chunk-CPh6voF3.js";import{r as b}from"./chunk-CffrGP6S.js";import{u as re,am as ce,an as ne,a9 as le,aa as de,ab as me,ac as oe,w as E,C as P,a as x,I as y,a8 as xe,x as he,a2 as L,a3 as R,a5 as V,a6 as W,a7 as O,A as ue,P as H,G as pe,al as fe,v as J,b7 as U,y as je,B as k,b3 as ge,Y as Ne,L as ye,b as F,s as g}from"./index-DflORfjh.js";import{u as ve}from"./chunk-fofMllkR.js";import{P as be}from"./chunk-DSDQubI6.js";import{a as we}from"./chunk-Drd-rt-S.js";import{F as Se}from"./chunk-BaL04tya.js";import{b as Ie,s as u,l as Ce,Z as _e}from"./chunk-yff5u8mE.js";const Te=w=>{const p=w.replace(/\D/g,"");if(p.startsWith("971")){const d=p.slice(3).match(/^(\d{0,2})(\d{0,3})(\d{0,4})$/);if(d)return"+971 "+[d[1],d[2],d[3]].filter(Boolean).join(" ")}if(p.startsWith("0")){const d=p.slice(1).match(/^(\d{0,2})(\d{0,3})(\d{0,4})$/);if(d)return"+971 "+[d[1],d[2],d[3]].filter(Boolean).join(" ")}return w},Ae=Ie({clinicName:u().trim().min(2,"Clinic name is required").max(100),dentistName:u().trim().min(2,"Your name is required").max(100),email:u().trim().email("Valid email is required").max(255),phone:u().trim().min(10,"Valid phone number is required").max(20),stateId:u().min(1,"Emirate is required"),cityId:u().min(1,"Area is required"),streetAddress:u().trim().max(500).optional(),website:u().trim().url().max(255).optional().or(Ce("")),description:u().trim().max(2e3).optional()}),G=[{id:1,title:"Practice Details",icon:E,description:"Name and location"},{id:2,title:"Contact Info",icon:H,description:"How patients reach you"},{id:3,title:"Services",icon:J,description:"What you offer"},{id:4,title:"Review & Submit",icon:Se,description:"Confirm details"}];function Ye({open:w,onOpenChange:p}){const{user:f,profile:d}=re();we();const C=ie(),{data:_=[]}=ce(),{data:Q=[]}=ne(),{data:q=[]}=ve(),[n,T]=b.useState(1),[$,D]=b.useState(!1),[i,S]=b.useState({}),[h,B]=b.useState([]),[t,N]=b.useState({clinicName:"",dentistName:d?.full_name||"",email:f?.email||"",phone:"",stateId:"",cityId:"",streetAddress:"",website:"",description:"",agreeTerms:!1}),A=Q.filter(s=>t.stateId?s.state?.id===t.stateId||s.states?.id===t.stateId:!1),j=s=>{const{name:a,value:r}=s.target;N(a==="phone"?c=>({...c,phone:Te(r)}):c=>({...c,[a]:r})),i[a]&&S(c=>({...c,[a]:""}))},Y=s=>{B(a=>a.includes(s)?a.filter(r=>r!==s):[...a,s])},Z=s=>{const r={1:["clinicName","dentistName","stateId","cityId"],2:["email","phone"],3:[],4:[]}[s]||[],c={};return r.forEach(l=>{const v=t[l];try{const o=Ae.shape[l];o&&o.parse(v)}catch(o){o instanceof _e&&(c[l]=o.errors[0]?.message||"Invalid")}}),S(c),Object.keys(c).length===0},z=()=>{Z(n)&&T(s=>Math.min(s+1,4))},K=()=>{T(s=>Math.max(s-1,1))},X=s=>s.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,80),M=async(s,a)=>{const r=X(a);if(!r)return`practice-${Date.now().toString(36)}`;const{data:c}=await g.from(s).select("slug").like("slug",`${r}%`).order("slug",{ascending:!1});if(!c||c.length===0)return r;let l=0;c.some(o=>o.slug===r)&&(l=1);for(const o of c){const I=o.slug.match(new RegExp(`^${r}-(\\d+)$`));if(I){const m=parseInt(I[1],10);m>=l&&(l=m+1)}}return l===0?r:`${r}-${l}`},ee=async()=>{if(!t.agreeTerms){F.error("Please agree to the terms and conditions");return}D(!0);try{const s=_.find(m=>m.id===t.stateId),a=A.find(m=>m.id===t.cityId),r=q.filter(m=>h.includes(m.id)).map(m=>m.name),c=await M("clinics",t.clinicName),{data:l,error:v}=await g.from("clinics").insert([{name:t.clinicName,slug:c,phone:t.phone,email:t.email,website:t.website||null,address:t.streetAddress||null,description:t.description||null,city_id:t.cityId,claimed_by:f?.id,claim_status:"claimed",verification_status:"pending",location_verified:!0,is_active:!0,source:"manual"}]).select().single();if(v)throw v;if(h.length>0&&l){const m=h.map(ae=>({clinic_id:l.id,treatment_id:ae}));await g.from("clinic_treatments").insert(m)}const o=await M("dentists",t.dentistName);await g.from("dentists").insert({name:t.dentistName,slug:o,email:t.email,phone:t.phone,clinic_id:l.id,is_primary:!0,is_active:!0});const{data:I}=await g.from("user_roles").select("id").eq("user_id",f?.id).eq("role","dentist").maybeSingle();I||await g.from("user_roles").insert({user_id:f?.id,role:"dentist"}),await g.from("leads").insert({patient_name:t.dentistName,patient_email:t.email,patient_phone:t.phone,clinic_id:l.id,message:JSON.stringify({type:"self_listing",clinicName:t.clinicName,state:s?.name||"",city:a?.name||"",services:r,description:t.description}),source:"dashboard-add-practice",status:"converted"}),F.success("Practice created successfully!"),C.invalidateQueries({queryKey:["dentist-profile"]}),p(!1),T(1),N({clinicName:"",dentistName:d?.full_name||"",email:f?.email||"",phone:"",stateId:"",cityId:"",streetAddress:"",website:"",description:"",agreeTerms:!1}),B([])}catch(s){console.error("Error creating practice:",s),F.error(s.message||"Failed to create practice")}finally{D(!1)}},se=n/4*100,te=G[n-1];return e.jsx(le,{open:w,onOpenChange:p,children:e.jsxs(de,{className:"sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(me,{children:e.jsxs(oe,{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(E,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xl",children:"Add Your Practice"}),e.jsx("p",{className:"text-sm font-normal text-muted-foreground mt-0.5",children:"Create your clinic profile in a few steps"})]})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Step ",n," of 4"]}),e.jsx("span",{className:"font-medium text-primary",children:te.title})]}),e.jsx(be,{value:se,className:"h-2"}),e.jsx("div",{className:"flex justify-between",children:G.map(s=>e.jsxs("div",{className:`flex flex-col items-center gap-1 ${n>=s.id?"text-primary":"text-muted-foreground"}`,children:[e.jsx("div",{className:`h-8 w-8 rounded-full flex items-center justify-center text-xs font-bold ${n>s.id?"bg-primary text-primary-foreground":n===s.id?"bg-primary/20 text-primary border-2 border-primary":"bg-muted text-muted-foreground"}`,children:n>s.id?e.jsx(P,{className:"h-4 w-4"}):s.id}),e.jsx("span",{className:"text-[10px] hidden sm:block",children:s.title})]},s.id))})]}),e.jsxs("div",{className:"py-4",children:[n===1&&e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{children:[e.jsxs(x,{htmlFor:"clinicName",className:"flex items-center gap-2",children:[e.jsx(E,{className:"h-4 w-4 text-muted-foreground"}),"Practice Name *"]}),e.jsx(y,{id:"clinicName",name:"clinicName",value:t.clinicName,onChange:j,placeholder:"e.g., Sunshine Dental Care",className:i.clinicName?"border-destructive":""}),i.clinicName&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:i.clinicName})]}),e.jsxs("div",{children:[e.jsxs(x,{htmlFor:"dentistName",className:"flex items-center gap-2",children:[e.jsx(xe,{className:"h-4 w-4 text-muted-foreground"}),"Your Name *"]}),e.jsx(y,{id:"dentistName",name:"dentistName",value:t.dentistName,onChange:j,placeholder:"Dr. John Smith",className:i.dentistName?"border-destructive":""}),i.dentistName&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:i.dentistName})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs(x,{htmlFor:"stateId",className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4 text-muted-foreground"}),"Emirate *"]}),e.jsxs(L,{value:t.stateId,onValueChange:s=>{N(a=>({...a,stateId:s,cityId:""})),i.stateId&&S(a=>({...a,stateId:""}))},children:[e.jsx(R,{className:i.stateId?"border-destructive":"",children:e.jsx(V,{placeholder:"Select emirate"})}),e.jsx(W,{children:_.map(s=>e.jsx(O,{value:s.id,children:s.name},s.id))})]}),i.stateId&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:i.stateId})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"cityId",className:"flex items-center gap-2",children:"Area *"}),e.jsxs(L,{value:t.cityId,onValueChange:s=>{N(a=>({...a,cityId:s})),i.cityId&&S(a=>({...a,cityId:""}))},disabled:!t.stateId,children:[e.jsx(R,{className:i.cityId?"border-destructive":"",children:e.jsx(V,{placeholder:t.stateId?"Select area":"Select emirate first"})}),e.jsx(W,{children:A.map(s=>e.jsx(O,{value:s.id,children:s.name},s.id))})]}),i.cityId&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:i.cityId})]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"streetAddress",className:"flex items-center gap-2",children:"Street Address (Optional)"}),e.jsx(y,{id:"streetAddress",name:"streetAddress",value:t.streetAddress,onChange:j,placeholder:"123 Main Street, Suite 100"})]})]})}),n===2&&e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{children:[e.jsxs(x,{htmlFor:"email",className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4 text-muted-foreground"}),"Business Email *"]}),e.jsx(y,{id:"email",name:"email",type:"email",value:t.email,onChange:j,placeholder:"contact@yourpractice.com",className:i.email?"border-destructive":""}),i.email&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:i.email})]}),e.jsxs("div",{children:[e.jsxs(x,{htmlFor:"phone",className:"flex items-center gap-2",children:[e.jsx(H,{className:"h-4 w-4 text-muted-foreground"}),"Phone Number *"]}),e.jsx(y,{id:"phone",name:"phone",value:t.phone,onChange:j,placeholder:"+971 50 123 4567",className:i.phone?"border-destructive":""}),i.phone&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:i.phone})]}),e.jsxs("div",{children:[e.jsxs(x,{htmlFor:"website",className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-4 w-4 text-muted-foreground"}),"Website (Optional)"]}),e.jsx(y,{id:"website",name:"website",value:t.website,onChange:j,placeholder:"https://yourpractice.com"})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"description",className:"flex items-center gap-2",children:"About Your Practice (Optional)"}),e.jsx(fe,{id:"description",name:"description",value:t.description,onChange:j,placeholder:"Tell patients about your practice, specialties, and what makes you unique...",rows:4})]})]})}),n===3&&e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsxs(x,{className:"flex items-center gap-2 mb-3",children:[e.jsx(J,{className:"h-4 w-4 text-muted-foreground"}),"Services Offered"]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Select the services your practice offers. This helps patients find you."}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-64 overflow-y-auto p-1",children:q.map(s=>e.jsxs("div",{className:`flex items-center gap-2 p-3 rounded-lg border cursor-pointer transition-all ${h.includes(s.id)?"border-primary bg-primary/5":"border-border hover:border-primary/30"}`,onClick:()=>Y(s.id),children:[e.jsx(U,{checked:h.includes(s.id),onCheckedChange:()=>Y(s.id)}),e.jsx("span",{className:"text-sm",children:s.name})]},s.id))}),h.length>0&&e.jsxs("p",{className:"text-sm text-primary mt-3",children:[h.length," service",h.length>1?"s":""," selected"]})]})}),n===4&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-muted/50 rounded-xl p-4 space-y-3",children:[e.jsxs("h4",{className:"font-semibold flex items-center gap-2",children:[e.jsx(P,{className:"h-4 w-4 text-primary"}),"Review Your Information"]}),e.jsxs("div",{className:"grid gap-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Practice Name"}),e.jsx("span",{className:"font-medium",children:t.clinicName})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Your Name"}),e.jsx("span",{className:"font-medium",children:t.dentistName})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Location"}),e.jsxs("span",{className:"font-medium",children:[A.find(s=>s.id===t.cityId)?.name||"",","," ",_.find(s=>s.id===t.stateId)?.name||""]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Email"}),e.jsx("span",{className:"font-medium",children:t.email})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Phone"}),e.jsx("span",{className:"font-medium",children:t.phone})]}),t.website&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Website"}),e.jsx("span",{className:"font-medium truncate max-w-[200px]",children:t.website})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Services"}),e.jsxs("span",{className:"font-medium",children:[h.length," selected"]})]})]})]}),e.jsx("div",{className:"bg-primary/5 border border-primary/20 rounded-xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(je,{className:"h-5 w-5 text-primary flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-medium text-primary mb-1",children:"What happens next?"}),e.jsxs("ul",{className:"text-muted-foreground space-y-1",children:[e.jsx("li",{children:"• Your practice will be created immediately"}),e.jsx("li",{children:"• You can edit your profile anytime from the dashboard"}),e.jsx("li",{children:"• Upgrade to a paid plan for enhanced visibility"})]})]})]})}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(U,{id:"agreeTerms",checked:t.agreeTerms,onCheckedChange:s=>N(a=>({...a,agreeTerms:s}))}),e.jsx("label",{htmlFor:"agreeTerms",className:"text-sm text-muted-foreground cursor-pointer",children:"I agree to the Terms of Service and Privacy Policy"})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between pt-4 border-t",children:[e.jsxs(k,{type:"button",variant:"ghost",onClick:n===1?()=>p(!1):K,children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),n===1?"Cancel":"Back"]}),n<4?e.jsxs(k,{onClick:z,children:["Next",e.jsx(Ne,{className:"h-4 w-4 ml-2"})]}):e.jsx(k,{onClick:ee,disabled:$||!t.agreeTerms,className:"bg-gradient-to-r from-primary to-teal hover:from-primary/90 hover:to-teal/90",children:$?e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"h-4 w-4 mr-2 animate-spin"}),"Creating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Create Practice"]})})]})]})})}export{Ye as A};
