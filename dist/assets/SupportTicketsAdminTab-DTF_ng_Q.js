import{b as Y,u as M,c as q,j as e}from"./chunk-CPh6voF3.js";import{r as x}from"./chunk-CffrGP6S.js";import{f as Z,s as c,t as B,C as F,p as J,I as W,L,w as ee,i as g,Q as P,B as R,a9 as se,aa as ae,ab as te,ac as re,a as d,a2 as H,a3 as O,a5 as D,a6 as Q,a7 as l,S as le,a8 as ne,al as ie,$ as ce,b as N}from"./index-DflORfjh.js";import{C as m,d as u}from"./chunk-Dwq_v72W.js";import{T as de,a as oe,b as f}from"./chunk-k8HiDHrE.js";import{T as xe,a as me,b as v,c as i,d as ue,e as r}from"./chunk-NLs5Ye4A.js";import{T as U}from"./chunk-DbdCK11k.js";import{M as he}from"./chunk-B7d2qnKb.js";import{C as pe}from"./chunk-CbEmr7WL.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-Drd-rt-S.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const k=Z("Ticket",[["path",{d:"M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z",key:"qn84l0"}],["path",{d:"M13 5v2",key:"dyzc3o"}],["path",{d:"M13 17v2",key:"1ont0d"}],["path",{d:"M13 11v2",key:"1wjjxi"}]]),A={open:{label:"Open",color:"bg-blue-100 text-blue-800",icon:B},in_progress:{label:"In Progress",color:"bg-yellow-100 text-yellow-800",icon:U},resolved:{label:"Resolved",color:"bg-green-100 text-green-800",icon:F},closed:{label:"Closed",color:"bg-gray-100 text-gray-800",icon:pe}},je={low:{label:"Low",color:"bg-gray-100 text-gray-600"},medium:{label:"Medium",color:"bg-blue-100 text-blue-700"},high:{label:"High",color:"bg-orange-100 text-orange-700"},urgent:{label:"Urgent",color:"bg-red-100 text-red-700"}};function Le(){const b=Y(),[y,E]=x.useState("all"),[h,K]=x.useState(""),[a,w]=x.useState(null),[p,_]=x.useState(""),[V,z]=x.useState(!1),{data:o,isLoading:G}=M({queryKey:["admin-support-tickets"],queryFn:async()=>{const{data:s,error:t}=await c.from("support_tickets").select("*, clinic:clinics(id, name)").order("created_at",{ascending:!1});if(t)throw t;return s}}),{data:C}=M({queryKey:["ticket-replies",a?.id],queryFn:async()=>{if(!a)return[];const{data:s,error:t}=await c.from("support_ticket_replies").select("*").eq("ticket_id",a.id).order("created_at",{ascending:!0});if(t)throw t;return s},enabled:!!a}),I=q({mutationFn:async({id:s,updates:t})=>{const{error:n}=await c.from("support_tickets").update({...t,updated_at:new Date().toISOString()}).eq("id",s);if(n)throw n},onSuccess:()=>{b.invalidateQueries({queryKey:["admin-support-tickets"]}),N.success("Ticket updated")},onError:s=>N.error(s.message)}),T=q({mutationFn:async()=>{if(!a||!p.trim())return;const{data:{user:s}}=await c.auth.getUser();if(!s)throw new Error("Not authenticated");const{error:t}=await c.from("support_ticket_replies").insert([{ticket_id:a.id,user_id:s.id,content:p,is_admin_reply:!0}]);if(t)throw t;a.status==="open"&&await c.from("support_tickets").update({status:"in_progress",updated_at:new Date().toISOString()}).eq("id",a.id)},onSuccess:()=>{b.invalidateQueries({queryKey:["ticket-replies",a?.id]}),b.invalidateQueries({queryKey:["admin-support-tickets"]}),_(""),N.success("Reply sent")},onError:s=>N.error(s.message)}),S=o?.filter(s=>{const t=!h||s.subject.toLowerCase().includes(h.toLowerCase())||s.clinic?.name?.toLowerCase().includes(h.toLowerCase()),n=y==="all"||s.status===y;return t&&n}),j={open:o?.filter(s=>s.status==="open").length||0,inProgress:o?.filter(s=>s.status==="in_progress").length||0,resolved:o?.filter(s=>s.status==="resolved").length||0,total:o?.length||0};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-display font-bold text-foreground",children:"Support Tickets"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage dentist support requests"})]})}),e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsx(m,{className:"card-modern",children:e.jsxs(u,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-blue-100 flex items-center justify-center",children:e.jsx(B,{className:"h-6 w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:j.open}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Open"})]})]})}),e.jsx(m,{className:"card-modern",children:e.jsxs(u,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-yellow-100 flex items-center justify-center",children:e.jsx(U,{className:"h-6 w-6 text-yellow-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:j.inProgress}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"In Progress"})]})]})}),e.jsx(m,{className:"card-modern",children:e.jsxs(u,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-green-100 flex items-center justify-center",children:e.jsx(F,{className:"h-6 w-6 text-green-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:j.resolved}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Resolved"})]})]})}),e.jsx(m,{className:"card-modern",children:e.jsxs(u,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(k,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:j.total}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Tickets"})]})]})})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(J,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(W,{className:"pl-10",placeholder:"Search tickets...",value:h,onChange:s=>K(s.target.value)})]}),e.jsx(de,{value:y,onValueChange:E,children:e.jsxs(oe,{children:[e.jsx(f,{value:"all",children:"All"}),e.jsx(f,{value:"open",children:"Open"}),e.jsx(f,{value:"in_progress",children:"In Progress"}),e.jsx(f,{value:"resolved",children:"Resolved"})]})})]}),e.jsx(m,{className:"card-modern",children:e.jsx(u,{className:"p-0",children:e.jsxs(xe,{children:[e.jsx(me,{children:e.jsxs(v,{children:[e.jsx(i,{children:"Ticket"}),e.jsx(i,{children:"Clinic"}),e.jsx(i,{children:"Category"}),e.jsx(i,{children:"Priority"}),e.jsx(i,{children:"Status"}),e.jsx(i,{children:"Created"}),e.jsx(i,{className:"text-right",children:"Actions"})]})}),e.jsx(ue,{children:G?e.jsx(v,{children:e.jsx(r,{colSpan:7,className:"text-center py-8",children:e.jsx(L,{className:"h-8 w-8 animate-spin mx-auto"})})}):S&&S.length>0?S.map(s=>{const t=A[s.status]||A.open,n=je[s.priority||"medium"],$=t.icon;return e.jsxs(v,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>w(s),children:[e.jsx(r,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.subject}),e.jsx("p",{className:"text-xs text-muted-foreground truncate max-w-xs",children:s.description})]})}),e.jsx(r,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:s.clinic?.name||"Unknown"})]})}),e.jsx(r,{children:e.jsx(g,{variant:"outline",children:s.category})}),e.jsx(r,{children:e.jsx(g,{className:n.color,children:n.label})}),e.jsx(r,{children:e.jsxs(g,{className:t.color,children:[e.jsx($,{className:"h-3 w-3 mr-1"}),t.label]})}),e.jsx(r,{className:"text-muted-foreground text-sm",children:P(new Date(s.created_at),"MMM d, HH:mm")}),e.jsx(r,{className:"text-right",children:e.jsx(R,{size:"sm",variant:"ghost",onClick:X=>{X.stopPropagation(),w(s)},children:e.jsx(he,{className:"h-4 w-4"})})})]},s.id)}):e.jsx(v,{children:e.jsxs(r,{colSpan:7,className:"text-center py-8 text-muted-foreground",children:[e.jsx(k,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No tickets found"})]})})})]})})}),e.jsx(se,{open:!!a,onOpenChange:s=>!s&&w(null),children:e.jsxs(ae,{className:"max-w-2xl max-h-[80vh]",children:[e.jsx(te,{children:e.jsxs(re,{className:"flex items-center gap-2",children:[e.jsx(k,{className:"h-5 w-5"}),a?.subject]})}),a&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 p-4 rounded-xl bg-muted/50",children:[e.jsxs("div",{children:[e.jsx(d,{className:"text-muted-foreground",children:"Clinic"}),e.jsx("p",{className:"font-medium",children:a.clinic?.name})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-muted-foreground",children:"Category"}),e.jsx("p",{className:"font-medium",children:a.category})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-muted-foreground",children:"Status"}),e.jsxs(H,{value:a.status,onValueChange:s=>I.mutate({id:a.id,updates:{status:s}}),children:[e.jsx(O,{className:"w-40 mt-1",children:e.jsx(D,{})}),e.jsxs(Q,{children:[e.jsx(l,{value:"open",children:"Open"}),e.jsx(l,{value:"in_progress",children:"In Progress"}),e.jsx(l,{value:"resolved",children:"Resolved"}),e.jsx(l,{value:"closed",children:"Closed"})]})]})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-muted-foreground",children:"Priority"}),e.jsxs(H,{value:a.priority||"medium",onValueChange:s=>I.mutate({id:a.id,updates:{priority:s}}),children:[e.jsx(O,{className:"w-40 mt-1",children:e.jsx(D,{})}),e.jsxs(Q,{children:[e.jsx(l,{value:"low",children:"Low"}),e.jsx(l,{value:"medium",children:"Medium"}),e.jsx(l,{value:"high",children:"High"}),e.jsx(l,{value:"urgent",children:"Urgent"})]})]})]})]}),e.jsxs("div",{className:"p-4 rounded-xl bg-muted/30",children:[e.jsx(d,{className:"text-muted-foreground",children:"Description"}),e.jsx("p",{className:"mt-1",children:a.description})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Conversation"}),e.jsx(le,{className:"h-48 border rounded-xl p-4",children:C&&C.length>0?e.jsx("div",{className:"space-y-3",children:C.map(s=>e.jsxs("div",{className:`p-3 rounded-lg ${s.is_internal?"bg-yellow-50 border border-yellow-200":"bg-muted/50"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(ne,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:P(new Date(s.created_at),"MMM d, HH:mm")}),s.is_internal&&e.jsx(g,{variant:"outline",className:"text-xs",children:"Internal Note"})]}),e.jsx("p",{className:"text-sm",children:s.message})]},s.id))}):e.jsx("p",{className:"text-center text-muted-foreground text-sm py-8",children:"No replies yet"})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(ie,{placeholder:"Type your reply...",value:p,onChange:s=>_(s.target.value),rows:3}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:V,onChange:s=>z(s.target.checked),className:"rounded"}),e.jsx("span",{className:"text-muted-foreground",children:"Internal note (not visible to dentist)"})]}),e.jsxs(R,{onClick:()=>T.mutate(),disabled:T.isPending||!p.trim(),children:[T.isPending?e.jsx(L,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(ce,{className:"h-4 w-4 mr-2"}),"Send Reply"]})]})]})]})]})})]})}export{Le as default};
