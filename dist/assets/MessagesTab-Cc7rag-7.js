import{b as ce,u as b,c as de,j as e}from"./chunk-CPh6voF3.js";import{r as l}from"./chunk-CffrGP6S.js";import{f as oe,u as me,s as o,q as Q,P as v,i,a9 as xe,bc as he,B as g,aa as ue,ab as pe,ac as je,C as k,a as x,a2 as I,a3 as V,a5 as K,a6 as O,a7 as G,I as U,al as ge,$ as fe,t as Ne,p as be,Q as ve,b as $}from"./index-DflORfjh.js";import{u as ye,a as we}from"./chunk-Dq1MrkKO.js";import{C as r,a as L,b as R,d as n}from"./chunk-Dwq_v72W.js";import{S as F}from"./chunk-CQtADEjB.js";import{T as Se,a as Ce,b as y}from"./chunk-k8HiDHrE.js";import{N as _e}from"./chunk-BQwaAkM6.js";import{U as Me}from"./chunk-8P_iFEn-.js";import{M as w}from"./chunk-B7d2qnKb.js";import{C as qe}from"./chunk-DI0yTdYZ.js";import{P as z}from"./chunk-HAC-i_a2.js";import{C as E}from"./chunk-GLPyMM0F.js";import{C as Te}from"./chunk-CbEmr7WL.js";import{I as Pe}from"./chunk-C2VW2Ml6.js";import{A as Ae}from"./chunk-B0DPEAZ9.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-Drd-rt-S.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";import"./chunk-Cq66vzLV.js";import"./chunk-fofMllkR.js";import"./chunk-DSDQubI6.js";import"./chunk-BaL04tya.js";import"./chunk-CyKl6YHG.js";import"./chunk-BvZfqwfW.js";import"./chunk-B46JjdBY.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=oe("ArrowDownLeft",[["path",{d:"M17 7 7 17",key:"15tmo1"}],["path",{d:"M17 17H7V7",key:"1org7z"}]]),Y=[{id:"appointment_reminder",name:"Appointment Reminder",text:"Hi {name}, this is a reminder for your appointment at {clinic} on {date}. Reply YES to confirm or call us to reschedule."},{id:"review_request",name:"Review Request",text:"Hi {name}, thank you for visiting {clinic}! We value your feedback. Please share your experience: {link}"},{id:"followup",name:"Follow-up",text:"Hi {name}, thank you for your visit to {clinic}. How are you feeling? Let us know if you need anything!"},{id:"promotion",name:"Special Offer",text:"Hi {name}! {clinic} has a special offer for you. Visit us this month and get 20% off your next treatment!"}];function ds(){const{user:S}=me(),J=ce(),[h,Z]=l.useState("all"),[f,ee]=l.useState(""),[se,C]=l.useState(!1),[D,H]=l.useState(""),[m,_]=l.useState(""),[c,M]=l.useState(""),[u,W]=l.useState("sms"),{data:t,isLoading:ae}=b({queryKey:["dentist-clinic-messages",S?.id],queryFn:async()=>{const{data:s,error:a}=await o.from("clinics").select("id, name").eq("claimed_by",S?.id).limit(1).single();if(a&&a.code!=="PGRST116")throw a;return s},enabled:!!S?.id}),{data:d}=b({queryKey:["clinic-crm-number",t?.id],queryFn:async()=>{const{data:s,error:a}=await o.from("crm_numbers").select("*").eq("clinic_id",t?.id).eq("is_active",!0).limit(1).single();if(a&&a.code!=="PGRST116")throw a;return s},enabled:!!t?.id}),{data:p,isLoading:te,refetch:X}=b({queryKey:["clinic-messages",t?.id],queryFn:async()=>{const{data:s,error:a}=await o.from("clinic_messages").select("*").eq("clinic_id",t?.id).order("created_at",{ascending:!1}).limit(100);if(a)throw a;return s},enabled:!!t?.id}),{data:q}=b({queryKey:["clinic-patients-quick",t?.id],queryFn:async()=>{const{data:s,error:a}=await o.from("patients").select("id, name, phone, is_opted_in_sms").eq("clinic_id",t?.id).eq("is_opted_in_sms",!0).order("last_visit_at",{ascending:!1}).limit(20);if(a)throw a;return s},enabled:!!t?.id});l.useEffect(()=>{if(!t?.id)return;const s=o.channel("clinic-messages-realtime").on("postgres_changes",{event:"*",schema:"public",table:"clinic_messages",filter:`clinic_id=eq.${t.id}`},()=>{X()}).subscribe();return()=>{o.removeChannel(s)}},[t?.id,X]);const T=de({mutationFn:async()=>{if(!t?.id)throw new Error("No clinic found");if(!m.trim())throw new Error("Phone number is required");if(!c.trim())throw new Error("Message is required");const{error:s}=await o.from("clinic_messages").insert({clinic_id:t.id,recipient_phone:m.trim(),message_content:c.trim(),channel:u,direction:"outbound",status:d?"queued":"pending",template_type:D||null,crm_number_id:d?.id||null});if(s)throw s},onSuccess:()=>{$.success("Message queued for delivery"),C(!1),_(""),M(""),H(""),J.invalidateQueries({queryKey:["clinic-messages"]})},onError:s=>$.error(s.message||"Failed to send message")}),N=p?.filter(s=>{const a=!f||s.recipient_phone.includes(f)||s.message_content.toLowerCase().includes(f.toLowerCase()),A=h==="all"||h==="sent"&&s.direction==="outbound"||h==="received"&&s.direction==="inbound"||h==="failed"&&s.status==="failed";return a&&A}),j={total:p?.length||0,sent:p?.filter(s=>s.direction==="outbound"&&s.status==="delivered").length||0,pending:p?.filter(s=>s.status==="pending"||s.status==="queued").length||0,failed:p?.filter(s=>s.status==="failed").length||0},ie=s=>{H(s);const a=Y.find(A=>A.id===s);a&&M(a.text.replace("{clinic}",t?.name||"our clinic"))},re=s=>{switch(s){case"delivered":return e.jsx(i,{className:"bg-green-100 text-green-800 border-0",children:"Delivered"});case"sent":return e.jsx(i,{className:"bg-blue-100 text-blue-800 border-0",children:"Sent"});case"pending":case"queued":return e.jsx(i,{variant:"secondary",children:"Pending"});case"failed":return e.jsx(i,{variant:"destructive",children:"Failed"});default:return e.jsx(i,{variant:"outline",children:s})}},{data:ne}=ye(t?.id),{hasAccess:Le,usageLimit:B}=we(t?.id,"sms_reminders"),P=ne?.plan?.name||"Free",le=P!=="Free"&&P!=="Basic";return ae?e.jsxs("div",{className:"space-y-6",children:[e.jsx(F,{className:"h-12"}),e.jsx(F,{className:"h-64"})]}):t?le?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-display font-bold",children:"Messages"}),e.jsx("p",{className:"text-muted-foreground",children:"SMS & WhatsApp communication center"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(i,{className:"bg-primary/10 text-primary border-primary/20",children:[e.jsx(qe,{className:"h-3 w-3 mr-1"}),P]}),B&&e.jsxs(i,{variant:"outline",className:"text-muted-foreground",children:[j.total," / ",B," messages"]})]})]}),e.jsxs(xe,{open:se,onOpenChange:C,children:[e.jsx(he,{asChild:!0,children:e.jsxs(g,{className:"gap-2",children:[e.jsx(z,{className:"h-4 w-4"}),"Compose Message"]})}),e.jsxs(ue,{className:"max-w-lg",children:[e.jsx(pe,{children:e.jsx(je,{children:"Compose Message"})}),e.jsxs("div",{className:"space-y-4",children:[d?e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-green-50 border border-green-200 rounded-xl",children:[e.jsx(k,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-green-800",children:["Sending from: ",d.phone_number]}),d.is_whatsapp_enabled&&e.jsx("p",{className:"text-xs text-green-700",children:"WhatsApp enabled"})]})]}):e.jsxs("div",{className:"flex items-start gap-3 p-4 bg-amber-50 border border-amber-200 rounded-xl",children:[e.jsx(E,{className:"h-5 w-5 text-amber-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-amber-800",children:"No CRM Number Assigned"}),e.jsx("p",{className:"text-sm text-amber-700",children:"Messages will be queued but cannot be sent until a number is assigned by admin."})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Channel"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{type:"button",variant:u==="sms"?"default":"outline",onClick:()=>W("sms"),className:"flex-1",children:"SMS"}),e.jsx(g,{type:"button",variant:u==="whatsapp"?"default":"outline",onClick:()=>W("whatsapp"),disabled:!d?.is_whatsapp_enabled,className:"flex-1",children:"WhatsApp"})]})]}),q&&q.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Quick Select Patient"}),e.jsxs(I,{onValueChange:s=>_(s),children:[e.jsx(V,{children:e.jsx(K,{placeholder:"Select a patient..."})}),e.jsx(O,{children:q.map(s=>e.jsxs(G,{value:s.phone,children:[s.name," - ",s.phone]},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Recipient Phone Number"}),e.jsxs("div",{className:"relative",children:[e.jsx(v,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(U,{className:"pl-10",placeholder:"+971 50 XXX XXXX",value:m,onChange:s=>_(s.target.value)})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Message Template (Optional)"}),e.jsxs(I,{value:D,onValueChange:ie,children:[e.jsx(V,{children:e.jsx(K,{placeholder:"Select a template..."})}),e.jsx(O,{children:Y.map(s=>e.jsx(G,{value:s.id,children:s.name},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Message"}),e.jsx(ge,{value:c,onChange:s=>M(s.target.value),placeholder:"Type your message...",rows:4}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[c.length," / 160 characters (SMS limit)"]})]}),c.trim()&&m.trim()&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs(x,{className:"flex items-center gap-2 text-green-600",children:[e.jsx(k,{className:"h-4 w-4"}),"Message Preview"]}),e.jsx(r,{className:"bg-teal/5 border-teal/20",children:e.jsx(n,{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0",children:u==="whatsapp"?e.jsx(w,{className:"h-4 w-4 text-green-600"}):e.jsx(v,{className:"h-4 w-4 text-blue-600"})}),e.jsxs("div",{className:"text-sm space-y-1 flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"font-medium",children:["To: ",m]}),e.jsx(i,{variant:"outline",className:"text-xs capitalize",children:u})]}),e.jsx("p",{className:"text-muted-foreground whitespace-pre-wrap",children:c})]})]})})})]}),e.jsxs(g,{className:"w-full",onClick:()=>T.mutate(),disabled:T.isPending||!m.trim()||!c.trim(),children:[e.jsx(fe,{className:"h-4 w-4 mr-2"}),T.isPending?"Sending...":"Send Message"]})]})]})]}),!d&&e.jsx(r,{className:"border-amber-200 bg-amber-50",children:e.jsxs(n,{className:"py-4 flex items-center gap-3",children:[e.jsx(E,{className:"h-5 w-5 text-amber-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-amber-800",children:"No CRM Number Assigned"}),e.jsx("p",{className:"text-sm text-amber-700",children:"Contact admin to get a dedicated phone number for sending messages."})]})]})}),e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsx(r,{children:e.jsx(n,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(w,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:j.total}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total Messages"})]})]})})}),e.jsx(r,{children:e.jsx(n,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-green-100 flex items-center justify-center",children:e.jsx(k,{className:"h-5 w-5 text-green-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:j.sent}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Delivered"})]})]})})}),e.jsx(r,{children:e.jsx(n,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-amber-100 flex items-center justify-center",children:e.jsx(Ne,{className:"h-5 w-5 text-amber-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:j.pending}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Pending"})]})]})})}),e.jsx(r,{children:e.jsx(n,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-red-100 flex items-center justify-center",children:e.jsx(Te,{className:"h-5 w-5 text-red-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:j.failed}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Failed"})]})]})})})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(be,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(U,{className:"pl-10",placeholder:"Search by phone or content...",value:f,onChange:s=>ee(s.target.value)})]}),e.jsx(Se,{value:h,onValueChange:Z,children:e.jsxs(Ce,{children:[e.jsx(y,{value:"all",children:"All"}),e.jsx(y,{value:"sent",children:"Sent"}),e.jsx(y,{value:"received",children:"Received"}),e.jsx(y,{value:"failed",children:"Failed"})]})})]}),e.jsxs(r,{children:[e.jsx(L,{children:e.jsxs(R,{className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"h-5 w-5"}),"Message Log (",N?.length||0,")"]})}),e.jsx(n,{children:te?e.jsx("div",{className:"space-y-4",children:[...Array(5)].map((s,a)=>e.jsx(F,{className:"h-20"},a))}):N&&N.length>0?e.jsx("div",{className:"space-y-3",children:N.map(s=>e.jsxs("div",{className:"flex items-start justify-between p-4 bg-muted/50 rounded-xl border hover:bg-muted/70 transition-colors",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`h-10 w-10 rounded-full flex items-center justify-center ${s.direction==="outbound"?"bg-blue-100":"bg-green-100"}`,children:s.direction==="outbound"?e.jsx(Ae,{className:"h-5 w-5 text-blue-600"}):e.jsx(ke,{className:"h-5 w-5 text-green-600"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(v,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("span",{className:"font-medium",children:s.recipient_phone}),e.jsx(i,{variant:"outline",className:"text-xs uppercase",children:s.channel}),s.template_type&&e.jsx(i,{variant:"secondary",className:"text-xs",children:s.template_type.replace("_"," ")})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:s.message_content}),s.error_message&&e.jsxs("p",{className:"text-xs text-red-500 mt-1 flex items-center gap-1",children:[e.jsx(E,{className:"h-3 w-3"}),s.error_message]})]})]}),e.jsxs("div",{className:"text-right",children:[re(s.status),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:ve(new Date(s.created_at),"MMM d, HH:mm")})]})]},s.id))}):e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(w,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"font-medium",children:"No messages found"}),e.jsx("p",{className:"text-sm mt-1",children:"Send your first message to a patient"}),e.jsxs(g,{className:"mt-4",onClick:()=>C(!0),children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Compose Message"]})]})})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-display font-bold",children:"Messages"}),e.jsx("p",{className:"text-muted-foreground",children:"SMS & WhatsApp communication center"})]}),e.jsx(Me,{featureName:"Messaging Center",featureDescription:"Send SMS and WhatsApp messages to your patients for reminders, follow-ups, and promotions.",requiredPlan:"professional",clinicId:t.id}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4 opacity-60 pointer-events-none",children:[e.jsxs(r,{className:"border-dashed",children:[e.jsx(L,{className:"pb-3",children:e.jsxs(R,{className:"text-base flex items-center gap-2",children:[e.jsx(w,{className:"h-4 w-4 text-primary"}),"SMS Messages",e.jsx(Q,{className:"h-3 w-3 text-muted-foreground ml-auto"})]})}),e.jsx(n,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Send appointment reminders and follow-up messages via SMS"})})]}),e.jsxs(r,{className:"border-dashed",children:[e.jsx(L,{className:"pb-3",children:e.jsxs(R,{className:"text-base flex items-center gap-2",children:[e.jsx(v,{className:"h-4 w-4 text-teal"}),"WhatsApp Business",e.jsx(Q,{className:"h-3 w-3 text-muted-foreground ml-auto"})]})}),e.jsx(n,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Connect with patients through WhatsApp messaging"})})]})]})]}):e.jsx(_e,{compact:!0})}export{ds as default};
