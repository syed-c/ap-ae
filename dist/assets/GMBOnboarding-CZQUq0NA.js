import{b as ue,u as z,j as e}from"./chunk-CPh6voF3.js";import{r as d}from"./chunk-CffrGP6S.js";import{a as he,c as xe}from"./chunk-Drd-rt-S.js";import{f as pe,u as fe,s as n,L as w,i as ge,C as o,bd as m,x as _,B as u,q as H,Y as S,o as je,n as be,a as T,I as W,b as x}from"./index-DflORfjh.js";import{C as L,a as D,b as q,c as A,d as B}from"./chunk-Dwq_v72W.js";import{P as we}from"./chunk-DSDQubI6.js";import{L as Ne}from"./chunk-CDkOFsI-.js";import{s as ye,Z as ve}from"./chunk-yff5u8mE.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-BEQ5VEiB.js";import"./chunk-xExVBHTi.js";import"./chunk-HAC-i_a2.js";import"./chunk-DbdCK11k.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=pe("PartyPopper",[["path",{d:"M5.8 11.3 2 22l10.7-3.79",key:"gwxi1d"}],["path",{d:"M4 3h.01",key:"1vcuye"}],["path",{d:"M22 8h.01",key:"1mrtc2"}],["path",{d:"M15 2h.01",key:"1cjtqr"}],["path",{d:"M22 20h.01",key:"1mrys2"}],["path",{d:"m22 2-2.24.75a2.9 2.9 0 0 0-1.96 3.12c.1.86-.57 1.63-1.45 1.63h-.38c-.86 0-1.6.6-1.76 1.44L14 10",key:"hbicv8"}],["path",{d:"m22 13-.82-.33c-.86-.34-1.82.2-1.98 1.11c-.11.7-.72 1.22-1.43 1.22H17",key:"1i94pl"}],["path",{d:"m11 2 .33.82c.34.86-.2 1.82-1.11 1.98C9.52 4.9 9 5.52 9 6.23V7",key:"1cofks"}],["path",{d:"M11 13c1.93 1.93 2.83 4.17 2 5-.83.83-3.07-.07-5-2-1.93-1.93-2.83-4.17-2-5 .83-.83 3.07.07 5 2Z",key:"4kbmks"}]]),ke=ye().min(6,"Password must be at least 6 characters");function Oe(){const{user:a,roles:N,refreshRoles:M,isLoading:y}=fe(),c=he(),[l]=xe(),I=ue(),[v,C]=d.useState("welcome"),[h,Z]=d.useState(""),[Y,U]=d.useState(""),[E,R]=d.useState(!1),[p,$]=d.useState(!1),[J,G]=d.useState(!1),X=l.get("new")==="true",f=l.get("gmb_connected")==="true",g=l.get("listing_created")==="true",ee=l.get("skip_gmb")==="true",O=l.get("location_pending")==="true",se=l.get("location_verified")==="true",ae=l.get("detected_city")||"",te=l.get("detected_city_id")||"",F=N.includes("dentist"),{data:t,isLoading:k}=z({queryKey:["user-clinic",a?.id],queryFn:async()=>{if(!a?.id)return null;const{data:s}=await n.from("clinics").select("*, city:cities(name), area:areas(name)").eq("claimed_by",a.id).maybeSingle();return s},enabled:!!a?.id}),{data:j}=z({queryKey:["user-onboarding",a?.id],queryFn:async()=>{if(!a?.id)return null;const{data:s}=await n.from("user_onboarding").select("*").eq("user_id",a.id).maybeSingle();return s},enabled:!!a?.id}),b=X&&j?.onboarding_status!=="complete",K=N.includes("super_admin")||N.includes("district_manager");d.useEffect(()=>{let s=document.querySelector('meta[name="robots"]');return s||(s=document.createElement("meta"),s.setAttribute("name","robots"),document.head.appendChild(s)),s.setAttribute("content","noindex, nofollow"),()=>{s?.setAttribute("content","index, follow")}},[]),d.useEffect(()=>{if(y||k)return;if(!a){c("/auth",{replace:!0});return}const s=!b&&!f,P=j?.onboarding_status==="complete",i=!j;if(K){c("/admin",{replace:!0});return}s&&(P||i)&&(F?c("/dashboard?tab=my-dashboard",{replace:!0}):c("/",{replace:!0}))},[y,k,a,j,b,f,F,K,c]);const r={hasName:!!t?.name,hasAddress:!!t?.address,hasPhone:!!t?.phone,hasEmail:!!t?.email,hasDescription:!!t?.description,hasImages:!!t?.cover_image_url,hasLocation:!!t?.location_verified,percentage:0},Q=[r.hasName,r.hasAddress,r.hasPhone,r.hasEmail,r.hasDescription,r.hasImages,r.hasLocation];r.percentage=Math.round(Q.filter(Boolean).length/Q.length*100);const re=O||t&&!t.location_verified&&!t.location_pending_approval,ie=a?.identities?.some(s=>s.provider==="email"),ne=a?.identities?.some(s=>s.provider==="google"),oe=a?.user_metadata?.full_name||a?.user_metadata?.name||a?.email?.split("@")[0]||"there",ce=async()=>{try{if(ke.parse(h),h!==Y){x.error("Passwords do not match");return}}catch(s){if(s instanceof ve){x.error(s.errors[0].message);return}}R(!0);try{const{error:s}=await n.auth.updateUser({password:h});if(s)throw s;x.success("Password set successfully!"),C("complete")}catch(s){x.error(s.message||"Failed to set password")}finally{R(!1)}},le=()=>{C("complete")},de=async()=>{if(!a?.id)return;const s=new Date().toISOString();await n.from("user_onboarding").upsert({user_id:a.id,onboarding_status:"complete",completed_at:s,updated_at:s},{onConflict:"user_id"}),I.invalidateQueries({queryKey:["user-onboarding"]})},V=async()=>{$(!0);const{data:s}=await n.from("user_roles").select("role").eq("user_id",a.id);if(!(s??[]).some(i=>i.role==="dentist"))try{const{data:{session:i}}=await n.auth.getSession();i?.access_token&&(await n.functions.invoke("dentist-onboarding-bootstrap",{headers:{Authorization:`Bearer ${i.access_token}`}}),await M())}catch(i){console.error("Bootstrap error:",i)}await de(),c("/dashboard?tab=my-dashboard",{replace:!0})},me=async()=>{const{data:s}=await n.from("user_roles").select("role").eq("user_id",a.id);if(!(s??[]).some(i=>i.role==="dentist"))try{const{data:{session:i}}=await n.auth.getSession();i?.access_token&&(await n.functions.invoke("dentist-onboarding-bootstrap",{headers:{Authorization:`Bearer ${i.access_token}`}}),await M())}catch(i){console.error("Bootstrap error:",i)}c("/dashboard?tab=my-profile",{replace:!0})};return y||k?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-background via-background to-muted",children:e.jsx(w,{className:"h-8 w-8 animate-spin text-primary"})}):a?e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-background via-background to-muted py-12 px-4",children:[e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-primary to-coral bg-clip-text text-transparent mb-2",children:"Appoint Panda"}),e.jsx("p",{className:"text-muted-foreground",children:"Your dental practice dashboard"})]}),v==="welcome"&&e.jsxs(L,{className:"border-0 shadow-xl",children:[e.jsxs(D,{className:"text-center pb-2",children:[e.jsx("div",{className:"mx-auto h-20 w-20 rounded-full bg-gradient-to-br from-primary/20 to-teal/20 flex items-center justify-center mb-4",children:e.jsx(Ce,{className:"h-10 w-10 text-primary"})}),e.jsxs(q,{className:"text-2xl",children:["Welcome, ",oe,"!"]}),e.jsx(A,{className:"text-base",children:g?"Your practice has been successfully listed!":b&&ee?"Let's set up your practice profile manually.":b?"You've successfully signed up. Let's set up your practice profile.":f?"Your Google Business Profile is now connected!":"Welcome back! Let's complete your practice setup."})]}),e.jsxs(B,{className:"space-y-6",children:[t&&e.jsxs("div",{className:"bg-muted/50 rounded-xl p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:"Profile Completeness"}),e.jsxs(ge,{variant:r.percentage>=80?"default":"secondary",children:[r.percentage,"%"]})]}),e.jsx(we,{value:r.percentage,className:"h-2"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[r.hasName?e.jsx(o,{className:"h-4 w-4 text-teal"}):e.jsx(m,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:"Practice name"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[r.hasAddress?e.jsx(o,{className:"h-4 w-4 text-teal"}):e.jsx(m,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:"Address"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[r.hasPhone?e.jsx(o,{className:"h-4 w-4 text-teal"}):e.jsx(m,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:"Phone number"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[r.hasEmail?e.jsx(o,{className:"h-4 w-4 text-teal"}):e.jsx(m,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:"Email"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[r.hasDescription?e.jsx(o,{className:"h-4 w-4 text-teal"}):e.jsx(m,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:"Description"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[r.hasImages?e.jsx(o,{className:"h-4 w-4 text-teal"}):e.jsx(m,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:"Cover image"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[r.hasLocation?e.jsx(o,{className:"h-4 w-4 text-teal"}):e.jsx(m,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:"Location confirmed"})]})]})]}),re&&t&&e.jsxs("div",{className:"flex items-start gap-3 bg-amber-50 border border-amber-200 rounded-xl p-4",children:[e.jsx(_,{className:"h-5 w-5 text-amber-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-amber-900",children:"Location Confirmation Required"}),e.jsx("p",{className:"text-sm text-amber-700 mb-3",children:"We couldn't auto-detect your exact area. Please confirm your location so your clinic appears on the right directory pages."}),e.jsxs(u,{onClick:()=>G(!0),className:"bg-amber-600 hover:bg-amber-700",size:"sm",children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Select Your Location"]})]})]}),se&&e.jsxs("div",{className:"flex items-center gap-3 bg-teal/10 rounded-xl p-4",children:[e.jsx(_,{className:"h-5 w-5 text-teal"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-teal",children:"Location Verified"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Your clinic is now listed in ",t?.area?.name||t?.city?.name||"your area"]})]})]}),(f||g)&&!O&&e.jsxs("div",{className:"flex items-center gap-3 bg-teal/10 rounded-xl p-4",children:[e.jsx(o,{className:"h-5 w-5 text-teal"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-teal",children:g?"Practice Listed Successfully":"Google Business Connected"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:g?"Your business data has been imported from Google":"Reviews and business info will sync automatically"})]})]}),e.jsxs("div",{className:"space-y-3",children:[!ie&&ne&&e.jsxs(u,{onClick:()=>C("password"),variant:"outline",className:"w-full h-12",children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),"Set a Password (Optional)"]}),e.jsxs(u,{onClick:me,variant:"outline",className:"w-full h-12",children:["Complete Your Profile",e.jsx(S,{className:"h-4 w-4 ml-2"})]}),e.jsxs(u,{onClick:V,className:"w-full h-12",disabled:p,children:[p?e.jsx(w,{className:"h-4 w-4 mr-2 animate-spin"}):null,"Skip → Go to Dashboard",e.jsx(S,{className:"h-4 w-4 ml-2"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 pt-4 border-t",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(je,{className:"h-4 w-4 text-primary mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Verified Badge"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Build patient trust"})]})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(be,{className:"h-4 w-4 text-primary mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:"Collect Reviews"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Grow your reputation"})]})]})]}),e.jsx("p",{className:"text-xs text-center text-muted-foreground pt-2",children:"Appoint Panda is currently available for dental practices in California, Massachusetts, and Connecticut."})]})]}),v==="password"&&e.jsxs(L,{className:"border-0 shadow-xl",children:[e.jsxs(D,{className:"text-center pb-2",children:[e.jsx("div",{className:"mx-auto h-16 w-16 rounded-full bg-muted flex items-center justify-center mb-4",children:e.jsx(H,{className:"h-8 w-8 text-primary"})}),e.jsx(q,{className:"text-2xl",children:"Set a Password"}),e.jsx(A,{children:"Create a password so you can also log in with email in the future"})]}),e.jsxs(B,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{htmlFor:"password",children:"New Password"}),e.jsx(W,{id:"password",type:"password",placeholder:"••••••••",value:h,onChange:s=>Z(s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{htmlFor:"confirmPassword",children:"Confirm Password"}),e.jsx(W,{id:"confirmPassword",type:"password",placeholder:"••••••••",value:Y,onChange:s=>U(s.target.value)})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(u,{variant:"outline",onClick:le,className:"flex-1",children:"Skip for Now"}),e.jsxs(u,{onClick:ce,disabled:E||!h,className:"flex-1",children:[E?e.jsx(w,{className:"h-4 w-4 animate-spin mr-2"}):null,"Set Password"]})]})]})]}),v==="complete"&&e.jsxs(L,{className:"border-0 shadow-xl",children:[e.jsxs(D,{className:"text-center pb-2",children:[e.jsx("div",{className:"mx-auto h-16 w-16 rounded-full bg-teal/10 flex items-center justify-center mb-4",children:e.jsx(o,{className:"h-8 w-8 text-teal"})}),e.jsx(q,{className:"text-2xl",children:"You're All Set!"}),e.jsx(A,{children:"Your account is ready. Head to your dashboard to manage your practice."})]}),e.jsx(B,{className:"space-y-4",children:e.jsxs(u,{onClick:V,className:"w-full h-12",disabled:p,children:[p?e.jsx(w,{className:"h-4 w-4 mr-2 animate-spin"}):null,"Go to Dashboard",e.jsx(S,{className:"h-4 w-4 ml-2"})]})})]})]}),t&&e.jsx(Ne,{open:J,onOpenChange:G,clinicId:t.id,detectedCity:ae||t?.city?.name,detectedCityId:te||t?.city_id,onLocationSelected:()=>{I.invalidateQueries({queryKey:["user-clinic"]}),x.success("Location confirmed! Your clinic is now live."),c("/onboarding?gmb_connected=true&listing_created=true&location_verified=true",{replace:!0})}})]}):null}export{Oe as default};
