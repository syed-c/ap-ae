import{b as xe,u as K,c as G,j as e}from"./chunk-CPh6voF3.js";import{r as c}from"./chunk-CffrGP6S.js";import{i as S,L as N,B as i,I as pe,G as ge,a2 as Z,a3 as U,a5 as X,a6 as Y,a7 as n,Q as je,C as ae,a9 as fe,aa as ve,ab as ye,ac as Ne,ad as be,ae as we,bA as Ce,b as y,s as P}from"./index-DflORfjh.js";import{C as R,a as k,b as _,d as B,c as D}from"./chunk-Dwq_v72W.js";import{T as Te,a as Se,b as W,c as L,d as Pe,e as A}from"./chunk-NLs5Ye4A.js";import{P as re}from"./chunk-DSDQubI6.js";import{S as Re}from"./chunk-D0B-jfny.js";import{E as ee}from"./chunk-CcezodbN.js";import{R as ne}from"./chunk-3oqKMbN4.js";import{R as se}from"./chunk-BOvFDp2b.js";import{T as E}from"./chunk-BRVan1jG.js";import{F as te}from"./chunk-BaL04tya.js";import{C as ke}from"./chunk-GLPyMM0F.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-Drd-rt-S.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";import"./chunk-BSjc5zjM.js";import"./chunk-k8HiDHrE.js";import"./chunk-C2VW2Ml6.js";import"./chunk-I1o_Hd8I.js";import"./chunk-CyRXX0qx.js";import"./chunk-DncHrJ4I.js";import"./chunk-CbETxTmt.js";import"./chunk-j7XJPWWF.js";import"./chunk-DbdCK11k.js";import"./chunk-CedtSHBb.js";import"./chunk-B7d2qnKb.js";import"./chunk-D2X27E5n.js";import"./chunk-Bl7VVhKV.js";import"./chunk-B_ghW3Ra.js";function _e({title:h,generated:l,cached:O,total:o,isLoading:d,status:u,onGenerate:x,onReset:p,isGenerating:b,isAutoRunning:m}){const w=o>0?Math.round(l/o*100):0,C=l>=o&&o>0,I=u==="running";return e.jsxs(R,{children:[e.jsx(k,{className:"pb-2",children:e.jsxs(_,{className:"text-sm font-medium text-muted-foreground flex items-center justify-between",children:[h,e.jsxs("div",{className:"flex items-center gap-1",children:[C&&e.jsx(ae,{className:"h-4 w-4 text-green-500"}),I&&e.jsx(N,{className:"h-4 w-4 animate-spin text-blue-500"})]})]})}),e.jsxs(B,{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-baseline justify-between",children:[e.jsx("span",{className:"text-2xl font-bold",children:d?"...":l}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["/ ",d?"...":o]})]}),e.jsx(re,{value:w,className:"h-2"}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:[w,"% • ",Math.max(0,o-l)," left"]}),e.jsxs("p",{className:"text-[11px] text-muted-foreground",children:["Cached: ",d?"...":O]})]}),e.jsxs("div",{className:"flex gap-1 pt-1",children:[e.jsx(i,{size:"sm",variant:"outline",className:"h-7 text-xs flex-1",onClick:x,disabled:b||C,children:b?e.jsx(N,{className:"h-3 w-3 animate-spin"}):e.jsx(Ce,{className:"h-3 w-3"})}),e.jsx(i,{size:"sm",variant:"ghost",className:"h-7 text-xs",onClick:p,disabled:b,children:e.jsx(ne,{className:"h-3 w-3"})})]})]})]})}function ds(){const h=xe(),[l,O]=c.useState("all"),[o,d]=c.useState(null),[u,x]=c.useState(null),[p,b]=c.useState(""),[m,w]=c.useState(null),[C,I]=c.useState(!1),g=c.useRef(!1),j=c.useRef(null),[ce,M]=c.useState(!1),[f,ie]=c.useState("all"),{data:t,isLoading:T,refetch:$}=K({queryKey:["static-pages-stats"],queryFn:async()=>{const{data:s,error:a}=await P.functions.invoke("generate-static-pages",{body:{action:"stats"}});if(a)throw a;return s},refetchInterval:u?1500:1e4}),{data:F,isLoading:le}=K({queryKey:["static-pages-cache",l],queryFn:async()=>{let s=P.from("static_page_cache").select("*").order("generated_at",{ascending:!1}).limit(100);l!=="all"&&(s=s.eq("page_type",l));const{data:a,error:r}=await s;if(r)throw r;return a||[]}}),q=G({mutationFn:async({pageType:s,reset:a})=>{d(s);const{data:r,error:v}=await P.functions.invoke("generate-static-pages",{body:{pageType:s,batchSize:50,reset:a}});if(v)throw v;return r},onSuccess:async s=>{$(),h.invalidateQueries({queryKey:["static-pages-cache"]}),console.log(`Batch result: ${s.generated} generated, ${s.currentOffset}/${s.totalCount}, ${s.remaining} remaining`),g.current&&!s.done&&j.current===s.pageType?setTimeout(()=>{g.current&&j.current===s.pageType&&q.mutate({pageType:s.pageType})},300):(d(null),s.done&&(y.success(`Completed ${s.pageType}: ${s.currentOffset} pages cached`),x(null),g.current=!1,j.current=null))},onError:s=>{y.error(`Generation failed: ${s.message}`),d(null),x(null),g.current=!1,j.current=null}}),H=G({mutationFn:async s=>{const{data:a,error:r}=await P.functions.invoke("generate-static-pages",{body:{action:"reset",pageType:s}});if(r)throw r;return a},onSuccess:()=>{y.success("Progress reset"),h.invalidateQueries({queryKey:["static-pages-stats"]})}}),z=G({mutationFn:async s=>{const{data:a,error:r}=await P.functions.invoke("generate-static-pages",{body:{action:"clear_cache",pageType:s==="all"?void 0:s}});if(r)throw r;return a},onSuccess:s=>{y.success(`Purged ${s.deleted||0} cache entries`),h.invalidateQueries({queryKey:["static-pages-stats"]}),h.invalidateQueries({queryKey:["static-pages-cache"]}),M(!1)},onError:s=>{y.error(`Purge failed: ${s.message}`)}}),oe=s=>{x(s),g.current=!0,j.current=s,q.mutate({pageType:s})},de=()=>{x(null),g.current=!1,j.current=null,d(null)},ue=async()=>{if(p){I(!0),w(null);try{const s=`https://apztvwpogywvounohqtk.supabase.co/functions/v1/serve-static?path=${encodeURIComponent(p)}&test=1`,a=await fetch(s,{headers:{Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwenR2d3BvZ3l3dm91bm9ocXRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyNTg4NzYsImV4cCI6MjA4NjgzNDg3Nn0.vZHtxYONCM5EM83I0sBKxBvLvNU0oGi7olJSy5FwRkM"}}),r=await a.text(),v=a.headers.get("x-static-cache")||"unknown";w({html:r,status:v})}catch(s){y.error(`Test failed: ${s}`)}finally{I(!1)}}},J=q.isPending,Q=new Map;if(t?.progress)for(const s of t.progress)Q.set(s.page_type,s);const V=t?.cachedByType||{state:0,city:0,service:0,service_location:0,clinic:0},me={state:t?.breakdown?.states||0,city:t?.breakdown?.cities||0,service:t?.breakdown?.treatments||0,service_location:t?.breakdown?.serviceLocations||0,clinic:t?.breakdown?.clinics||0},he=["state","city","service","service_location","clinic"];return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4",children:he.map(s=>{const a=Q.get(s),r=a?.status==="running"||a?.status==="complete"?a.current_offset:V[s],v=a?.total_count&&a.total_count>0?a.total_count:me[s];return e.jsx(_e,{title:s==="service_location"?"Service-Locations":s.charAt(0).toUpperCase()+s.slice(1)+"s",generated:r,cached:V[s],total:v,isLoading:T,status:a?.status,onGenerate:()=>oe(s),onReset:()=>H.mutate(s),isGenerating:o===s,isAutoRunning:u===s},s)})}),e.jsxs(R,{children:[e.jsx(k,{className:"pb-2",children:e.jsxs(_,{className:"text-sm font-medium flex items-center justify-between",children:["Overall Progress",u&&e.jsxs(S,{variant:"secondary",className:"gap-1",children:[e.jsx(N,{className:"h-3 w-3 animate-spin"}),"Auto-generating ",u]})]})}),e.jsxs(B,{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-baseline justify-between",children:[e.jsx("span",{className:"text-3xl font-bold",children:T?"...":t?.cached||0}),e.jsxs("span",{className:"text-lg text-muted-foreground",children:["/ ",T?"...":t?.totalPossible||0," pages"]})]}),e.jsx(re,{value:t?.totalPossible?Math.round((t?.cached||0)/t.totalPossible*100):0,className:"h-3"}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:[t?.totalPossible?Math.round((t?.cached||0)/t.totalPossible*100):0,"% complete • ",(t?.totalPossible||0)-(t?.cached||0)," pages remaining"]}),u&&e.jsxs(i,{size:"sm",variant:"destructive",onClick:de,children:[e.jsx(Re,{className:"h-3 w-3 mr-1"})," Stop"]})]})]})]}),e.jsxs(R,{children:[e.jsxs(k,{children:[e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-5 w-5"}),"Test Bot View"]}),e.jsx(D,{children:"Preview what bots see for a given path (uses test mode to bypass user-agent check)"})]}),e.jsxs(B,{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(pe,{placeholder:"/ca/los-angeles/",value:p,onChange:s=>b(s.target.value),className:"flex-1"}),e.jsxs(i,{onClick:ue,disabled:C||!p,children:[C?e.jsx(N,{className:"h-4 w-4 animate-spin"}):e.jsx(ee,{className:"h-4 w-4 mr-1"}),"Test"]})]}),m&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(S,{variant:m.status==="hit"?"default":m.status==="stale"?"secondary":"destructive",children:["Cache: ",m.status]})}),e.jsx("div",{className:"border rounded-lg p-4 bg-muted/50 max-h-96 overflow-auto",children:e.jsxs("pre",{className:"text-xs whitespace-pre-wrap font-mono",children:[m.html.substring(0,3e3),m.html.length>3e3&&"..."]})})]})]})]}),e.jsxs(R,{children:[e.jsxs(k,{children:[e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"h-5 w-5"}),"Batch Generation"]}),e.jsx(D,{children:"Click a category above to auto-generate pages in batches of 50. Generation will continue until complete."})]}),e.jsxs(B,{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsxs(i,{onClick:()=>H.mutate(void 0),variant:"outline",disabled:J,children:[e.jsx(ne,{className:"mr-2 h-4 w-4"}),"Reset All Progress"]}),e.jsxs(i,{variant:"outline",onClick:()=>$(),disabled:T,children:[e.jsx(se,{className:`mr-2 h-4 w-4 ${T?"animate-spin":""}`}),"Refresh Stats"]}),e.jsxs(i,{variant:"destructive",onClick:()=>M(!0),disabled:J,children:[e.jsx(E,{className:"mr-2 h-4 w-4"}),"Purge Cache"]})]}),t?.progress&&t.progress.some(s=>s.last_error)&&e.jsxs("div",{className:"p-3 bg-destructive/10 border border-destructive/20 rounded-lg",children:[e.jsx("p",{className:"text-sm font-medium text-destructive mb-1",children:"Recent Errors:"}),t.progress.filter(s=>s.last_error).map(s=>e.jsxs("p",{className:"text-xs text-muted-foreground",children:[e.jsxs("strong",{children:[s.page_type,":"]})," ",s.last_error]},s.page_type))]})]})]}),e.jsxs(R,{children:[e.jsx(k,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-5 w-5"}),"Cached Pages"]}),e.jsx(D,{children:"View generated static HTML files"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Z,{value:l,onValueChange:O,children:[e.jsx(U,{className:"w-40",children:e.jsx(X,{placeholder:"Filter by type"})}),e.jsxs(Y,{children:[e.jsx(n,{value:"all",children:"All Types"}),e.jsx(n,{value:"state",children:"States"}),e.jsx(n,{value:"city",children:"Cities"}),e.jsx(n,{value:"service",children:"Services"}),e.jsx(n,{value:"service_location",children:"Service-Locations"}),e.jsx(n,{value:"clinic",children:"Clinics"})]})]}),e.jsx(i,{variant:"outline",size:"icon",onClick:()=>$(),children:e.jsx(se,{className:"h-4 w-4"})})]})]})}),e.jsx(B,{children:le?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(N,{className:"h-6 w-6 animate-spin"})}):F&&F.length>0?e.jsxs(Te,{children:[e.jsx(Se,{children:e.jsxs(W,{children:[e.jsx(L,{children:"Path"}),e.jsx(L,{children:"Type"}),e.jsx(L,{children:"Generated"}),e.jsx(L,{children:"Status"})]})}),e.jsx(Pe,{children:F.map(s=>e.jsxs(W,{children:[e.jsx(A,{className:"font-mono text-sm",children:e.jsx("a",{href:`https://www.appointpanda.ae${s.path}`,target:"_blank",rel:"noopener noreferrer",className:"text-primary hover:underline",children:s.path})}),e.jsx(A,{children:e.jsx(S,{variant:"outline",children:s.page_type})}),e.jsx(A,{className:"text-sm text-muted-foreground",children:s.generated_at?je(new Date(s.generated_at),"MMM d, yyyy HH:mm"):"-"}),e.jsx(A,{children:s.is_stale?e.jsxs(S,{variant:"destructive",className:"gap-1",children:[e.jsx(ke,{className:"h-3 w-3"}),"Stale"]}):e.jsxs(S,{variant:"default",className:"gap-1 bg-green-600",children:[e.jsx(ae,{className:"h-3 w-3"}),"Fresh"]})})]},s.id))})]}):e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(te,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No cached pages found. Generate some pages to get started."})]})})]}),e.jsx(fe,{open:ce,onOpenChange:M,children:e.jsxs(ve,{children:[e.jsxs(ye,{children:[e.jsxs(Ne,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"h-5 w-5 text-destructive"}),"Purge Cache"]}),e.jsx(be,{children:"This will delete cached HTML files from the static page cache. Pages will be regenerated on the next crawl or manual generation."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"What to purge:"}),e.jsxs(Z,{value:f,onValueChange:ie,children:[e.jsx(U,{children:e.jsx(X,{placeholder:"Select type"})}),e.jsxs(Y,{children:[e.jsxs(n,{value:"all",children:["All Cache (",t?.cached||0," pages)"]}),e.jsxs(n,{value:"stale",children:["Stale Only (",t?.stale||0," pages)"]}),e.jsxs(n,{value:"state",children:["States Only (",t?.cachedByType?.state||0,")"]}),e.jsxs(n,{value:"city",children:["Cities Only (",t?.cachedByType?.city||0,")"]}),e.jsxs(n,{value:"service",children:["Services Only (",t?.cachedByType?.service||0,")"]}),e.jsxs(n,{value:"service_location",children:["Service Locations (",t?.cachedByType?.service_location||0,")"]}),e.jsxs(n,{value:"clinic",children:["Clinics Only (",t?.cachedByType?.clinic||0,")"]})]})]})]}),e.jsx("div",{className:"p-3 bg-destructive/10 border border-destructive/20 rounded-lg",children:e.jsx("p",{className:"text-sm text-destructive",children:"⚠️ This action cannot be undone. Bots will see minimal HTML until pages are regenerated."})})]}),e.jsxs(we,{children:[e.jsx(i,{variant:"outline",onClick:()=>M(!1),children:"Cancel"}),e.jsxs(i,{variant:"destructive",onClick:()=>z.mutate(f==="stale"?void 0:f),disabled:z.isPending,children:[z.isPending?e.jsx(N,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(E,{className:"h-4 w-4 mr-2"}),"Purge ",f==="all"?"All":f==="stale"?"Stale":f]})]})]})})]})}export{ds as default};
