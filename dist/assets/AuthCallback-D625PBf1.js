import{j as e}from"./chunk-CPh6voF3.js";import{r as _}from"./chunk-CffrGP6S.js";import{a as K,c as W}from"./chunk-Drd-rt-S.js";import{u as X,L as J,C as Q,B as M,g as V,s as u,d as Y,e as P}from"./index-DflORfjh.js";import{C as Z,a as ee,b as re,c as te,d as se}from"./chunk-Dwq_v72W.js";import{c as oe}from"./chunk-BSjc5zjM.js";import{C as ne}from"./chunk-CbEmr7WL.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";function xe(){const l=K(),[f]=W(),{refreshRoles:y}=X(),[w,j]=_.useState("processing"),[C,h]=_.useState("Processing authentication..."),[A,E]=_.useState(null);return _.useEffect(()=>{let g=document.querySelector('meta[name="robots"]');return g||(g=document.createElement("meta"),g.setAttribute("name","robots"),document.head.appendChild(g)),g.setAttribute("content","noindex, nofollow"),()=>{g?.setAttribute("content","index, follow")}},[]),_.useEffect(()=>{const g=t=>new Promise(n=>setTimeout(n,t)),R=async(t=8e3)=>{const s=Date.now();for(;Date.now()-s<t;){const{data:{session:o}}=await u.auth.getSession();if(o)return o;await g(200)}return null},D=async(t,n,s)=>{try{const{data:o,error:m}=await u.functions.invoke(t,{body:s,headers:{Authorization:`Bearer ${n}`}});return{data:o??null,error:m??null}}catch(o){return{data:null,error:o}}},L=async t=>{const n=localStorage.getItem("gmb_link_token");if(!n)return console.warn("No GMB link token found - skipping GMB transfer"),localStorage.removeItem("gmb_pending"),!1;try{h("Connecting Google Business Profile...");const{data:s,error:o}=await D("gmb-link-complete",t,{linkToken:n});if(o)throw o;if(!s?.success)throw new Error(s?.error||"Failed to complete GMB link");return localStorage.removeItem("gmb_link_token"),localStorage.removeItem("gmb_pending"),!0}catch(s){return console.error("Failed to complete GMB link:",s),!1}},O=async t=>{try{return h("Preparing business discovery..."),!0}catch(n){return console.error("Listing flow prep failed:",n),!1}},B=async t=>{const{data:n,error:s}=await u.from("user_roles").select("role").eq("user_id",t);return s&&console.warn("Failed to read user roles:",s),n?.map(o=>o.role)??[]},U=async t=>{const{data:n}=await u.from("user_onboarding").select("onboarding_status").eq("user_id",t).maybeSingle();return n?.onboarding_status??null};(async()=>{try{const t=f.get("error"),n=f.get("error_description");if(t){j("error"),h("Authentication failed"),E(n||t);return}const s=f.get("gmb")==="true"||localStorage.getItem("gmb_pending")==="true",o=f.get("listing")==="true"||localStorage.getItem("gmb_listing_flow")==="true",m=f.get("relink")==="true"||localStorage.getItem("gmb_relink_flow")==="true",q=localStorage.getItem("gmb_restore_session")==="true",x=V();let N=null;const G=f.get("code");if(G){const{data:r,error:i}=await u.auth.exchangeCodeForSession(G);if(r?.session?.provider_token&&(N=r.session.provider_token),i){const c=i.message?.toLowerCase?.()??"";throw c.includes("code verifier")||c.includes("code_verifier")||c.includes("both auth code and code verifier")?new Error("Sign-in could not be completed (missing verifier). This usually happens if sign-in started on a different domain, or the browser blocked/cleared storage during the redirect. Please retry from the same site and allow cookies/storage."):i}}else{const r=new URLSearchParams(window.location.hash.substring(1)),i=r.get("access_token");if(i){const{data:c,error:b}=await u.auth.setSession({access_token:i,refresh_token:r.get("refresh_token")||""});if(b)throw b;c?.session?.provider_token&&(N=c.session.provider_token)}}let S=await R();if(!S)throw new Error("No session was created. This may happen if sign-in started on a different domain. Please try again.");const p=N??S.provider_token??null;if(console.log("Provider token available:",!!p),p&&(Y(p),s||o||m))try{const{error:r}=await u.functions.invoke("gmb-store-token",{headers:{Authorization:`Bearer ${S.access_token}`},body:{providerToken:p,scopes:"openid email profile https://www.googleapis.com/auth/business.manage"}});r?console.warn("Failed to store GMB token server-side:",r):console.log("GMB token stored server-side successfully")}catch(r){console.warn("Error storing GMB token:",r)}let a=S,d=!1;if(q&&x&&(m||s)){h("Restoring your session..."),console.log("Restoring original user session after GMB OAuth");try{const{data:r,error:i}=await u.auth.refreshSession({refresh_token:x.refreshToken});if(i||!r?.session){console.warn("Failed to refresh original session, trying setSession...",i);const{data:c,error:b}=await u.auth.setSession({access_token:x.accessToken,refresh_token:x.refreshToken});b||!c?.session?(console.error("Failed to restore original session:",b),console.warn("Keeping GMB OAuth session as fallback - user may need to re-login as original account"),d=!1):(a=c.session,d=!0)}else a=r.session,d=!0,console.log("Original user session restored successfully via refresh")}catch(r){console.error("Failed to restore original session:",r),console.warn("Continuing with current session after restore failure")}P(),localStorage.removeItem("gmb_restore_session")}await oe({action:d?"GMB_LINK":"AUTH_LOGIN",entityType:"user",entityId:a.user.id,metadata:{provider:a.user.app_metadata?.provider||"unknown",isGmbCallback:s,isListingFlow:o,restoredOriginalUser:d}}).catch(()=>{});let k=await B(a.user.id);const z=(a.user.app_metadata?.provider||"unknown")==="google";let I=!1,v=!1;s&&!d&&(I=await L(a.access_token),I||(console.log("GMB transfer failed, redirecting to business selection"),v=!0),k=await B(a.user.id));const F=o||m;if(F&&!d&&!await O(a.access_token))throw new Error("Failed to prepare business discovery. Please try again.");!F&&!v&&!d&&(localStorage.removeItem("gmb_listing_flow"),localStorage.removeItem("gmb_relink_flow")),localStorage.removeItem("gmb_pending"),localStorage.removeItem("gmb_link_token"),await y(),j("success"),h(s||d?"Google Business Profile connected!":"Signed in successfully!");const le=await U(a.user.id),T=k.includes("super_admin")||k.includes("district_manager"),H=T||k.some(r=>["seo_team","content_team","marketing_team","support_team"].includes(r)),$=k.includes("dentist");if(m||o||v){(m||v)&&localStorage.setItem("gmb_relink_flow","true"),console.log("Redirecting to GMB selection page",{isRelinkFlow:m,isListingFlow:o,restoredOriginalUser:d}),l("/gmb-select",{replace:!0,state:{providerToken:p}});return}if(s&&I){l("/dashboard?tab=settings&gmb_connected=true",{replace:!0});return}if(T||H)l("/admin",{replace:!0});else if($)l("/dashboard?tab=my-dashboard",{replace:!0});else if(z){h("Setting up your account...");try{const{data:r,error:i}=await u.functions.invoke("dentist-onboarding-bootstrap",{headers:{Authorization:`Bearer ${a.access_token}`}});i?console.error("Bootstrap error:",i):console.log("Bootstrap complete:",r),await g(500),await y();const c=await B(a.user.id);console.log("New roles after bootstrap:",c),r?.needsClinic?(localStorage.setItem("gmb_listing_flow","true"),l("/gmb-select",{replace:!0,state:{providerToken:p,isNewUser:!0}})):l("/dashboard?tab=my-dashboard",{replace:!0})}catch(r){console.error("Failed to bootstrap dentist:",r),localStorage.setItem("gmb_listing_flow","true"),l("/gmb-select",{replace:!0,state:{providerToken:p,isNewUser:!0}})}}else l("/onboarding?new=true",{replace:!0})}catch(t){console.error("Auth callback error:",t),j("error"),h("Authentication failed"),E(t instanceof Error?t.message:"Unknown error occurred"),localStorage.removeItem("gmb_link_token"),localStorage.removeItem("gmb_pending"),localStorage.removeItem("gmb_listing_flow"),localStorage.removeItem("gmb_restore_session"),P()}})()},[f,l,y]),e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-background via-background to-muted flex items-center justify-center p-4",children:e.jsxs(Z,{className:"w-full max-w-md",children:[e.jsxs(ee,{className:"text-center",children:[e.jsx(re,{className:"text-2xl font-bold bg-gradient-to-r from-primary to-coral bg-clip-text text-transparent",children:"Appoint Panda"}),e.jsxs(te,{children:[w==="processing"&&"Completing authentication...",w==="success"&&"Authentication successful",w==="error"&&"Authentication failed"]})]}),e.jsxs(se,{className:"flex flex-col items-center gap-4",children:[w==="processing"&&e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"h-12 w-12 animate-spin text-primary"}),e.jsx("p",{className:"text-muted-foreground",children:C})]}),w==="success"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-16 w-16 rounded-full bg-teal/10 flex items-center justify-center",children:e.jsx(Q,{className:"h-10 w-10 text-teal"})}),e.jsx("p",{className:"text-foreground font-medium",children:C}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Redirecting..."})]}),w==="error"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-16 w-16 rounded-full bg-coral/10 flex items-center justify-center",children:e.jsx(ne,{className:"h-10 w-10 text-coral"})}),e.jsx("p",{className:"text-foreground font-medium",children:C}),A&&e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:A}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx(M,{variant:"outline",onClick:()=>l("/auth"),children:"Try Again"}),e.jsx(M,{onClick:()=>l("/"),children:"Go Home"})]})]})]})]})})}export{xe as default};
