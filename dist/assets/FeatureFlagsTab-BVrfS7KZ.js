import{b as A,u as F,c as E,j as e}from"./chunk-CPh6voF3.js";import{r as V}from"./chunk-CffrGP6S.js";import{i as x,B as c,m as I,Z as B,o as L,y as R,n as T,s as f,b as h}from"./index-DflORfjh.js";import{C as m,d as u,a as b,b as y}from"./chunk-Dwq_v72W.js";import{S as G}from"./chunk-DfjE-bP6.js";import{S as j}from"./chunk-CQtADEjB.js";import{c as O}from"./chunk-BSjc5zjM.js";import{F as $}from"./chunk-3oqKMbN4.js";import{I as q}from"./chunk-I1o_Hd8I.js";import{R as k}from"./chunk-BOvFDp2b.js";import{H as D}from"./chunk-C077LRJi.js";import{L as K}from"./chunk-B0x3dbdo.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-Drd-rt-S.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";import"./chunk-k8HiDHrE.js";import"./chunk-C2VW2Ml6.js";import"./chunk-CyRXX0qx.js";import"./chunk-DncHrJ4I.js";import"./chunk-CbETxTmt.js";import"./chunk-j7XJPWWF.js";import"./chunk-BaL04tya.js";import"./chunk-DbdCK11k.js";import"./chunk-GLPyMM0F.js";import"./chunk-CedtSHBb.js";import"./chunk-B7d2qnKb.js";import"./chunk-D2X27E5n.js";import"./chunk-Bl7VVhKV.js";import"./chunk-B_ghW3Ra.js";const n=[{key:"booking_engine_enabled",name:"Real-Time Booking Engine",description:"Enable slot-based calendar booking with availability rules and lock system",category:"booking",icon:I,defaultValue:!1},{key:"booking_default_on",name:"Booking Default ON",description:"New clinics have booking enabled by default. Dentists can opt-out from dashboard.",category:"booking",icon:B,defaultValue:!0},{key:"gbp_appointment_sync_enabled",name:"GBP Appointment Link Sync",description:'Sync "Book Online" button to Google Business Profiles automatically',category:"integrations",icon:K,defaultValue:!0},{key:"insurance_filter_enabled",name:"Insurance-First Search",description:"Enable insurance filtering and matching in search results",category:"search",icon:L,defaultValue:!0},{key:"ai_match_enabled",name:"AI Dentist Matching",description:"AI-powered dentist recommendations based on user needs and preferences",category:"ai",icon:R,defaultValue:!1},{key:"review_ai_summary_enabled",name:"AI Review Summaries",description:"Generate AI summaries of patient reviews for dentist profiles",category:"reviews",icon:T,defaultValue:!1}],N={booking:{label:"Booking",color:"bg-primary/20 text-primary"},search:{label:"Search",color:"bg-teal/20 text-teal"},ai:{label:"AI Features",color:"bg-purple-500/20 text-purple-500"},integrations:{label:"Integrations",color:"bg-amber/20 text-amber"},reviews:{label:"Reviews",color:"bg-coral/20 text-coral"}};function ke(){const p=A(),[v,g]=V.useState(new Set),{data:l,isLoading:w}=F({queryKey:["feature-flags"],queryFn:async()=>{const{data:a,error:t}=await f.from("global_settings").select("key, value").like("key","feature_%");if(t)throw t;const s={};return n.forEach(r=>{s[r.key]=r.defaultValue}),a?.forEach(r=>{const i=r.key.replace("feature_","");typeof r.value=="object"&&r.value!==null&&"enabled"in r.value&&(s[i]=r.value.enabled)}),s}}),o=E({mutationFn:async({key:a,enabled:t})=>{const s=`feature_${a}`,r=l?.[a]??!1,{error:i}=await f.from("global_settings").upsert({key:s,value:{enabled:t},description:n.find(d=>d.key===a)?.description,updated_at:new Date().toISOString()},{onConflict:"key"});if(i)throw i;return await O({action:"FEATURE_FLAG_TOGGLE",entityType:"feature_flag",entityId:a,oldValues:{enabled:r},newValues:{enabled:t}}),{key:a,enabled:t}},onMutate:({key:a})=>{g(t=>new Set(t).add(a))},onSuccess:({key:a,enabled:t})=>{p.invalidateQueries({queryKey:["feature-flags"]});const s=n.find(r=>r.key===a);h.success(`${s?.name} ${t?"enabled":"disabled"}`,{description:"Change logged to audit trail"})},onError:(a,{key:t})=>{h.error("Failed to update flag",{description:a.message})},onSettled:(a,t,{key:s})=>{g(r=>{const i=new Set(r);return i.delete(s),i})}}),_=(a,t)=>{o.mutate({key:a,enabled:!t})},C=n.reduce((a,t)=>(a[t.category]||(a[t.category]=[]),a[t.category].push(t),a),{});if(w)return e.jsxs("div",{className:"space-y-6",children:[e.jsx(j,{className:"h-12 w-64"}),e.jsx("div",{className:"grid md:grid-cols-2 gap-4",children:[1,2,3,4].map(a=>e.jsx(j,{className:"h-32"},a))})]});const S=Object.values(l||{}).filter(Boolean).length;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-display font-bold text-foreground flex items-center gap-3",children:[e.jsx($,{className:"h-8 w-8 text-primary"}),"Feature Flags"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Control platform features with safe rollout toggles"})]}),e.jsx("div",{className:"text-right",children:e.jsxs(x,{className:"bg-teal/20 text-teal",children:[S," / ",n.length," Active"]})})]}),e.jsx(m,{className:"bg-primary/5 border-primary/20",children:e.jsx(u,{className:"pt-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(q,{className:"h-5 w-5 text-primary shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-medium text-foreground",children:"Safe Feature Rollout"}),e.jsx("p",{className:"text-muted-foreground",children:"All new booking engine features are behind these flags. Enable them individually to test before full rollout. All changes are logged to the audit trail."})]})]})})}),e.jsx("div",{className:"grid lg:grid-cols-2 gap-6",children:Object.entries(C).map(([a,t])=>e.jsxs(m,{children:[e.jsx(b,{className:"pb-3",children:e.jsx(y,{className:"text-lg flex items-center gap-2",children:e.jsx(x,{className:N[a].color,children:N[a].label})})}),e.jsx(u,{className:"space-y-4",children:t.map(s=>{const r=s.icon,i=l?.[s.key]??s.defaultValue,d=v.has(s.key);return e.jsx("div",{className:`p-4 rounded-lg border transition-colors ${i?"bg-teal/5 border-teal/30":"bg-muted/30"}`,children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${i?"bg-teal/20":"bg-muted"}`,children:e.jsx(r,{className:`h-4 w-4 ${i?"text-teal":"text-muted-foreground"}`})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:s.description}),e.jsx("code",{className:"text-[10px] bg-muted px-1 py-0.5 rounded mt-2 inline-block",children:s.key})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[d&&e.jsx(k,{className:"h-4 w-4 animate-spin text-muted-foreground"}),e.jsx(G,{checked:i,onCheckedChange:()=>_(s.key,i),disabled:d})]})]})},s.key)})})]},a))}),e.jsxs(m,{children:[e.jsx(b,{children:e.jsx(y,{className:"text-lg",children:"Bulk Actions"})}),e.jsxs(u,{className:"flex gap-3",children:[e.jsx(c,{variant:"outline",onClick:()=>{n.forEach(a=>{l?.[a.key]||o.mutate({key:a.key,enabled:!0})})},disabled:o.isPending,children:"Enable All"}),e.jsx(c,{variant:"outline",onClick:()=>{n.forEach(a=>{l?.[a.key]&&o.mutate({key:a.key,enabled:!1})})},disabled:o.isPending,children:"Disable All"}),e.jsxs(c,{variant:"ghost",onClick:()=>p.invalidateQueries({queryKey:["feature-flags"]}),children:[e.jsx(k,{className:"h-4 w-4 mr-2"}),"Refresh"]})]})]}),e.jsx(m,{className:"border-dashed",children:e.jsx(u,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(D,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:"View Change History"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"All flag changes are logged in Audit Logs"})]})]}),e.jsx(c,{variant:"outline",size:"sm",asChild:!0,children:e.jsx("a",{href:"/admin?tab=audit",children:"View Audit Logs"})})]})})})]})}export{ke as default};
