import{j as e}from"./chunk-CPh6voF3.js";import{r as i}from"./chunk-CffrGP6S.js";import{C as f,d as j,a as C,b as I,c as L}from"./chunk-Dwq_v72W.js";import{s as v,B as m,bA as A,bC as T,L as E,i as B,S as H,b as R}from"./index-DflORfjh.js";import{P as M}from"./chunk-DSDQubI6.js";import{D as w}from"./chunk-CedtSHBb.js";import{R as z}from"./chunk-BOvFDp2b.js";import{C as F}from"./chunk-wy0nNZZG.js";import{C as S}from"./chunk-f2aNMA4v.js";import{T as G}from"./chunk-DbdCK11k.js";import{C as X}from"./chunk-CbEmr7WL.js";import{R as Z}from"./chunk-3oqKMbN4.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-Drd-rt-S.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";import"./chunk-BSjc5zjM.js";import"./chunk-k8HiDHrE.js";import"./chunk-C2VW2Ml6.js";import"./chunk-I1o_Hd8I.js";import"./chunk-CyRXX0qx.js";import"./chunk-DncHrJ4I.js";import"./chunk-CbETxTmt.js";import"./chunk-j7XJPWWF.js";import"./chunk-BaL04tya.js";import"./chunk-GLPyMM0F.js";import"./chunk-B7d2qnKb.js";import"./chunk-D2X27E5n.js";import"./chunk-Bl7VVhKV.js";import"./chunk-B_ghW3Ra.js";const p=10;function Ce(){const[r,o]=i.useState({phase:"idle",totalPlaceIds:0,alreadyRestored:0,remaining:0,placeIds:[],batchIndex:0,imported:0,skipped:0,errors:0,errorDetails:[],logs:[]}),[x,k]=i.useState(null),[b,N]=i.useState(!1),d=i.useRef(!1),g=i.useRef(!1),l=i.useCallback(s=>{o(a=>({...a,logs:[`[${new Date().toLocaleTimeString()}] ${s}`,...a.logs.slice(0,499)]}))},[]),u=i.useCallback(async()=>{N(!0);try{const{data:s}=await v.functions.invoke("recover-clinics",{body:{action:"status"}});s?.counts&&k(s.counts)}catch{}N(!1)},[]);i.useEffect(()=>{u()},[u]);const P=async()=>{o(s=>({...s,phase:"loading"})),l("Scanning audit logs for recoverable Place IDs...");try{const{data:s,error:a}=await v.functions.invoke("recover-clinics",{body:{action:"get-place-ids"}});if(a)throw a;o(c=>({...c,phase:"idle",totalPlaceIds:s.total_place_ids,alreadyRestored:s.already_restored,remaining:s.remaining,placeIds:s.place_ids,batchIndex:0,imported:0,skipped:0,errors:0,errorDetails:[]})),l(`Found ${s.total_place_ids} total Place IDs. ${s.already_restored} already restored. ${s.remaining} remaining.`)}catch(s){o(a=>({...a,phase:"error"})),l(`Error loading place IDs: ${s.message}`),R.error("Failed to load place IDs")}},D=async()=>{if(g.current)return;g.current=!0,d.current=!1,o(c=>({...c,phase:"recovering"})),l("ðŸš€ Starting recovery...");let s=r.batchIndex;const a=r.placeIds;for(;s<a.length&&!d.current;){const c=a.slice(s,s+p);l(`Processing batch ${Math.floor(s/p)+1} (${s+1}â€“${Math.min(s+p,a.length)} of ${a.length})...`);try{const{data:t,error:h}=await v.functions.invoke("recover-clinics",{body:{action:"recover-batch",placeIds:c}});if(h)throw h;o(n=>({...n,batchIndex:s+p,imported:n.imported+(t.imported||0),skipped:n.skipped+(t.skipped||0),errors:n.errors+(t.errors||0),errorDetails:[...n.errorDetails,...t.error_details||[]].slice(-100)})),l(`âœ… Batch done: ${t.imported} imported, ${t.skipped} skipped, ${t.errors} errors`),t.error_details?.length&&t.error_details.forEach(n=>l(`  âš ï¸ ${n}`))}catch(t){l(`âŒ Batch error: ${t.message}`),o(h=>({...h,errors:h.errors+c.length}))}s+=p,!d.current&&s<a.length&&await new Promise(t=>setTimeout(t,500))}g.current=!1,d.current?(o(c=>({...c,phase:"paused",batchIndex:s})),l("â¸ï¸ Recovery paused by user.")):(o(c=>({...c,phase:"done",batchIndex:s})),l("ðŸŽ‰ Recovery complete!"),R.success("Recovery complete!"),u())},$=()=>{d.current=!0,l("Pausing after current batch...")},_=()=>{g.current=!1,d.current=!1,o({phase:"idle",totalPlaceIds:0,alreadyRestored:0,remaining:0,placeIds:[],batchIndex:0,imported:0,skipped:0,errors:0,errorDetails:[],logs:[]}),l("Reset complete.")},y=r.placeIds.length>0?Math.round(r.batchIndex/r.placeIds.length*100):0;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(w,{className:"h-6 w-6 text-primary"}),"Data Recovery Center"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Recover deleted clinics, reviews, and hours from Google Places API using audit log records."})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[[{label:"Clinics",value:x?.clinics??"â€”",icon:"ðŸ¥"},{label:"Hours",value:x?.clinic_hours??"â€”",icon:"ðŸ•"},{label:"Reviews",value:x?.google_reviews??"â€”",icon:"â­"},{label:"Dentists",value:x?.dentists??"â€”",icon:"ðŸ¦·"}].map(s=>e.jsx(f,{children:e.jsxs(j,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl mb-1",children:s.icon}),e.jsx("div",{className:"text-2xl font-bold",children:typeof s.value=="number"?s.value.toLocaleString():s.value}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.label})]})},s.label)),e.jsx("div",{className:"col-span-2 md:col-span-4 flex justify-end",children:e.jsxs(m,{variant:"ghost",size:"sm",onClick:u,disabled:b,children:[e.jsx(z,{className:`h-4 w-4 mr-1 ${b?"animate-spin":""}`}),"Refresh Counts"]})})]}),e.jsxs(f,{children:[e.jsxs(C,{children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-5 w-5"}),"Recovery Engine"]}),e.jsxs(L,{children:["Step 1: Scan audit logs â†’ Step 2: Start recovery â†’ Clinics are re-imported from Google in batches of ",p,"."]})]}),e.jsxs(j,{className:"space-y-4",children:[r.totalPlaceIds>0&&e.jsxs("div",{className:"grid grid-cols-3 gap-3 text-center",children:[e.jsxs("div",{className:"p-3 rounded-lg bg-muted/50",children:[e.jsx("div",{className:"text-lg font-bold",children:r.totalPlaceIds.toLocaleString()}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Total Place IDs"})]}),e.jsxs("div",{className:"p-3 rounded-lg bg-muted/50",children:[e.jsx("div",{className:"text-lg font-bold text-green-600",children:r.alreadyRestored.toLocaleString()}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Already Restored"})]}),e.jsxs("div",{className:"p-3 rounded-lg bg-muted/50",children:[e.jsx("div",{className:"text-lg font-bold text-orange-600",children:r.remaining.toLocaleString()}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Remaining"})]})]}),r.phase!=="idle"&&r.placeIds.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{children:["Progress: ",r.batchIndex," / ",r.placeIds.length]}),e.jsxs("span",{children:[y,"%"]})]}),e.jsx(M,{value:y,className:"h-3"}),e.jsxs("div",{className:"flex gap-4 text-sm",children:[e.jsxs("span",{className:"flex items-center gap-1 text-green-600",children:[e.jsx(S,{className:"h-3.5 w-3.5"})," ",r.imported," imported"]}),e.jsxs("span",{className:"flex items-center gap-1 text-yellow-600",children:[e.jsx(G,{className:"h-3.5 w-3.5"})," ",r.skipped," skipped"]}),e.jsxs("span",{className:"flex items-center gap-1 text-red-600",children:[e.jsx(X,{className:"h-3.5 w-3.5"})," ",r.errors," errors"]})]})]}),e.jsxs("div",{className:"flex gap-3 flex-wrap",children:[r.phase==="idle"&&r.placeIds.length===0&&e.jsxs(m,{onClick:P,children:[e.jsx(w,{className:"h-4 w-4 mr-2"}),"Step 1: Scan Audit Logs"]}),(r.phase==="idle"||r.phase==="paused")&&r.placeIds.length>0&&r.batchIndex<r.placeIds.length&&e.jsxs(m,{onClick:D,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(A,{className:"h-4 w-4 mr-2"}),r.phase==="paused"?"Resume Recovery":"Step 2: Start Recovery"]}),r.phase==="recovering"&&e.jsxs(m,{variant:"outline",onClick:$,children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Pause"]}),r.phase==="loading"&&e.jsxs(m,{disabled:!0,children:[e.jsx(E,{className:"h-4 w-4 mr-2 animate-spin"}),"Scanning..."]}),r.phase==="done"&&e.jsxs(B,{variant:"default",className:"bg-green-600 text-white text-sm px-4 py-2",children:[e.jsx(S,{className:"h-4 w-4 mr-2"}),"Recovery Complete â€” ",r.imported," clinics restored"]}),e.jsxs(m,{variant:"ghost",size:"sm",onClick:_,children:[e.jsx(Z,{className:"h-4 w-4 mr-1"}),"Reset"]})]})]})]}),e.jsxs(f,{children:[e.jsx(C,{children:e.jsx(I,{className:"text-base",children:"Recovery Log"})}),e.jsx(j,{children:e.jsx(H,{className:"h-64 rounded-lg border bg-muted/30 p-3",children:r.logs.length===0?e.jsx("p",{className:"text-muted-foreground text-sm italic",children:'No activity yet. Click "Scan Audit Logs" to begin.'}):e.jsx("div",{className:"space-y-1 font-mono text-xs",children:r.logs.map((s,a)=>e.jsx("div",{className:"text-muted-foreground",children:s},a))})})})]})]})}export{Ce as default};
