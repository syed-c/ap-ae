import{u as oe,b as xe,c as me,j as e}from"./chunk-CPh6voF3.js";import{r as p}from"./chunk-CffrGP6S.js";import{s as S,b as L,t as H,P as f,C as h,p as he,I as ue,a2 as T,a3 as M,a5 as k,a6 as F,a7 as a,w as I,i as o,A as P,x as K,Q as J,B as g,a9 as X,aa as W,ab as Y,ac as Z,a as je,al as pe,ad as ge,G as Ne,v as fe,ae as ve,L as we}from"./index-DflORfjh.js";import{c as ye}from"./chunk-BSjc5zjM.js";import{C as x,d as m}from"./chunk-Dwq_v72W.js";import{T as $,a as ee,b as v,c as i,d as se,e as n}from"./chunk-NLs5Ye4A.js";import{U as ae}from"./chunk-D2X27E5n.js";import{C as te}from"./chunk-CbEmr7WL.js";import{B}from"./chunk-CFYlT1Dp.js";import{M as re}from"./chunk-B7d2qnKb.js";import{T as be}from"./chunk-DbdCK11k.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-Drd-rt-S.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";function Ce(t={}){return oe({queryKey:["admin-leads",t],queryFn:async()=>{let l=S.from("leads").select("*, clinic:clinics(id, name), treatment:treatments(id, name)").order("created_at",{ascending:!1});t.status&&(l=l.eq("status",t.status)),t.clinicId&&(l=l.eq("clinic_id",t.clinicId)),t.source&&(l=l.eq("source",t.source));const{data:c,error:u}=await l.limit(100);if(u)throw u;return c||[]}})}function Se(){const t=xe();return me({mutationFn:async({id:l,updates:c})=>{const{data:u}=await S.from("leads").select("*").eq("id",l).single(),w={...c};c.status==="contacted"&&(w.contacted_at=new Date().toISOString());const{error:j}=await S.from("leads").update(w).eq("id",l);if(j)throw j;await ye({action:"UPDATE",entityType:"lead",entityId:l,oldValues:u,newValues:c})},onSuccess:()=>{t.invalidateQueries({queryKey:["admin-leads"]}),L.success("Lead updated")},onError:l=>L.error("Failed: "+l.message)})}function Oe(){const[t,l]=p.useState({status:"",search:""}),{data:c,isLoading:u,refetch:w}=Ce({status:t.status||void 0}),j=Se(),[le,A]=p.useState(!1),[ne,y]=p.useState(!1),[d,b]=p.useState(null),[Q,U]=p.useState(""),[q,E]=p.useState(!1),R=async(s,r)=>{await j.mutateAsync({id:s,updates:{status:r}})},ie=async()=>{d&&(await j.mutateAsync({id:d.id,updates:{message:Q}}),A(!1),b(null))},V=s=>{b(s),U(s.message||""),A(!0)},ce=s=>{b(s),y(!0)},de=async()=>{if(d){E(!0);try{const{data:s,error:r}=await S.functions.invoke("approve-listing",{body:{leadId:d.id}});if(r)throw r;if(s?.success)L.success("Listing approved! User account created and notifications sent."),y(!1),b(null),w();else throw new Error(s?.error||"Failed to approve listing")}catch(s){console.error("Approve listing error:",s),L.error(s.message||"Failed to approve listing")}finally{E(!1)}}},O=s=>{if(!s)return null;try{const r=JSON.parse(s);return r.type==="practice_listing"?r:null}catch{return null}},z=s=>{switch(s){case"contacted":return e.jsxs(o,{className:"bg-blue-custom text-blue-custom-foreground",children:[e.jsx(f,{className:"h-3 w-3 mr-1"}),"Contacted"]});case"qualified":return e.jsxs(o,{className:"bg-gold text-gold-foreground",children:[e.jsx(h,{className:"h-3 w-3 mr-1"}),"Qualified"]});case"converted":return e.jsxs(o,{className:"bg-primary text-primary-foreground",children:[e.jsx(h,{className:"h-3 w-3 mr-1"}),"Converted"]});case"lost":return e.jsxs(o,{variant:"secondary",children:[e.jsx(te,{className:"h-3 w-3 mr-1"}),"Lost"]});case"spam":return e.jsxs(o,{variant:"destructive",children:[e.jsx(be,{className:"h-3 w-3 mr-1"}),"Spam"]});default:return e.jsxs(o,{variant:"outline",className:"text-gold border-gold",children:[e.jsx(H,{className:"h-3 w-3 mr-1"}),"New"]})}},N={new:c?.filter(s=>s.status==="new").length||0,contacted:c?.filter(s=>s.status==="contacted").length||0,qualified:c?.filter(s=>s.status==="qualified").length||0,converted:c?.filter(s=>s.status==="converted").length||0,lost:c?.filter(s=>s.status==="lost").length||0},G=c?.filter(s=>s.patient_name?.toLowerCase().includes(t.search.toLowerCase())||s.patient_phone?.includes(t.search)||s.patient_email?.toLowerCase().includes(t.search.toLowerCase()))||[],C=G.filter(s=>s.source==="list-your-practice"),_=G.filter(s=>s.source!=="list-your-practice");return u?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-display font-bold text-foreground",children:"Lead CRM"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage leads, listing requests, and track conversions"})]}),e.jsxs("div",{className:"grid grid-cols-5 gap-4",children:[e.jsx(x,{className:"card-modern",children:e.jsxs(m,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-gold-light flex items-center justify-center",children:e.jsx(H,{className:"h-6 w-6 text-gold"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:N.new}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"New"})]})]})}),e.jsx(x,{className:"card-modern",children:e.jsxs(m,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-blue-light flex items-center justify-center",children:e.jsx(f,{className:"h-6 w-6 text-blue-custom"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:N.contacted}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Contacted"})]})]})}),e.jsx(x,{className:"card-modern",children:e.jsxs(m,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-purple-light flex items-center justify-center",children:e.jsx(h,{className:"h-6 w-6 text-purple"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:N.qualified}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Qualified"})]})]})}),e.jsx(x,{className:"card-modern",children:e.jsxs(m,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(ae,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:N.converted}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Converted"})]})]})}),e.jsx(x,{className:"card-modern",children:e.jsxs(m,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-coral-light flex items-center justify-center",children:e.jsx(te,{className:"h-6 w-6 text-coral"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:N.lost}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Lost"})]})]})})]}),e.jsx(x,{className:"card-modern",children:e.jsx(m,{className:"p-4",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(he,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ue,{placeholder:"Search by name, phone, or email...",value:t.search,onChange:s=>l({...t,search:s.target.value}),className:"pl-10"})]}),e.jsxs(T,{value:t.status,onValueChange:s=>l({...t,status:s==="all"?"":s}),children:[e.jsx(M,{className:"w-48",children:e.jsx(k,{placeholder:"All Statuses"})}),e.jsxs(F,{children:[e.jsx(a,{value:"all",children:"All Statuses"}),e.jsx(a,{value:"new",children:"New"}),e.jsx(a,{value:"contacted",children:"Contacted"}),e.jsx(a,{value:"qualified",children:"Qualified"}),e.jsx(a,{value:"converted",children:"Converted"}),e.jsx(a,{value:"lost",children:"Lost"}),e.jsx(a,{value:"spam",children:"Spam"})]})]})]})})}),C.length>0&&e.jsx(x,{className:"card-modern border-primary/30",children:e.jsxs(m,{className:"p-0",children:[e.jsxs("div",{className:"p-4 border-b bg-primary/5",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-5 w-5 text-primary"}),e.jsx("h2",{className:"font-bold text-lg",children:"Practice Listing Requests"}),e.jsx(o,{variant:"secondary",children:C.length})]}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Review and approve new practice listings"})]}),e.jsxs($,{children:[e.jsx(ee,{children:e.jsxs(v,{children:[e.jsx(i,{children:"Practice"}),e.jsx(i,{children:"Contact"}),e.jsx(i,{children:"Location"}),e.jsx(i,{children:"Status"}),e.jsx(i,{children:"Submitted"}),e.jsx(i,{className:"text-right",children:"Actions"})]})}),e.jsx(se,{children:C.map(s=>{const r=O(s.message);return e.jsxs(v,{children:[e.jsx(n,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-bold",children:r?.clinicName||s.patient_name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:r?.dentistName||"Unknown"})]})}),e.jsx(n,{children:e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground",children:[e.jsx(f,{className:"h-3 w-3"}),s.patient_phone]}),s.patient_email&&e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground",children:[e.jsx(P,{className:"h-3 w-3"}),s.patient_email]})]})}),e.jsx(n,{children:e.jsx("div",{className:"text-sm",children:r?.city&&r?.state?e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground",children:[e.jsx(K,{className:"h-3 w-3"}),r.city,", ",r.state]}):e.jsx("span",{className:"text-muted-foreground",children:"-"})})}),e.jsx(n,{children:z(s.status||"new")}),e.jsx(n,{className:"text-muted-foreground",children:s.created_at?J(new Date(s.created_at),"MMM d, yyyy"):"-"}),e.jsx(n,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[s.status!=="converted"&&e.jsxs(g,{size:"sm",className:"bg-primary hover:bg-primary/90",onClick:()=>ce(s),children:[e.jsx(B,{className:"h-4 w-4 mr-1"}),"Approve"]}),e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>V(s),children:e.jsx(re,{className:"h-4 w-4"})}),e.jsxs(T,{value:s.status||"new",onValueChange:D=>R(s.id,D),children:[e.jsx(M,{className:"w-28",children:e.jsx(k,{})}),e.jsxs(F,{children:[e.jsx(a,{value:"new",children:"New"}),e.jsx(a,{value:"contacted",children:"Contacted"}),e.jsx(a,{value:"qualified",children:"Qualified"}),e.jsx(a,{value:"converted",children:"Converted"}),e.jsx(a,{value:"lost",children:"Lost"}),e.jsx(a,{value:"spam",children:"Spam"})]})]})]})})]},s.id)})})]})]})}),e.jsx(x,{className:"card-modern",children:e.jsxs(m,{className:"p-0",children:[_.length>0&&e.jsxs("div",{className:"p-4 border-b",children:[e.jsx("h2",{className:"font-bold text-lg",children:"General Leads"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Patient inquiries and booking requests"})]}),e.jsxs($,{children:[e.jsx(ee,{children:e.jsxs(v,{children:[e.jsx(i,{children:"Lead"}),e.jsx(i,{children:"Contact"}),e.jsx(i,{children:"Clinic"}),e.jsx(i,{children:"Source"}),e.jsx(i,{children:"Status"}),e.jsx(i,{children:"Created"}),e.jsx(i,{className:"text-right",children:"Actions"})]})}),e.jsxs(se,{children:[_.map(s=>e.jsxs(v,{children:[e.jsxs(n,{children:[e.jsx("div",{className:"font-medium",children:s.patient_name}),s.message&&e.jsx("p",{className:"text-xs text-muted-foreground truncate max-w-48",children:s.message})]}),e.jsx(n,{children:e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground",children:[e.jsx(f,{className:"h-3 w-3"}),s.patient_phone]}),s.patient_email&&e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground",children:[e.jsx(P,{className:"h-3 w-3"}),s.patient_email]})]})}),e.jsx(n,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-4 w-4 text-muted-foreground"}),s.clinic?.name||"-"]})}),e.jsx(n,{children:e.jsx(o,{variant:"outline",children:s.source||"website"})}),e.jsx(n,{children:z(s.status||"new")}),e.jsx(n,{className:"text-muted-foreground",children:s.created_at?J(new Date(s.created_at),"MMM d, yyyy"):"-"}),e.jsx(n,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>V(s),children:e.jsx(re,{className:"h-4 w-4"})}),e.jsxs(T,{value:s.status||"new",onValueChange:r=>R(s.id,r),children:[e.jsx(M,{className:"w-32",children:e.jsx(k,{})}),e.jsxs(F,{children:[e.jsx(a,{value:"new",children:"New"}),e.jsx(a,{value:"contacted",children:"Contacted"}),e.jsx(a,{value:"qualified",children:"Qualified"}),e.jsx(a,{value:"converted",children:"Converted"}),e.jsx(a,{value:"lost",children:"Lost"}),e.jsx(a,{value:"spam",children:"Spam"})]})]})]})})]},s.id)),_.length===0&&C.length===0&&e.jsx(v,{children:e.jsxs(n,{colSpan:7,className:"text-center py-8 text-muted-foreground",children:[e.jsx(ae,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No leads found"})]})})]})]})]})}),e.jsx(X,{open:le,onOpenChange:A,children:e.jsxs(W,{children:[e.jsx(Y,{children:e.jsxs(Z,{children:["Lead Notes - ",d?.patient_name]})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(je,{children:"Internal Notes / Message"}),e.jsx(pe,{value:Q,onChange:s=>U(s.target.value),placeholder:"Add notes about this lead...",rows:6})]}),e.jsx(g,{onClick:ie,className:"w-full",disabled:j.isPending,children:"Save Notes"})]})]})}),e.jsx(X,{open:ne,onOpenChange:y,children:e.jsxs(W,{className:"max-w-lg",children:[e.jsxs(Y,{children:[e.jsxs(Z,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-5 w-5 text-primary"}),"Approve Practice Listing"]}),e.jsx(ge,{children:"This will create a user account for the dentist and activate their listing."})]}),d&&e.jsx("div",{className:"py-4 space-y-4",children:(()=>{const s=O(d.message);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 rounded-xl bg-muted/50 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(I,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold",children:s?.clinicName||d.patient_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s?.dentistName})]})]}),s?.city&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(K,{className:"h-4 w-4"}),s.city,", ",s.state]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(P,{className:"h-4 w-4"}),d.patient_email]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(f,{className:"h-4 w-4"}),d.patient_phone]}),s?.website&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Ne,{className:"h-4 w-4"}),s.website]}),s?.services?.length>0&&e.jsxs("div",{className:"flex items-start gap-2 text-sm",children:[e.jsx(fe,{className:"h-4 w-4 text-muted-foreground mt-0.5"}),e.jsxs("div",{className:"flex flex-wrap gap-1",children:[s.services.slice(0,5).map((r,D)=>e.jsx(o,{variant:"secondary",className:"text-xs",children:r},D)),s.services.length>5&&e.jsxs(o,{variant:"outline",className:"text-xs",children:["+",s.services.length-5," more"]})]})]})]}),e.jsxs("div",{className:"p-4 rounded-xl bg-primary/5 border border-primary/20",children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Upon Approval:"}),e.jsxs("ul",{className:"text-sm space-y-1 text-muted-foreground",children:[e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(h,{className:"h-4 w-4 text-primary"}),"User account created with temporary password"]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(h,{className:"h-4 w-4 text-primary"}),"Email sent with login credentials"]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(h,{className:"h-4 w-4 text-primary"}),"SMS confirmation sent to phone"]}),e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx(h,{className:"h-4 w-4 text-primary"}),"Clinic profile created and linked"]})]})]})]})})()}),e.jsxs(ve,{children:[e.jsx(g,{variant:"outline",onClick:()=>y(!1),disabled:q,children:"Cancel"}),e.jsx(g,{onClick:de,disabled:q,children:q?e.jsxs(e.Fragment,{children:[e.jsx(we,{className:"h-4 w-4 mr-2 animate-spin"}),"Approving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),"Approve & Create Account"]})})]})]})})]})}export{Oe as default};
