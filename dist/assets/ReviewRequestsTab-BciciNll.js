import{b as Ne,u as M,c as ve,j as e}from"./chunk-CPh6voF3.js";import{r as m}from"./chunk-CffrGP6S.js";import{u as we,s as w,q as be,B as x,b as h,C as u,U as b,I as R,$ as j,a9 as V,bc as G,aa as K,ab as Q,ac as z,ad as I,a as p,a2 as X,a3 as Y,a5 as J,a6 as Z,a7 as y,i as d,b7 as ee,P as ye,Q as se,t as Ce}from"./index-DflORfjh.js";import{a as ke}from"./chunk-Dq1MrkKO.js";import{C as n,d as l,a as ae,b as te,c as Se}from"./chunk-Dwq_v72W.js";import{T as ie,a as ne,b as C,c as r,d as le,e as c}from"./chunk-NLs5Ye4A.js";import{S as T}from"./chunk-CQtADEjB.js";import{M as D}from"./chunk-B7d2qnKb.js";import{C as _e}from"./chunk-j7XJPWWF.js";import{P as Pe}from"./chunk-HAC-i_a2.js";import{C as qe}from"./chunk-CbEmr7WL.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-Drd-rt-S.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";function Qe(){const{user:k}=we(),re=Ne(),[i,S]=m.useState([]),[_,L]=m.useState("sms"),[ce,H]=m.useState(!1),[g,F]=m.useState(""),[A,W]=m.useState(""),[de,$]=m.useState(!1),[B,O]=m.useState(!1),{data:t,isLoading:oe}=M({queryKey:["dentist-clinic",k?.id],queryFn:async()=>{const{data:s,error:a}=await w.from("clinics").select("id, name, slug, google_place_id").eq("claimed_by",k?.id).limit(1).single();if(a&&a.code!=="PGRST116")throw a;return s},enabled:!!k?.id}),{data:o=[],isLoading:me}=M({queryKey:["clinic-patients-for-review",t?.id],queryFn:async()=>{const{data:s,error:a}=await w.from("patients").select("id, name, phone, email, last_visit_at, is_opted_in_sms, is_opted_in_whatsapp").eq("clinic_id",t.id).eq("is_opted_in_sms",!0).order("last_visit_at",{ascending:!1}).limit(100);if(a)throw a;return s||[]},enabled:!!t?.id}),{data:f=[]}=M({queryKey:["review-requests",t?.id],queryFn:async()=>{const{data:s,error:a}=await w.from("review_requests").select("*").eq("clinic_id",t.id).order("created_at",{ascending:!1}).limit(50);if(a)throw a;return s||[]},enabled:!!t?.id}),N=ve({mutationFn:async s=>{if(!t)throw new Error("No clinic");const a=`${window.location.origin}/review/${t.id}/`,P=`Hi! Thanks for visiting ${t.name}. We'd love to hear your feedback! Please take a moment to share your experience: ${a}`,E=s.map(q=>({clinic_id:t.id,patient_id:q.patient_id||null,recipient_name:q.name,recipient_phone:q.phone,channel:_,template_type:"review_request",message_content:P,status:"pending"})),{error:U}=await w.from("review_requests").insert(E);if(U)throw U;return E.length},onSuccess:s=>{re.invalidateQueries({queryKey:["review-requests"]}),h.success(`${s} review request(s) queued for sending`),S([]),$(!1)},onError:s=>h.error("Failed to send: "+s.message)}),xe=s=>{S(a=>a.includes(s)?a.filter(P=>P!==s):[...a,s])},he=()=>{const s=o.filter(a=>i.includes(a.id)).map(a=>({name:a.name,phone:a.phone,patient_id:a.id}));N.mutate(s)},ue=()=>{if(!g.trim()){h.error("Phone number is required");return}N.mutate([{name:A.trim()||"Patient",phone:g.trim()}]),H(!1),F(""),W("")},je=s=>{switch(s){case"sent":case"delivered":return e.jsxs(d,{className:"bg-teal/10 text-teal border-teal/20",children:[e.jsx(u,{className:"h-3 w-3 mr-1"})," Sent"]});case"failed":return e.jsxs(d,{variant:"destructive",children:[e.jsx(qe,{className:"h-3 w-3 mr-1"})," Failed"]});default:return e.jsxs(d,{variant:"outline",children:[e.jsx(Ce,{className:"h-3 w-3 mr-1"})," Pending"]})}},{hasAccess:pe,isLoading:ge}=ke(t?.id,"review_manager");if(oe||ge)return e.jsxs("div",{className:"space-y-4",children:[e.jsx(T,{className:"h-32"}),e.jsx(T,{className:"h-64"})]});if(!t)return e.jsx(n,{className:"card-modern",children:e.jsxs(l,{className:"text-center py-12",children:[e.jsx(D,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold mb-2",children:"No Practice Linked"}),e.jsx("p",{className:"text-muted-foreground",children:"Claim your practice profile to send review requests."})]})});if(!pe)return e.jsx(n,{className:"card-modern border-amber-200 bg-amber-50/50",children:e.jsxs(l,{className:"text-center py-16",children:[e.jsx("div",{className:"h-20 w-20 rounded-full bg-amber-100 flex items-center justify-center mx-auto mb-6",children:e.jsx(be,{className:"h-10 w-10 text-amber-600"})}),e.jsx("h2",{className:"text-2xl font-bold mb-3",children:"Upgrade to Unlock Review Manager"}),e.jsxs("p",{className:"text-muted-foreground max-w-md mx-auto mb-6",children:["Send review requests to patients, collect feedback, and boost your Google reviews. Upgrade to the ",e.jsx("span",{className:"font-semibold text-amber-700",children:"Verified"})," or ",e.jsx("span",{className:"font-semibold text-primary",children:"Pro"})," plan to unlock this feature."]}),e.jsx("div",{className:"flex flex-col sm:flex-row gap-3 justify-center",children:e.jsxs(x,{className:"bg-amber-600 hover:bg-amber-700",onClick:()=>h.info("Payment gateway not connected. Please contact administrator to upgrade your plan."),children:[e.jsx(_e,{className:"h-4 w-4 mr-2"}),"Upgrade Now"]})}),e.jsxs("div",{className:"mt-8 grid grid-cols-1 sm:grid-cols-3 gap-4 max-w-2xl mx-auto text-left",children:[e.jsxs("div",{className:"p-4 rounded-xl bg-background border",children:[e.jsx(D,{className:"h-6 w-6 text-teal mb-2"}),e.jsx("h4",{className:"font-semibold text-sm",children:"Collect Reviews"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Send personalized requests via SMS/WhatsApp"})]}),e.jsxs("div",{className:"p-4 rounded-xl bg-background border",children:[e.jsx(u,{className:"h-6 w-6 text-green-600 mb-2"}),e.jsx("h4",{className:"font-semibold text-sm",children:"Filter Feedback"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Happy → Google, unhappy → private feedback"})]}),e.jsxs("div",{className:"p-4 rounded-xl bg-background border",children:[e.jsx(b,{className:"h-6 w-6 text-primary mb-2"}),e.jsx("h4",{className:"font-semibold text-sm",children:"Patient Selection"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Choose from your patient list or add manually"})]})]})]})});const v=`${window.location.origin}/review/${t.id}/`,fe=async()=>{try{await navigator.clipboard.writeText(v),O(!0),h.success("Review link copied to clipboard"),setTimeout(()=>O(!1),2e3)}catch{h.error("Failed to copy link")}};return e.jsxs("div",{className:"space-y-6",children:[e.jsx(n,{className:"card-modern border-primary/20 bg-primary/5",children:e.jsx(l,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-display font-bold text-lg",children:"Your Review Collection Link"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Share this link with patients to collect reviews. Happy patients go to Google, unhappy patients give private feedback."})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[e.jsx(R,{value:v,readOnly:!0,className:"w-72 bg-background text-sm"}),e.jsx(x,{onClick:fe,variant:B?"default":"outline",children:B?e.jsx(u,{className:"h-4 w-4"}):e.jsx(j,{className:"h-4 w-4"})})]})]})})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-display font-bold",children:"Request Reviews"}),e.jsx("p",{className:"text-muted-foreground",children:"Send review requests to patients via SMS or WhatsApp"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(V,{open:ce,onOpenChange:H,children:[e.jsx(G,{asChild:!0,children:e.jsxs(x,{variant:"outline",children:[e.jsx(Pe,{className:"h-4 w-4 mr-2"}),"Add Manually"]})}),e.jsxs(K,{className:"max-w-lg",children:[e.jsxs(Q,{children:[e.jsx(z,{children:"Add Recipient Manually"}),e.jsx(I,{children:"Enter the phone number to send a review request"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{children:[e.jsx(p,{children:"Name (optional)"}),e.jsx(R,{value:A,onChange:s=>W(s.target.value),placeholder:"Patient name"})]}),e.jsxs("div",{children:[e.jsx(p,{children:"Phone Number *"}),e.jsx(R,{value:g,onChange:s=>F(s.target.value),placeholder:"+971 50 123 4567"})]}),e.jsxs("div",{children:[e.jsx(p,{children:"Channel"}),e.jsxs(X,{value:_,onValueChange:s=>L(s),children:[e.jsx(Y,{children:e.jsx(J,{})}),e.jsxs(Z,{children:[e.jsx(y,{value:"sms",children:"SMS"}),e.jsx(y,{value:"whatsapp",children:"WhatsApp"})]})]})]}),g.trim()&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs(p,{className:"flex items-center gap-2 text-teal",children:[e.jsx(u,{className:"h-4 w-4"}),"Message Preview"]}),e.jsx(n,{className:"bg-teal/5 border-teal/20",children:e.jsx(l,{className:"p-3 text-sm",children:e.jsxs("p",{className:"text-muted-foreground",children:["Hi! Thanks for visiting ",t.name,". We'd love to hear your feedback! Please take a moment to share your experience: ",e.jsx("span",{className:"text-primary",children:v})]})})})]}),e.jsxs(x,{onClick:ue,disabled:N.isPending||!g.trim(),className:"w-full",children:[e.jsx(j,{className:"h-4 w-4 mr-2"}),"Send Request"]})]})]})]}),e.jsxs(V,{open:de,onOpenChange:$,children:[e.jsx(G,{asChild:!0,children:e.jsxs(x,{disabled:i.length===0,children:[e.jsx(j,{className:"h-4 w-4 mr-2"}),"Send to Selected (",i.length,")"]})}),e.jsxs(K,{className:"max-w-lg",children:[e.jsxs(Q,{children:[e.jsx(z,{children:"Preview & Confirm"}),e.jsxs(I,{children:["Review the message before sending to ",i.length," patient(s)"]})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{children:[e.jsx(p,{children:"Channel"}),e.jsxs(X,{value:_,onValueChange:s=>L(s),children:[e.jsx(Y,{children:e.jsx(J,{})}),e.jsxs(Z,{children:[e.jsx(y,{value:"sms",children:"SMS"}),e.jsx(y,{value:"whatsapp",children:"WhatsApp"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(u,{className:"h-4 w-4 text-teal"}),"Message Preview"]}),e.jsx(n,{className:"bg-teal/5 border-teal/20",children:e.jsx(l,{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"h-8 w-8 rounded-full bg-teal/20 flex items-center justify-center flex-shrink-0",children:e.jsx(D,{className:"h-4 w-4 text-teal"})}),e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsxs("p",{className:"font-medium text-foreground",children:["Hi! Thanks for visiting ",t.name,"."]}),e.jsx("p",{className:"text-muted-foreground",children:"We'd love to hear your feedback! Please take a moment to share your experience:"}),e.jsx("div",{className:"bg-background rounded-lg p-2 border",children:e.jsx("p",{className:"text-xs text-primary break-all",children:v})})]})]})})})]}),e.jsxs("div",{className:"bg-muted/50 rounded-lg p-3 space-y-2",children:[e.jsxs("p",{className:"text-sm font-medium",children:["Recipients (",i.length,")"]}),e.jsxs("div",{className:"flex flex-wrap gap-1 max-h-20 overflow-auto",children:[o.filter(s=>i.includes(s.id)).slice(0,10).map(s=>e.jsx(d,{variant:"secondary",className:"text-xs",children:s.name},s.id)),i.length>10&&e.jsxs(d,{variant:"outline",className:"text-xs",children:["+",i.length-10," more"]})]})]}),e.jsxs(x,{onClick:he,disabled:N.isPending,className:"w-full",children:[e.jsx(j,{className:"h-4 w-4 mr-2"}),"Confirm & Send to ",i.length," Patient(s)"]})]})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(n,{className:"card-modern",children:e.jsxs(l,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(j,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:f.length}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Sent"})]})]})}),e.jsx(n,{className:"card-modern",children:e.jsxs(l,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-teal-light flex items-center justify-center",children:e.jsx(u,{className:"h-6 w-6 text-teal"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:f.filter(s=>s.status==="delivered").length}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Delivered"})]})]})}),e.jsx(n,{className:"card-modern",children:e.jsxs(l,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-gold-light flex items-center justify-center",children:e.jsx(b,{className:"h-6 w-6 text-gold"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:o.length}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Eligible Patients"})]})]})})]}),e.jsxs(n,{className:"card-modern",children:[e.jsxs(ae,{children:[e.jsxs(te,{className:"flex items-center gap-2",children:[e.jsx(b,{className:"h-5 w-5"}),"Select Patients"]}),e.jsx(Se,{children:"Choose patients to send review requests to"})]}),e.jsx(l,{className:"p-0",children:me?e.jsx("div",{className:"p-6",children:e.jsx(T,{className:"h-32"})}):o.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(b,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No patients found with messaging opt-in"})]}):e.jsxs(ie,{children:[e.jsx(ne,{children:e.jsxs(C,{children:[e.jsx(r,{className:"w-12",children:e.jsx(ee,{checked:i.length===o.length,onCheckedChange:s=>S(s?o.map(a=>a.id):[])})}),e.jsx(r,{children:"Name"}),e.jsx(r,{children:"Phone"}),e.jsx(r,{children:"Last Visit"}),e.jsx(r,{children:"Channels"})]})}),e.jsx(le,{children:o.map(s=>e.jsxs(C,{children:[e.jsx(c,{children:e.jsx(ee,{checked:i.includes(s.id),onCheckedChange:()=>xe(s.id)})}),e.jsx(c,{className:"font-medium",children:s.name}),e.jsx(c,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ye,{className:"h-4 w-4 text-muted-foreground"}),s.phone]})}),e.jsx(c,{className:"text-muted-foreground",children:s.last_visit_at?se(new Date(s.last_visit_at),"MMM d, yyyy"):"-"}),e.jsx(c,{children:e.jsxs("div",{className:"flex gap-1",children:[s.is_opted_in_sms&&e.jsx(d,{variant:"outline",children:"SMS"}),s.is_opted_in_whatsapp&&e.jsx(d,{variant:"outline",children:"WhatsApp"})]})})]},s.id))})]})})]}),e.jsxs(n,{className:"card-modern",children:[e.jsx(ae,{children:e.jsx(te,{children:"Recent Requests"})}),e.jsx(l,{className:"p-0",children:f.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(j,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No review requests sent yet"})]}):e.jsxs(ie,{children:[e.jsx(ne,{children:e.jsxs(C,{children:[e.jsx(r,{children:"Recipient"}),e.jsx(r,{children:"Phone"}),e.jsx(r,{children:"Channel"}),e.jsx(r,{children:"Status"}),e.jsx(r,{children:"Sent"})]})}),e.jsx(le,{children:f.map(s=>e.jsxs(C,{children:[e.jsx(c,{className:"font-medium",children:s.recipient_name||"-"}),e.jsx(c,{children:s.recipient_phone||s.patient_phone}),e.jsx(c,{children:e.jsx(d,{variant:"outline",className:"capitalize",children:s.channel})}),e.jsx(c,{children:je(s.status)}),e.jsx(c,{className:"text-muted-foreground",children:se(new Date(s.created_at),"MMM d, HH:mm")})]},s.id))})]})})]})]})}export{Qe as default};
