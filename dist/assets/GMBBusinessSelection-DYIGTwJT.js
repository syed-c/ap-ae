const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DflORfjh.js","assets/chunk-CPh6voF3.js","assets/chunk-CffrGP6S.js","assets/chunk-B8auUmee.js","assets/chunk-DK8nT4cj.js","assets/chunk-Drd-rt-S.js","assets/chunk-BEQ5VEiB.js","assets/chunk-yff5u8mE.js","assets/chunk-xExVBHTi.js","assets/index-CigGl4-1.css"])))=>i.map(i=>d[i]);
import{u as K,s as i,br as V,d as W,L as R,B as m,w as A,Y as O,C as U,i as H,x as X,P as J,G as Q,b as w,c as b,_ as Z}from"./index-DflORfjh.js";import{j as e}from"./chunk-CPh6voF3.js";import{r as l}from"./chunk-CffrGP6S.js";import{C as g,a as j,b as N,c as y,d as h}from"./chunk-Dwq_v72W.js";import{S as D}from"./chunk-CQtADEjB.js";import{a as ee,u as se}from"./chunk-Drd-rt-S.js";import{C as te}from"./chunk-GLPyMM0F.js";import{R as _}from"./chunk-BOvFDp2b.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";function xe(){const c=ee(),M=se(),{user:f,refreshRoles:L}=K(),k=M.state?.providerToken,[Y,v]=l.useState(!0),[x,S]=l.useState(!1),[C,$]=l.useState([]),[r,B]=l.useState(null),[P,G]=l.useState(null),[I,u]=l.useState(null),q=async s=>{const o=s?.context;if(o&&typeof o=="object"&&typeof o.clone=="function"){try{const t=await o.clone().json(),a=t?.error||s?.message||"Failed to fetch Google Business Profiles",n=t?.code||null;return{message:a,code:n}}catch{}try{return{message:await o.clone().text()||s?.message||"Failed to fetch Google Business Profiles",code:null}}catch{}}return{message:s?.message||"Failed to fetch Google Business Profiles",code:null}};l.useEffect(()=>{let s=document.querySelector('meta[name="robots"]');return s||(s=document.createElement("meta"),s.setAttribute("name","robots"),document.head.appendChild(s)),s.setAttribute("content","noindex, nofollow"),()=>{s?.setAttribute("content","index, follow")}},[]),l.useEffect(()=>{const s=setTimeout(()=>{if(!f){console.log("[GMB] No user found, redirecting to auth"),c("/auth",{replace:!0});return}E()},500);return()=>clearTimeout(s)},[f,c]);const E=async()=>{v(!0),G(null),u(null);try{const{data:{session:s}}=await i.auth.getSession();if(!s)throw new Error("No active session. Please sign in again.");const o=V(),t=k??o??s.provider_token??null;if(console.log("[GMB] token sources",{nav:!!k,stored:!!o,session:!!s.provider_token}),!o&&t&&W(t),!t)throw u("NO_PROVIDER_TOKEN"),new Error("Google Business access token not found. Please sign in with Google again.");const{data:a,error:n}=await i.functions.invoke("gmb-fetch-businesses",{headers:{Authorization:`Bearer ${s.access_token}`},body:{providerToken:t}});if(n){const d=await q(n);throw u(d.code),new Error(d.message)}if(!a?.success)throw u(a?.code||null),new Error(a?.error||"Failed to fetch businesses");$(a.businesses||[]),a.businesses?.length===1&&B(a.businesses[0])}catch(s){console.error("Failed to fetch businesses:",s),G(s.message||"Failed to fetch Google Business Profiles")}finally{v(!1)}},z=async()=>{if(r){S(!0);try{const{data:{session:s}}=await i.auth.getSession();if(!s)throw new Error("No active session");if(localStorage.getItem("gmb_relink_flow")==="true"){const{data:d}=await i.from("clinics").select("id").eq("claimed_by",f?.id).single();if(d){const{error:T}=await i.from("clinics").update({google_place_id:r.placeId,gmb_data:{name:r.name,address:r.address,phone:r.phone,website:r.website,category:r.category,fetched_at:new Date().toISOString()},gmb_location_id:r.id,gmb_connected:!0,gmb_last_sync_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",d.id);if(T)throw T;w.success("Google Business Profile connected successfully!"),localStorage.removeItem("gmb_relink_flow"),b(),c("/dashboard?tab=settings&gmb_connected=true",{replace:!0});return}}const{data:t,error:a}=await i.functions.invoke("gmb-create-listing",{headers:{Authorization:`Bearer ${s.access_token}`},body:{business:r}});if(a)throw a;if(!t?.success)throw new Error(t?.error||"Failed to create listing");w.success("Your practice has been successfully listed!"),b(),localStorage.removeItem("gmb_listing_flow"),await L();const n=t.locationMatch;n?.requiresManualSelection?c(`/onboarding?gmb_connected=true&listing_created=true&location_pending=true&detected_city=${encodeURIComponent(n.cityName||"")}&detected_city_id=${n.cityId||""}`,{replace:!0}):c("/onboarding?gmb_connected=true&listing_created=true&location_verified=true",{replace:!0})}catch(s){console.error("Failed to create listing:",s),w.error(s.message||"Failed to create listing")}finally{S(!1)}}},p=async()=>{const s=localStorage.getItem("gmb_relink_flow")==="true";localStorage.removeItem("gmb_listing_flow"),localStorage.removeItem("gmb_relink_flow"),localStorage.removeItem("gmb_restore_session"),b(),s?c("/dashboard?tab=settings",{replace:!0}):c("/onboarding?new=true&skip_gmb=true",{replace:!0})},F=async()=>{const s=localStorage.getItem("gmb_relink_flow")==="true";if(s){const{data:{session:t}}=await i.auth.getSession();if(t){const{storeOriginalSession:a}=await Z(async()=>{const{storeOriginalSession:n}=await import("./index-DflORfjh.js").then(d=>d.bO);return{storeOriginalSession:n}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]));a(t.access_token,t.refresh_token||"",t.user.id),localStorage.setItem("gmb_restore_session","true")}localStorage.setItem("gmb_relink_flow","true")}else localStorage.setItem("gmb_listing_flow","true");const o=`https://www.appointpanda.ae/auth/callback?${s?"relink=true":"listing=true"}`;i.auth.signInWithOAuth({provider:"google",options:{scopes:"openid email profile https://www.googleapis.com/auth/business.manage",redirectTo:o,queryParams:{access_type:"offline",prompt:"consent select_account"}}})};return Y?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-background via-background to-muted flex items-center justify-center p-4",children:e.jsxs(g,{className:"w-full max-w-2xl",children:[e.jsxs(j,{className:"text-center",children:[e.jsx(N,{className:"text-2xl",children:"Finding Your Businesses..."}),e.jsx(y,{children:"Connecting to Google Business Profile"})]}),e.jsxs(h,{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(R,{className:"h-12 w-12 animate-spin text-primary"})}),e.jsx(D,{className:"h-24 w-full"}),e.jsx(D,{className:"h-24 w-full"})]})]})}):P?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-background via-background to-muted flex items-center justify-center p-4",children:e.jsxs(g,{className:"w-full max-w-md",children:[e.jsxs(j,{className:"text-center",children:[e.jsx("div",{className:"h-16 w-16 rounded-full bg-coral/10 flex items-center justify-center mx-auto mb-4",children:e.jsx(te,{className:"h-10 w-10 text-coral"})}),e.jsx(N,{className:"text-2xl",children:"Unable to Fetch Businesses"}),e.jsx(y,{children:P})]}),e.jsxs(h,{className:"space-y-4",children:[I==="NO_PROVIDER_TOKEN"||I==="TOKEN_EXPIRED"?e.jsxs(m,{onClick:F,className:"w-full",children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Sign in with Google Again"]}):e.jsxs(m,{onClick:E,className:"w-full",children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Try Again"]}),e.jsx(m,{variant:"outline",onClick:p,className:"w-full",children:"Continue Without Google Business"})]})]})}):C.length===0?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-background via-background to-muted flex items-center justify-center p-4",children:e.jsxs(g,{className:"w-full max-w-md",children:[e.jsxs(j,{className:"text-center",children:[e.jsx("div",{className:"h-16 w-16 rounded-full bg-gold/10 flex items-center justify-center mx-auto mb-4",children:e.jsx(A,{className:"h-10 w-10 text-gold"})}),e.jsx(N,{className:"text-2xl",children:"No Google Business Profiles Found"}),e.jsx(y,{children:"We couldn't find any Google Business Profiles linked to your Google account. You can still list your practice manually."})]}),e.jsxs(h,{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-muted rounded-lg text-sm text-muted-foreground",children:[e.jsx("p",{className:"font-medium mb-2",children:"Don't have a Google Business Profile?"}),e.jsxs("p",{children:["You can create one at ",e.jsx("a",{href:"https://business.google.com",target:"_blank",rel:"noopener noreferrer",className:"text-primary hover:underline",children:"business.google.com"})," and come back later to sync it."]})]}),e.jsxs(m,{onClick:p,className:"w-full",children:["Continue with Manual Setup",e.jsx(O,{className:"h-4 w-4 ml-2"})]}),e.jsxs(m,{variant:"outline",onClick:F,className:"w-full",children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Try Different Google Account"]})]})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-background via-background to-muted py-12 px-4",children:e.jsxs("div",{className:"max-w-3xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2",children:"Select Your Practice"}),e.jsx("p",{className:"text-muted-foreground",children:"Choose the Google Business Profile you want to list on Appoint Panda"})]}),e.jsx("div",{className:"space-y-4 mb-8",children:C.map(s=>e.jsx(g,{className:`cursor-pointer transition-all ${r?.id===s.id?"border-primary ring-2 ring-primary/20 bg-primary/5":"hover:border-primary/30"}`,onClick:()=>B(s),children:e.jsx(h,{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:`h-12 w-12 rounded-full flex items-center justify-center flex-shrink-0 ${r?.id===s.id?"bg-primary text-primary-foreground":"bg-muted"}`,children:r?.id===s.id?e.jsx(U,{className:"h-6 w-6"}):e.jsx(A,{className:"h-6 w-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h3",{className:"font-bold text-lg truncate",children:s.name}),s.category&&e.jsx(H,{variant:"secondary",className:"flex-shrink-0",children:s.category})]}),e.jsxs("div",{className:"space-y-1 text-sm text-muted-foreground",children:[s.address&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-4 w-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:s.address})]}),s.phone&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"h-4 w-4 flex-shrink-0"}),e.jsx("span",{children:s.phone})]}),s.website&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"h-4 w-4 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:s.website})]})]})]})]})})},s.id))}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsx(m,{onClick:z,disabled:!r||x,className:"flex-1",size:"lg",children:x?e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"h-4 w-4 mr-2 animate-spin"}),"Creating Listing..."]}):e.jsxs(e.Fragment,{children:["List This Practice",e.jsx(O,{className:"h-4 w-4 ml-2"})]})}),e.jsx(m,{variant:"outline",onClick:p,disabled:x,size:"lg",children:"Skip & Enter Manually"})]}),e.jsx("p",{className:"text-xs text-center text-muted-foreground mt-6",children:"By listing your practice, you agree to our terms and privacy policy. Your business information will be synced from Google Business Profile."})]})})}export{xe as default};
