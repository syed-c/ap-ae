import{j as e}from"./chunk-CPh6voF3.js";import{r as d}from"./chunk-CffrGP6S.js";import{C as h,a as g,b as p,d as j,c as S}from"./chunk-Dwq_v72W.js";import{f as H,B as y,bC as z,bA as U,S as L,al as X,s as R,b as G,i as f,t as Q}from"./index-DflORfjh.js";import{P as J}from"./chunk-DSDQubI6.js";import{T as K,a as V,b as w,c as b,d as W,e as u}from"./chunk-NLs5Ye4A.js";import{D as Y}from"./chunk-CedtSHBb.js";import{R as k}from"./chunk-BOvFDp2b.js";import{S as Z}from"./chunk-C2HaaarX.js";import{C as E}from"./chunk-GLPyMM0F.js";import{C as ee}from"./chunk-BFhD_ct7.js";import{C as se}from"./chunk-f2aNMA4v.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-Drd-rt-S.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=H("Terminal",[["polyline",{points:"4 17 10 11 4 5",key:"akl6gq"}],["line",{x1:"12",x2:"20",y1:"19",y2:"19",key:"q2wloq"}]]),ae=["states","insurances","subscription_plans","blog_categories","global_settings","plan_features","cities","seo_pages","treatments","clinics","dentists","patients","leads","appointments","reviews","blog_posts","visitor_sessions","page_views","google_reviews","audit_logs","clinic_hours","seo_metadata_history","outreach_campaigns","automation_rules"];function Se(){const[c,m]=d.useState([]),[x,T]=d.useState(!1),[v,I]=d.useState([]),[N,P]=d.useState(""),[_,M]=d.useState(!1),l=(s,r,a)=>{I(i=>[{timestamp:new Date().toISOString(),table:s,message:r,type:a},...i].slice(0,100))},$=async()=>{M(!0),l("system","Starting table audit...","info");const s=[];for(const r of ae)try{const{count:a,error:i}=await R.from(r).select("*",{count:"exact",head:!0});i?s.push({name:r,sourceCount:0,targetCount:0,status:"error",error:i.message}):s.push({name:r,sourceCount:a||0,targetCount:0,status:"pending"})}catch(a){s.push({name:r,sourceCount:0,targetCount:0,status:"error",error:String(a)})}m(s),M(!1),l("system",`Audit complete. Found ${s.length} tables.`,"success")},B=async(s,r)=>{try{const a=await R.functions.invoke("migrate-to-external",{body:{action:"migrate-table",tableName:s,batchSize:100,lastId:r}});if(a.error)throw new Error(a.error.message);return a.data}catch(a){throw a}},D=async()=>{T(!0),l("system","Starting migration...","info");for(const s of c){if(s.status==="completed")continue;let r=s.lastId,a=!0,i=0;for(m(t=>t.map(n=>n.name===s.name?{...n,status:"in_progress"}:n));a&&x;)try{const t=await B(s.name,r);if(t.success)i+=t.recordsProcessed||0,a=t.hasMore,r=t.lastProcessedId,l(s.name,`Migrated ${t.recordsProcessed} records (total: ${i})`,"info"),m(n=>n.map(o=>o.name===s.name?{...o,lastId:r,targetCount:i}:o));else throw new Error(t.error||"Unknown error")}catch(t){if(l(s.name,`Error: ${t.message}`,"error"),t.message?.includes("Could not find")){const n=t.message.match(/Could not find the '(\w+)' column/);n&&P(o=>o+`
ALTER TABLE public.${s.name} ADD COLUMN IF NOT EXISTS ${n[1]} TEXT;`)}m(n=>n.map(o=>o.name===s.name?{...o,status:"error",error:t.message}:o)),a=!1}a===!1&&!c.find(t=>t.name===s.name)?.error&&(m(t=>t.map(n=>n.name===s.name?{...n,status:"completed"}:n)),l(s.name,`Migration complete! Total: ${i} records`,"success"))}T(!1),l("system","Migration process finished","success")},O=()=>{navigator.clipboard.writeText(N),G.success("Schema script copied to clipboard")},F=s=>{switch(s){case"completed":return e.jsxs(f,{className:"bg-green-500",children:[e.jsx(se,{className:"w-3 h-3 mr-1"}),"Complete"]});case"in_progress":return e.jsxs(f,{className:"bg-blue-500",children:[e.jsx(k,{className:"w-3 h-3 mr-1 animate-spin"}),"Running"]});case"error":return e.jsxs(f,{className:"bg-red-500",children:[e.jsx(E,{className:"w-3 h-3 mr-1"}),"Error"]});default:return e.jsxs(f,{variant:"secondary",children:[e.jsx(Q,{className:"w-3 h-3 mr-1"}),"Pending"]})}},A=c.filter(s=>s.status==="completed").length,C=c.length,q=C>0?A/C*100:0;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(Y,{className:"h-6 w-6"}),"Migration Control Center"]}),e.jsx("p",{className:"text-muted-foreground",children:"Migrate data from Lovable Cloud to external Supabase"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(y,{variant:"outline",onClick:$,disabled:_||x,children:[e.jsx(k,{className:`h-4 w-4 mr-2 ${_?"animate-spin":""}`}),"Audit Tables"]}),e.jsx(y,{onClick:D,disabled:x||c.length===0,children:x?e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Running..."]}):e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"h-4 w-4 mr-2"}),"Start Migration"]})})]})]}),c.length>0&&e.jsxs(h,{children:[e.jsx(g,{className:"pb-2",children:e.jsx(p,{className:"text-lg",children:"Overall Progress"})}),e.jsx(j,{children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(J,{value:q,className:"flex-1"}),e.jsxs("span",{className:"text-sm font-medium",children:[A," / ",C," tables"]})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(h,{children:[e.jsxs(g,{children:[e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-5 w-5"}),"Table Status"]}),e.jsx(S,{children:"Current migration status for each table"})]}),e.jsx(j,{children:e.jsx(L,{className:"h-[400px]",children:e.jsxs(K,{children:[e.jsx(V,{children:e.jsxs(w,{children:[e.jsx(b,{children:"Table"}),e.jsx(b,{children:"Source"}),e.jsx(b,{children:"Migrated"}),e.jsx(b,{children:"Status"})]})}),e.jsxs(W,{children:[c.map(s=>e.jsxs(w,{children:[e.jsx(u,{className:"font-mono text-sm",children:s.name}),e.jsx(u,{children:s.sourceCount.toLocaleString()}),e.jsx(u,{children:s.targetCount.toLocaleString()}),e.jsx(u,{children:F(s.status)})]},s.name)),c.length===0&&e.jsx(w,{children:e.jsx(u,{colSpan:4,className:"text-center text-muted-foreground py-8",children:'Click "Audit Tables" to start'})})]})]})})})]}),e.jsxs(h,{children:[e.jsxs(g,{children:[e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-5 w-5"}),"Migration Logs"]}),e.jsx(S,{children:"Real-time migration activity"})]}),e.jsx(j,{children:e.jsxs(L,{className:"h-[400px] bg-muted/50 rounded-md p-4 font-mono text-sm",children:[v.map((s,r)=>e.jsxs("div",{className:`mb-2 ${s.type==="error"?"text-red-500":s.type==="success"?"text-green-500":"text-muted-foreground"}`,children:[e.jsx("span",{className:"text-xs opacity-50",children:new Date(s.timestamp).toLocaleTimeString()})," ",e.jsxs("span",{className:"text-primary",children:["[",s.table,"]"]})," ",s.message]},r)),v.length===0&&e.jsx("div",{className:"text-muted-foreground text-center py-8",children:"No logs yet. Start a migration to see activity."})]})})]})]}),N&&e.jsxs(h,{className:"border-yellow-500/50",children:[e.jsxs(g,{children:[e.jsxs(p,{className:"flex items-center gap-2 text-yellow-600",children:[e.jsx(E,{className:"h-5 w-5"}),"Schema Fixes Required"]}),e.jsx(S,{children:"Run this SQL on your external Supabase to fix missing columns"})]}),e.jsx(j,{children:e.jsxs("div",{className:"relative",children:[e.jsx(X,{value:N,readOnly:!0,className:"font-mono text-sm h-48"}),e.jsxs(y,{size:"sm",variant:"outline",className:"absolute top-2 right-2",onClick:O,children:[e.jsx(ee,{className:"h-4 w-4 mr-1"}),"Copy"]})]})})]})]})}export{Se as MigrationControlTab};
