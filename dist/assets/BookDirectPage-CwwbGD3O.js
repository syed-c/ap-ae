import{u as P,j as e}from"./chunk-CPh6voF3.js";import{ak as Z,C as I,x as J,aI as X,B as N,aj as ee,l as k,aZ as te,a_ as m,a$ as x,a2 as re,b2 as g,a3 as se,a5 as ae,a6 as ne,a7 as M,b0 as u,b1 as b,al as ie,a1 as oe,Q as A,I as S,b3 as le,Y as ce,s as f,aY as de,ai as me}from"./index-DflORfjh.js";import{r as v}from"./chunk-CffrGP6S.js";import{b as xe,s as p,l as ue,c as pe}from"./chunk-yff5u8mE.js";import{C as he}from"./chunk-8Vpa5_RZ.js";import{P as fe}from"./chunk-DSDQubI6.js";import{S as C}from"./chunk-CQtADEjB.js";import{b as je,N as ge}from"./chunk-Drd-rt-S.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-BEQ5VEiB.js";import"./chunk-xExVBHTi.js";import"./chunk-aAsotRsv.js";import"./chunk-C_nua8Pg.js";import"./chunk-DncHrJ4I.js";import"./chunk-BcyAVLmp.js";import"./chunk-B2Rulxe9.js";const E=a=>a.replace(/[<>]/g,"").replace(/javascript:/gi,"").replace(/on\w+\s*=/gi,"").trim(),be=xe({patient_name:p().min(2,"Name must be at least 2 characters").max(100).transform(E),patient_phone:p().min(9,"Please enter a valid phone number").max(20).regex(/^[\d\s\+\-\(\)]+$/,"Please enter a valid phone number"),patient_email:p().email("Please enter a valid email").optional().or(ue("")),treatment_id:p().min(1,"Please select a service"),preferred_date:p().min(1,"Please select a date"),preferred_time:p().min(1,"Please select a time"),notes:p().max(500).optional().transform(a=>a&&E(a))}),ye=a=>{const r=a+1,o=l=>l<12?`${l}:00 AM`:l===12?"12:00 PM":`${l-12}:00 PM`;return`${o(a)} - ${o(r)}`},Ne=Array.from({length:9},(a,r)=>{const o=r+9;return{value:`${o.toString().padStart(2,"0")}:00`,label:ye(o)}});function ve({profileId:a,profileName:r,profileType:o,clinicId:l,clinicLatitude:c,clinicLongitude:y,clinicAddress:j,onSuccess:R,onClose:Y}){const{toast:$}=Z(),[n,B]=v.useState(1),[D,F]=v.useState(!1),[V,H]=v.useState(!1),[h,W]=v.useState(),{data:z}=P({queryKey:["booking-treatments"],queryFn:async()=>{const{data:t}=await f.from("treatments").select("id, name").eq("is_active",!0).order("display_order");return t||[]}}),i=pe({resolver:de(be),defaultValues:{patient_name:"",patient_phone:"",patient_email:"",treatment_id:"",preferred_date:"",preferred_time:"",notes:""}}),L=async()=>{let t=[];n===1?t=["treatment_id"]:n===2&&(t=["preferred_date","preferred_time"]),await i.trigger(t)&&B(d=>Math.min(d+1,3))},U=()=>{B(t=>Math.max(t-1,1))},K=t=>{W(t),t&&i.setValue("preferred_date",A(t,"yyyy-MM-dd"))},Q=async t=>{F(!0);try{const s=o==="clinic"?a:l||null;let d=!1;if(s){const{data:_}=await f.from("appointments").select("id").eq("clinic_id",s).or(`patient_phone.eq.${t.patient_phone}${t.patient_email?`,patient_email.eq.${t.patient_email}`:""}`).limit(1);d=(_?.length||0)>0}const T={patient_name:t.patient_name,patient_phone:t.patient_phone,patient_email:t.patient_email||null,treatment_id:t.treatment_id&&t.treatment_id!=="not_sure"?t.treatment_id:null,preferred_date:t.preferred_date,preferred_time:t.preferred_time,notes:t.notes||null,clinic_id:s,dentist_id:o==="dentist"?a:null,status:"pending",source:"website",is_returning_patient:d};console.log("Submitting appointment:",T,"Returning patient:",d);const{data:q,error:w}=await f.from("appointments").insert(T).select("id").single();if(w)throw console.error("Appointment insert error:",w),w;q?.id&&t.patient_email&&f.functions.invoke("send-booking-email",{body:{appointmentId:q.id,type:"new_booking",newStatus:"pending"}}).catch(_=>{console.error("Failed to send booking email:",_)}),H(!0),$({title:"Booking Request Sent!",description:"The clinic will contact you to confirm your appointment."}),R?.()}catch(s){const d=s instanceof Error?s.message:"Please try again later.";$({title:"Booking Failed",description:d,variant:"destructive"})}finally{F(!1)}},O=()=>c&&y?`https://www.google.com/maps/dir/?api=1&destination=${c},${y}`:j?`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(j)}`:null,G=n/3*100;if(V){const t=O();return e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"bg-gradient-to-r from-primary to-primary/80 p-8 text-center rounded-t-3xl",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-white/20 backdrop-blur-sm flex items-center justify-center mx-auto mb-4",children:e.jsx(I,{className:"h-10 w-10 text-white"})}),e.jsx("h3",{className:"text-2xl font-bold text-white mb-2",children:"Booking Sent!"}),e.jsx("p",{className:"text-white/80 text-sm",children:"Your request has been submitted successfully"})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"text-center",children:e.jsxs("p",{className:"text-muted-foreground mb-4",children:[e.jsx("span",{className:"font-semibold text-foreground",children:r})," will contact you shortly to confirm your appointment."]})}),e.jsxs("div",{className:"bg-muted/50 border border-border rounded-2xl p-5",children:[e.jsx("h4",{className:"font-bold text-foreground mb-3",children:"ðŸ“‹ What happens next?"}),e.jsxs("ul",{className:"space-y-2 text-sm text-muted-foreground",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-primary font-bold",children:"1."}),"The clinic will review your booking request"]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-primary font-bold",children:"2."}),"You'll receive a confirmation email with appointment details"]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-primary font-bold",children:"3."}),"Use the email link to reschedule or cancel anytime"]})]})]}),t&&e.jsxs("div",{className:"bg-primary/5 border border-primary/20 rounded-2xl p-5",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(J,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-foreground",children:"Clinic Location"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Ready for your visit"})]})]}),e.jsxs("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"flex items-center justify-center gap-2 w-full bg-primary text-primary-foreground rounded-xl py-3 font-bold transition-all hover:bg-primary/90",children:[e.jsx(X,{className:"h-4 w-4"}),"Get Directions"]})]}),e.jsx("div",{className:"flex gap-3",children:e.jsx(N,{variant:"outline",className:"flex-1 rounded-xl h-12 font-bold",onClick:Y,children:"Close"})}),e.jsxs("p",{className:"text-xs text-center text-muted-foreground",children:[e.jsx(ee,{className:"h-3 w-3 inline mr-1 text-destructive"}),"Thank you for choosing AppointPanda"]})]})]})}return e.jsxs("div",{children:[e.jsxs("div",{className:"bg-gradient-to-r from-primary/10 via-primary/5 to-transparent p-6 pb-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h2",{className:"text-xl font-bold text-foreground",children:"Book Appointment"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:r})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex justify-between text-sm",children:["Service","Date & Time","Your Details"].map((t,s)=>e.jsxs("div",{className:k("flex items-center gap-2",n>=s+1?"text-primary":"text-muted-foreground"),children:[e.jsx("div",{className:k("w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold transition-all",n>s+1?"bg-primary text-primary-foreground":n===s+1?"bg-primary/20 text-primary ring-2 ring-primary":"bg-muted text-muted-foreground"),children:n>s+1?e.jsx(I,{className:"h-4 w-4"}):s+1}),e.jsx("span",{className:"hidden sm:block font-medium",children:t})]},t))}),e.jsx(fe,{value:G,className:"h-1.5 rounded-full"})]})]}),e.jsx(te,{...i,children:e.jsxs("form",{onSubmit:i.handleSubmit(Q),className:"p-6 pt-2 space-y-6 max-h-[50vh] overflow-y-auto",children:[n===1&&e.jsxs("div",{className:"space-y-4 animate-fade-in-up",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-foreground",children:"What service do you need?"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Select the treatment you're interested in"})]}),e.jsx(m,{control:i.control,name:"treatment_id",render:({field:t})=>e.jsxs(x,{children:[e.jsxs(re,{onValueChange:t.onChange,value:t.value,children:[e.jsx(g,{children:e.jsx(se,{className:"rounded-2xl h-14 border-2 border-border/50 focus:border-primary transition-all",children:e.jsx(ae,{placeholder:"Choose a service..."})})}),e.jsxs(ne,{className:"max-h-64 rounded-2xl",children:[e.jsx(M,{value:"not_sure",className:"rounded-xl py-3",children:e.jsx("span",{className:"font-bold text-primary",children:"Not sure / Need consultation"})}),z?.map(s=>e.jsx(M,{value:s.id,className:"rounded-xl py-3",children:s.name},s.id))]})]}),e.jsx(u,{})]})}),e.jsx(m,{control:i.control,name:"notes",render:({field:t})=>e.jsxs(x,{children:[e.jsx(b,{className:"text-sm font-medium",children:"Additional notes (optional)"}),e.jsx(g,{children:e.jsx(ie,{placeholder:"Describe your dental concern or any specific requests...",className:"rounded-2xl resize-none border-2 border-border/50 focus:border-primary transition-all",rows:3,...t})}),e.jsx(u,{})]})})]}),n===2&&e.jsxs("div",{className:"space-y-4 animate-fade-in-up",children:[e.jsxs("div",{className:"text-center mb-2",children:[e.jsx("h3",{className:"text-lg font-bold text-foreground",children:"When would you like to visit?"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:h?"Now select your preferred time":"Select your preferred date"})]}),e.jsx(m,{control:i.control,name:"preferred_date",render:()=>e.jsxs(x,{children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(he,{mode:"single",selected:h,onSelect:K,disabled:t=>t<oe(new Date,1)||t.getDay()===0,className:"rounded-2xl border border-border p-2 sm:p-3 pointer-events-auto w-full max-w-[320px]"})}),h&&e.jsxs("p",{className:"text-center text-sm text-primary font-medium mt-2",children:["Selected: ",A(h,"EEEE, MMMM d, yyyy")]}),e.jsx(u,{})]})}),h&&e.jsx(m,{control:i.control,name:"preferred_time",render:({field:t})=>e.jsxs(x,{className:"animate-fade-in-up",children:[e.jsx(b,{className:"text-sm font-medium text-center block",children:"Available Times"}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 gap-2 mt-2",children:Ne.map(s=>e.jsx("button",{type:"button",onClick:()=>t.onChange(s.value),className:k("py-2.5 px-2 rounded-xl text-xs sm:text-sm font-medium transition-all border",t.value===s.value?"bg-primary text-primary-foreground border-primary shadow-md":"bg-muted/50 text-foreground border-border hover:border-primary/50 hover:bg-muted"),children:s.label},s.value))}),e.jsx(u,{})]})}),!h&&e.jsx("p",{className:"text-center text-sm text-muted-foreground py-4",children:"Please select a date to view available time slots"})]}),n===3&&e.jsxs("div",{className:"space-y-4 animate-fade-in-up",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("h3",{className:"text-lg font-bold text-foreground",children:"Your Contact Details"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"How can the clinic reach you?"})]}),e.jsx(m,{control:i.control,name:"patient_name",render:({field:t})=>e.jsxs(x,{children:[e.jsx(b,{className:"text-sm font-medium",children:"Full Name"}),e.jsx(g,{children:e.jsx(S,{placeholder:"Your full name",className:"rounded-2xl h-14 border-2 border-border/50 focus:border-primary transition-all",...t})}),e.jsx(u,{})]})}),e.jsx(m,{control:i.control,name:"patient_phone",render:({field:t})=>e.jsxs(x,{children:[e.jsx(b,{className:"text-sm font-medium",children:"Phone Number"}),e.jsx(g,{children:e.jsx(S,{type:"tel",placeholder:"+971 50 123 4567",className:"rounded-2xl h-14 border-2 border-border/50 focus:border-primary transition-all",...t})}),e.jsx(u,{})]})}),e.jsx(m,{control:i.control,name:"patient_email",render:({field:t})=>e.jsxs(x,{children:[e.jsx(b,{className:"text-sm font-medium",children:"Email (Optional)"}),e.jsx(g,{children:e.jsx(S,{type:"email",placeholder:"your@email.com",className:"rounded-2xl h-14 border-2 border-border/50 focus:border-primary transition-all",...t})}),e.jsx(u,{})]})})]}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t border-border",children:[n>1&&e.jsxs(N,{type:"button",variant:"outline",className:"flex-1 rounded-xl h-12 font-bold",onClick:U,children:[e.jsx(le,{className:"h-4 w-4 mr-2"}),"Back"]}),n<3?e.jsxs(N,{type:"button",className:"flex-1 rounded-xl h-12 font-bold",onClick:L,children:["Continue",e.jsx(ce,{className:"h-4 w-4 ml-2"})]}):e.jsx(N,{type:"submit",className:"flex-1 rounded-xl h-12 font-bold",disabled:D,children:D?"Submitting...":"Confirm Booking"})]})]})})]})}function Ye(){const{clinicId:a}=je(),{data:r,isLoading:o,error:l}=P({queryKey:["clinic-booking",a],queryFn:async()=>{if(!a)throw new Error("No clinic ID");const{data:y,error:j}=await f.from("clinics").select(`
          id,
          name,
          slug,
          address,
          latitude,
          longitude,
          phone,
          cover_image_url,
          city:cities(name),
          area:areas(name)
        `).eq("id",a).single();if(j)throw j;return y},enabled:!!a});if(P({queryKey:["track-booking-view",a],queryFn:async()=>a?(await f.functions.invoke("track-profile-view",{body:{clinicId:a,source:"gmb_booking_link",eventType:"booking_page_view"}}),!0):null,enabled:!!a,staleTime:1/0}),o)return e.jsx("div",{className:"min-h-screen bg-gradient-to-b from-background to-muted/20 flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-lg space-y-4",children:[e.jsx(C,{className:"h-8 w-3/4 mx-auto"}),e.jsx(C,{className:"h-64 w-full rounded-2xl"}),e.jsx(C,{className:"h-12 w-full rounded-xl"})]})});if(l||!r)return e.jsx(ge,{to:"/",replace:!0});const c=[r.area?.name,r.city?.name].filter(Boolean).join(", ");return e.jsxs(e.Fragment,{children:[e.jsx(me,{title:`Book Appointment - ${r.name}`,description:`Book an appointment online with ${r.name}${c?` in ${c}`:""}. Quick and easy online scheduling.`,noindex:!0}),e.jsxs("div",{className:"min-h-screen bg-gradient-to-b from-background to-muted/20",children:[e.jsx("header",{className:"border-b bg-card/50 backdrop-blur-sm sticky top-0 z-10",children:e.jsx("div",{className:"container max-w-lg mx-auto px-4 py-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[r.cover_image_url?e.jsx("img",{src:r.cover_image_url,alt:r.name,className:"h-12 w-12 rounded-full object-cover border-2 border-primary/20"}):e.jsx("div",{className:"h-12 w-12 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx("span",{className:"text-lg font-bold text-primary",children:r.name.charAt(0)})}),e.jsxs("div",{children:[e.jsx("h1",{className:"font-semibold text-foreground",children:r.name}),c&&e.jsx("p",{className:"text-sm text-muted-foreground",children:c})]})]})})}),e.jsxs("main",{className:"container max-w-lg mx-auto px-4 py-6",children:[e.jsx("div",{className:"bg-card rounded-2xl border shadow-lg overflow-hidden",children:e.jsx(ve,{profileId:r.id,profileName:r.name,profileType:"clinic",clinicId:r.id,clinicLatitude:r.latitude,clinicLongitude:r.longitude,clinicAddress:r.address,onClose:()=>{window.location.href=`/clinic/${r.slug}`}})}),e.jsxs("div",{className:"mt-6 text-center space-y-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Powered by AppointPanda"}),e.jsxs("div",{className:"flex items-center justify-center gap-4 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsxs("svg",{className:"h-4 w-4 text-teal",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"}),e.jsx("path",{d:"m9 12 2 2 4-4"})]}),"Secure Booking"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsxs("svg",{className:"h-4 w-4 text-teal",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("polyline",{points:"12 6 12 12 16 14"})]}),"Instant Confirmation"]})]})]})]})]})]})}export{Ye as default};
