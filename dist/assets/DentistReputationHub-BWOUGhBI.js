import{u as Q,j as e,b as Le,c as je}from"./chunk-CPh6voF3.js";import{u as ns}from"./chunk-BdAozh8S.js";import{l as pe,i as E,S as be,a8 as ls,t as De,Q as oe,A as me,P as Ge,B as w,n as se,s as C,$ as X,C as de,G as cs,L as ne,a as M,I as B,a4 as ds,Y as He,y as Oe,b as $,be as os,T as Ke,a9 as Se,aa as _e,ab as Ce,ac as ke,ad as Ee,a2 as fe,a3 as ve,a5 as Ne,a6 as we,a7 as G,ae as $e,p as We,al as ms,u as Ie,o as xs,w as hs}from"./index-DflORfjh.js";import{S as U}from"./chunk-CQtADEjB.js";import{C as u,a as H,d as p,b as Y,c as I}from"./chunk-Dwq_v72W.js";import{L as us}from"./chunk-Drd-rt-S.js";import{r as j}from"./chunk-CffrGP6S.js";import{T as Je,a as Xe,b as Ue,c as ee}from"./chunk-k8HiDHrE.js";import{P as ce}from"./chunk-DSDQubI6.js";import{a as le,T as xe}from"./chunk-BLd3XU4A.js";import{M as ae}from"./chunk-B7d2qnKb.js";import{T as Pe}from"./chunk-DbdCK11k.js";import{A as ge,B as Re,P as ps,S as Ze,a as gs}from"./chunk-C2VW2Ml6.js";import{A as Te}from"./chunk-B0DPEAZ9.js";import{Q as he}from"./chunk-I5uVO93-.js";import{R as Be}from"./chunk-BOvFDp2b.js";import{E as Ve}from"./chunk-CcezodbN.js";import{s as W}from"./chunk-aAsotRsv.js";import{S as ie}from"./chunk-DfjE-bP6.js";import{S as js}from"./chunk-CzOt8Wyl.js";import{c as es}from"./chunk-BSjc5zjM.js";import{C as Ae}from"./chunk-GLPyMM0F.js";import{L as Qe}from"./chunk-B0x3dbdo.js";import{S as ss}from"./chunk-C7BdFRQZ.js";import{E as ts}from"./chunk-CbETxTmt.js";import{S as qe}from"./chunk-C8UDNHIm.js";import{Q as fs,P as vs,h as Ns,a as ws}from"./chunk-DR0VO1o8.js";import{C as bs}from"./chunk-wy0nNZZG.js";import{D as ys}from"./chunk-z-mlRDN4.js";import{C as as}from"./chunk-BFhD_ct7.js";import{T as Ss}from"./chunk-z7Kqt5JR.js";import{I as _s}from"./chunk-DZK1lt0q.js";import{U as Cs}from"./chunk-BcKWIjsB.js";import{F as ye}from"./chunk-BaL04tya.js";import{P as ze}from"./chunk-HAC-i_a2.js";import{S as ks}from"./chunk-B51FxpoB.js";import{T as Rs}from"./chunk-BRVan1jG.js";import{A as qs,a as Ls}from"./chunk-BRjFAgpB.js";import{T as Ds}from"./chunk-C76wK-Kz.js";import{M as rs}from"./chunk-DnhFyEPV.js";import{H as ue}from"./chunk-C077LRJi.js";import{N as Ps}from"./chunk-BQwaAkM6.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";import"./chunk-Beq7cUgv.js";import"./chunk-Cq66vzLV.js";import"./chunk-fofMllkR.js";function Ts({clinicId:n,limit:k=50,showHeader:v=!0,className:b}){const{data:f=[],isLoading:g}=Q({queryKey:["negative-feedback",n,k],queryFn:async()=>{const{data:l,error:o}=await C.from("review_funnel_events").select("*").eq("clinic_id",n).eq("event_type","thumbs_down").order("created_at",{ascending:!1}).limit(k);if(o)throw o;return l||[]},enabled:!!n}),y=l=>l?e.jsx("div",{className:"flex items-center gap-0.5",children:[1,2,3,4,5].map(o=>e.jsx(se,{className:pe("h-3 w-3",o<=l?"text-amber-500 fill-amber-500":"text-muted-foreground/30")},o))}):null,s=l=>l?l<=2?"border-red-300 bg-red-50":l<=3?"border-amber-300 bg-amber-50":"border-yellow-300 bg-yellow-50":"border-amber-300 bg-amber-50",_=l=>l?l<=1?{label:"Critical",variant:"destructive"}:l<=2?{label:"Serious",variant:"destructive"}:l<=3?{label:"Moderate",variant:"default"}:{label:"Minor",variant:"secondary"}:{label:"No Rating",variant:"secondary"};return g?e.jsxs(u,{className:b,children:[v&&e.jsxs(H,{children:[e.jsx(U,{className:"h-6 w-48"}),e.jsx(U,{className:"h-4 w-64 mt-2"})]}),e.jsx(p,{children:e.jsx("div",{className:"space-y-3",children:[1,2,3].map(l=>e.jsx(U,{className:"h-24 w-full rounded-xl"},l))})})]}):e.jsxs(u,{className:pe("border-2",b),children:[v&&e.jsx(H,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(Y,{className:"flex items-center gap-2 text-lg",children:[e.jsx("div",{className:"h-8 w-8 rounded-lg bg-red-100 flex items-center justify-center",children:e.jsx(le,{className:"h-4 w-4 text-red-600"})}),"Private Feedback"]}),e.jsx(I,{children:"Negative feedback that was captured privately (not posted to Google)"})]}),e.jsxs(E,{variant:"destructive",className:"text-sm",children:[f.length," Issues"]})]})}),e.jsx(p,{children:f.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"h-16 w-16 rounded-2xl bg-emerald-100 flex items-center justify-center mx-auto mb-4",children:e.jsx(le,{className:"h-8 w-8 text-emerald-600 rotate-180"})}),e.jsx("h3",{className:"font-semibold text-foreground mb-1",children:"No Negative Feedback"}),e.jsx("p",{className:"text-sm text-muted-foreground max-w-sm mx-auto",children:"Great job! You haven't received any negative feedback through the review funnel."})]}):e.jsx(be,{className:"h-[400px] pr-2",children:e.jsx("div",{className:"space-y-3",children:f.map((l,o)=>{const A=_(l.rating);return e.jsxs("div",{className:pe("p-4 rounded-xl border-2 transition-all hover:shadow-md",s(l.rating)),children:[e.jsxs("div",{className:"flex items-start justify-between gap-3 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-full bg-slate-200 flex items-center justify-center flex-shrink-0",children:e.jsx(ls,{className:"h-5 w-5 text-slate-500"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-foreground",children:l.visitor_name||"Anonymous Visitor"}),e.jsx(E,{variant:A.variant,className:"text-xs h-5",children:A.label})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground mt-0.5",children:[e.jsx(De,{className:"h-3 w-3"}),e.jsx("span",{children:oe(new Date(l.created_at),"MMM d, yyyy ‚Ä¢ h:mm a")}),e.jsx("span",{className:"text-muted-foreground/50",children:"‚Ä¢"}),e.jsx("span",{className:"capitalize",children:l.source})]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[y(l.rating),e.jsx("span",{className:"text-xs text-muted-foreground",children:l.rating?`${l.rating}/5`:"No rating"})]})]}),l.comment?e.jsx("div",{className:"p-3 rounded-lg bg-white/80 border border-slate-200",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(ae,{className:"h-4 w-4 text-muted-foreground flex-shrink-0 mt-0.5"}),e.jsxs("p",{className:"text-sm text-foreground leading-relaxed",children:['"',l.comment,'"']})]})}):e.jsx("div",{className:"p-3 rounded-lg bg-white/50 border border-dashed border-slate-200",children:e.jsxs("p",{className:"text-sm text-muted-foreground italic flex items-center gap-2",children:[e.jsx(Pe,{className:"h-4 w-4"}),"No comment provided"]})}),(l.visitor_email||l.visitor_phone)&&e.jsxs("div",{className:"flex items-center gap-4 mt-3 pt-3 border-t border-slate-200",children:[l.visitor_email&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(me,{className:"h-3 w-3"}),e.jsx("span",{children:l.visitor_email})]}),l.visitor_phone&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(Ge,{className:"h-3 w-3"}),e.jsx("span",{children:l.visitor_phone})]})]}),e.jsxs("div",{className:"flex items-center justify-between mt-3 pt-3 border-t border-slate-200",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Feedback #",f.length-o]}),e.jsx(w,{variant:"ghost",size:"sm",className:"h-7 text-xs text-primary",children:"Mark as Addressed"})]})]},l.id)})})})})]})}function As({clinicId:n,clinicName:k,googlePlaceId:v,rating:b,reviewCount:f,onSendRequest:g,onOpenQR:y,onSync:s}){const{data:_=[],isLoading:l}=Q({queryKey:["reputation-funnel-overview",n],queryFn:async()=>{const{data:h}=await C.from("review_funnel_events").select("*").eq("clinic_id",n).order("created_at",{ascending:!1}).limit(500);return h||[]}}),{data:o=[],isLoading:A}=Q({queryKey:["google-reviews-overview",n],queryFn:async()=>{const{data:h}=await C.from("google_reviews").select("*").eq("clinic_id",n).order("review_time",{ascending:!1}).limit(100);return h||[]}}),m=j.useMemo(()=>{const h=new Date,S=W(h,30),R=W(h,7),P=_.length,L=_.filter(t=>t.event_type==="thumbs_up").length,d=_.filter(t=>t.event_type==="thumbs_down").length,a=P>0?L/P*100:0,i=_.filter(t=>new Date(t.created_at)>=S),F=_.filter(t=>new Date(t.created_at)>=R),q=i.filter(t=>t.event_type==="thumbs_up").length,x=F.filter(t=>t.event_type==="thumbs_up").length,D=o.filter(t=>t.reply_status!=="posted").length,O=b||0,T=O/5*40,K=Math.min(q/10,1)*25,re=o.length>0?(o.length-D)/o.length*20:10,te=P>0?L/P*15:7.5;return{reputationScore:Math.round(T+K+re+te),avgRating:O,totalReviews:f||o.length,thumbsUp:L,thumbsDown:d,conversionRate:a,unreplied:D,last30Up:q,last7Up:x,last30Total:i.length}},[_,o,b,f]),c=l||A,z=h=>h>=80?"Excellent":h>=60?"Good":h>=40?"Fair":"Needs Attention";return c?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"grid lg:grid-cols-4 gap-4",children:[1,2,3,4].map(h=>e.jsx(U,{className:"h-32"},h))}),e.jsxs("div",{className:"grid lg:grid-cols-2 gap-6",children:[e.jsx(U,{className:"h-64"}),e.jsx(U,{className:"h-64"})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs(u,{className:"bg-gradient-to-br from-slate-800 to-slate-900 text-white border-0 shadow-lg overflow-hidden relative group",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"}),e.jsxs(p,{className:"p-5 relative",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-primary/20 flex items-center justify-center",children:e.jsx(ge,{className:"h-5 w-5 text-primary"})}),e.jsx(E,{className:m.reputationScore>=60?"bg-emerald-500/20 text-emerald-300 border-emerald-500/30":"bg-amber-500/20 text-amber-300 border-amber-500/30",children:z(m.reputationScore)})]}),e.jsx("p",{className:"text-4xl font-bold tracking-tight",children:m.reputationScore}),e.jsx("p",{className:"text-sm text-white/60 mt-1",children:"Reputation Score"}),e.jsx(ce,{value:m.reputationScore,className:"mt-3 h-1.5 bg-white/10"})]})]}),e.jsx(u,{className:"border shadow-sm hover:shadow-md transition-all group",children:e.jsxs(p,{className:"p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-amber-100 flex items-center justify-center",children:e.jsx(se,{className:"h-5 w-5 text-amber-500 fill-amber-500"})}),e.jsx(E,{variant:"outline",className:"text-xs",children:"Google"})]}),e.jsx("p",{className:"text-3xl font-bold",children:m.avgRating?m.avgRating.toFixed(1):"N/A"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[m.totalReviews," reviews"]}),e.jsx("div",{className:"flex gap-0.5 mt-2",children:[1,2,3,4,5].map(h=>e.jsx(se,{className:`h-3.5 w-3.5 ${h<=Math.round(m.avgRating)?"text-amber-500 fill-amber-500":"text-muted/30"}`},h))})]})}),e.jsx(u,{className:"border shadow-sm hover:shadow-md transition-all group",children:e.jsxs(p,{className:"p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-emerald-100 flex items-center justify-center",children:e.jsx(xe,{className:"h-5 w-5 text-emerald-600"})}),e.jsxs(E,{className:"bg-emerald-100 text-emerald-700 text-xs",children:["+",m.last7Up," week"]})]}),e.jsx("p",{className:"text-3xl font-bold",children:m.thumbsUp}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Sent to Google"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1.5",children:[m.conversionRate.toFixed(0),"% conversion rate"]})]})}),e.jsx(u,{className:pe("border shadow-sm hover:shadow-md transition-all",m.unreplied>3&&"border-red-300 bg-red-50/30"),children:e.jsxs(p,{className:"p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-blue-100 flex items-center justify-center",children:e.jsx(ae,{className:"h-5 w-5 text-blue-600"})}),m.unreplied>3&&e.jsx(E,{variant:"destructive",className:"text-xs",children:"Action Needed"})]}),e.jsx("p",{className:"text-3xl font-bold",children:m.unreplied}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Unreplied Reviews"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1.5",children:[m.thumbsDown," negative feedback"]})]})})]}),e.jsxs("div",{className:"grid lg:grid-cols-2 gap-6",children:[e.jsxs(u,{className:"shadow-sm",children:[e.jsxs(H,{className:"pb-4",children:[e.jsxs(Y,{className:"flex items-center gap-2 text-lg",children:[e.jsx(ge,{className:"h-5 w-5 text-primary"}),"Quick Actions"]}),e.jsx(I,{children:"Manage your reputation"})]}),e.jsxs(p,{className:"space-y-3",children:[e.jsxs(w,{onClick:g,className:"w-full justify-start gap-3 h-12 rounded-xl bg-gradient-to-r from-primary to-teal text-white shadow-md hover:shadow-lg transition-all",children:[e.jsx(X,{className:"h-5 w-5"}),"Send Review Request",e.jsx(Te,{className:"h-4 w-4 ml-auto"})]}),e.jsxs(w,{onClick:y,variant:"outline",className:"w-full justify-start gap-3 h-12 rounded-xl",children:[e.jsx(he,{className:"h-5 w-5"}),"Generate QR Code",e.jsx(Te,{className:"h-4 w-4 ml-auto"})]}),e.jsxs(w,{onClick:s,variant:"outline",className:"w-full justify-start gap-3 h-12 rounded-xl",children:[e.jsx(Be,{className:"h-5 w-5"}),"Sync Google Reviews",e.jsx(Te,{className:"h-4 w-4 ml-auto"})]})]})]}),e.jsxs(u,{className:"shadow-sm",children:[e.jsxs(H,{className:"pb-4",children:[e.jsxs(Y,{className:"flex items-center gap-2 text-lg",children:[e.jsx(De,{className:"h-5 w-5 text-primary"}),"Recent Activity"]}),e.jsx(I,{children:"Latest reviews and feedback"})]}),e.jsx(p,{children:e.jsx(be,{className:"h-[220px]",children:e.jsxs("div",{className:"space-y-3",children:[o.slice(0,5).map(h=>e.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-xl bg-muted/50 hover:bg-muted transition-colors",children:[e.jsx("div",{className:"flex gap-0.5 pt-0.5",children:[1,2,3,4,5].map(S=>e.jsx(se,{className:`h-3 w-3 ${S<=h.rating?"text-amber-500 fill-amber-500":"text-muted/50"}`},S))}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-sm truncate",children:h.author_name}),h.reply_status!=="posted"&&e.jsx(E,{variant:"destructive",className:"text-[10px] h-4",children:"Needs Reply"})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-1",children:h.text_content||"No comment"})]})]},h.id)),o.length===0&&e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(Ve,{className:"h-8 w-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No reviews yet"})]})]})})})]})]}),m.thumbsDown>0&&e.jsx(Ts,{clinicId:n,limit:10}),(m.unreplied>5||m.reputationScore<60)&&e.jsxs(u,{className:"border-2 border-amber-300 bg-amber-50/50 shadow-sm",children:[e.jsx(H,{className:"pb-3",children:e.jsxs(Y,{className:"flex items-center gap-2 text-amber-800",children:[e.jsx(Pe,{className:"h-5 w-5"}),"AI Insights & Recommendations"]})}),e.jsx(p,{children:e.jsxs("ul",{className:"space-y-3 text-sm text-amber-800",children:[m.unreplied>5&&e.jsxs("li",{className:"flex items-start gap-3 p-3 rounded-lg bg-white/60",children:[e.jsx(ae,{className:"h-5 w-5 mt-0.5 flex-shrink-0"}),e.jsxs("span",{children:["You have ",e.jsxs("strong",{children:[m.unreplied," unreplied reviews"]}),". Responding quickly improves your reputation score and shows patients you care."]})]}),m.reputationScore<60&&e.jsxs("li",{className:"flex items-start gap-3 p-3 rounded-lg bg-white/60",children:[e.jsx(ge,{className:"h-5 w-5 mt-0.5 flex-shrink-0"}),e.jsxs("span",{children:["Your reputation score is ",e.jsx("strong",{children:"below 60"}),". Focus on collecting more positive reviews and responding to feedback promptly."]})]}),m.thumbsDown>m.thumbsUp&&e.jsxs("li",{className:"flex items-start gap-3 p-3 rounded-lg bg-white/60",children:[e.jsx(le,{className:"h-5 w-5 mt-0.5 flex-shrink-0"}),e.jsxs("span",{children:["More patients are leaving ",e.jsx("strong",{children:"private feedback"})," than public reviews. Review the feedback to identify improvement areas."]})]})]})})]})]})}function Fs({clinicId:n,clinicName:k,googlePlaceId:v}){const b=Le(),[f,g]=j.useState(""),[y,s]=j.useState(!1),[_,l]=j.useState(!1),{data:o,isLoading:A}=Q({queryKey:["reputation-setup",n],queryFn:async()=>{const{data:d,error:a}=await C.from("dentist_settings").select("*").eq("clinic_id",n).maybeSingle();if(a)throw a;return d||{funnel_enabled:!0,funnel_threshold:4}}}),{data:m}=Q({queryKey:["gmb-token-data",n],queryFn:async()=>{const{data:d}=await C.from("clinic_oauth_tokens").select("gmb_data").eq("clinic_id",n).maybeSingle();return d}});j.useEffect(()=>{if(m?.gmb_data&&typeof m.gmb_data=="object"){const d=m.gmb_data;d.custom_review_url&&g(d.custom_review_url)}},[m]);const c=je({mutationFn:async d=>{const{error:a}=await C.from("dentist_settings").upsert({clinic_id:n,...d,updated_at:new Date().toISOString()});if(a)throw a;await es({action:"update_reputation_settings",entityType:"dentist_settings",entityId:n,newValues:d})},onSuccess:()=>{$.success("Settings saved"),b.invalidateQueries({queryKey:["reputation-setup"]})},onError:d=>$.error(d.message)}),z=async()=>{if(!f.trim()){$.error("Please enter a valid URL");return}try{new URL(f)}catch{$.error("Please enter a valid URL");return}s(!0);try{const{data:d}=await C.from("clinic_oauth_tokens").select("gmb_data").eq("clinic_id",n).maybeSingle(),a=d?.gmb_data||{};await C.from("clinic_oauth_tokens").upsert({clinic_id:n,gmb_data:{...a,custom_review_url:f.trim()}},{onConflict:"clinic_id"}),$.success("Review link saved"),b.invalidateQueries({queryKey:["gmb-token-data"]})}catch(d){$.error(d.message)}finally{s(!1)}},h=async()=>{l(!0);try{const{data:{session:d}}=await C.auth.getSession();if(!d?.user){$.error("Please sign in first");return}os(d.access_token,d.refresh_token||"",d.user.id),localStorage.setItem("gmb_relink_flow","true"),localStorage.setItem("gmb_restore_session","true");const a="https://www.appointpanda.ae/auth/callback?relink=true",{error:i}=await C.auth.signInWithOAuth({provider:"google",options:{scopes:"openid email profile https://www.googleapis.com/auth/business.manage",redirectTo:a,queryParams:{access_type:"offline",prompt:"consent select_account"}}});if(i)throw i}catch(d){$.error(d.message)}finally{l(!1)}},S=v?`https://search.google.com/local/writereview?placeid=${v}`:"",R=[{done:!!v||!!f,label:"Google Review Link"},{done:o?.funnel_enabled!==!1,label:"Review Funnel"},{done:!0,label:"Notifications"}],P=R.filter(d=>d.done).length,L=Math.round(P/R.length*100);return e.jsxs("div",{className:"space-y-6",children:[e.jsx(u,{className:"bg-gradient-to-r from-primary/10 via-teal/5 to-primary/10 border-primary/20",children:e.jsxs(p,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-lg",children:"Reputation Setup"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Configure your reputation management system"})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-3xl font-bold text-primary",children:[L,"%"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Complete"})]})]}),e.jsx(ce,{value:L,className:"h-2 mb-4"}),e.jsx("div",{className:"flex gap-4",children:R.map((d,a)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[d.done?e.jsx(de,{className:"h-4 w-4 text-emerald-500"}):e.jsx(Ae,{className:"h-4 w-4 text-amber-500"}),e.jsx("span",{className:d.done?"text-foreground":"text-muted-foreground",children:d.label})]},a))})]})}),e.jsxs(u,{children:[e.jsx(H,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-blue-100 flex items-center justify-center",children:e.jsx(cs,{className:"h-6 w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx(Y,{children:"Google Business Profile"}),e.jsx(I,{children:"Connect or manually configure your Google reviews"})]})]}),v?e.jsxs(E,{className:"bg-emerald-100 text-emerald-700 border-emerald-200",children:[e.jsx(de,{className:"h-3 w-3 mr-1"}),"Connected"]}):f?e.jsxs(E,{className:"bg-amber-100 text-amber-700 border-amber-200",children:[e.jsx(Qe,{className:"h-3 w-3 mr-1"}),"Manual Link"]}):e.jsxs(E,{variant:"outline",className:"border-red-200 text-red-600",children:[e.jsx(Ae,{className:"h-3 w-3 mr-1"}),"Not Configured"]})]})}),e.jsxs(p,{className:"space-y-6",children:[e.jsx("div",{className:"p-4 rounded-xl bg-muted/50 border",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"h-10 w-10 rounded-lg bg-white flex items-center justify-center border",children:e.jsx("img",{src:"https://www.gstatic.com/images/branding/product/2x/googleg_48dp.png",alt:"Google",className:"h-6 w-6"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold mb-1",children:"Connect via Google (Recommended)"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Automatically sync your Google Business Profile for seamless review management."}),e.jsxs(w,{onClick:h,disabled:_,variant:"outline",children:[_?e.jsx(ne,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(Be,{className:"h-4 w-4 mr-2"}),v?"Reconnect":"Connect Google"]})]})]})}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx(js,{className:"w-full"})}),e.jsx("div",{className:"relative flex justify-center text-xs uppercase",children:e.jsx("span",{className:"bg-background px-2 text-muted-foreground",children:"Or"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qe,{className:"h-4 w-4 text-primary"}),e.jsx(M,{className:"font-medium",children:"Manual Google Review Link"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(B,{value:f,onChange:d=>g(d.target.value),placeholder:"https://g.page/r/your-business/review",className:"flex-1"}),e.jsx(w,{onClick:z,disabled:y,children:y?e.jsx(ne,{className:"h-4 w-4 animate-spin"}):e.jsx(ss,{className:"h-4 w-4"})})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Find your link at"," ",e.jsx("a",{href:"https://support.google.com/business/answer/7035772",target:"_blank",rel:"noopener noreferrer",className:"text-primary hover:underline",children:"Google Business Profile ‚Üí Share Review Link"})]})]}),(v||f)&&e.jsx("div",{className:"p-3 rounded-lg bg-emerald-50 border border-emerald-200",children:e.jsxs("div",{className:"flex items-center gap-2 text-emerald-700",children:[e.jsx(de,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Active Review Link:"}),e.jsxs("a",{href:f||S,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-primary hover:underline flex items-center gap-1",children:[(f||S).slice(0,50),"...",e.jsx(ts,{className:"h-3 w-3"})]})]})})]})]}),e.jsxs(u,{children:[e.jsx(H,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(ds,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx(Y,{children:"Review Funnel"}),e.jsx(I,{children:"Control how patients are routed based on satisfaction"})]})]})}),e.jsxs(p,{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl bg-muted/50 border",children:[e.jsxs("div",{children:[e.jsx(M,{className:"font-medium",children:"Enable Review Funnel"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Route patients through satisfaction check before reviews"})]}),e.jsx(ie,{checked:o?.funnel_enabled??!0,onCheckedChange:d=>c.mutate({funnel_enabled:d})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(M,{className:"font-medium",children:"Positive Threshold (1-5)"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(B,{type:"number",min:1,max:5,value:o?.funnel_threshold??4,onChange:d=>c.mutate({funnel_threshold:parseInt(d.target.value)||4}),className:"w-24"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Ratings at or above this redirect to Google"})]})]}),e.jsxs("div",{className:"p-4 rounded-xl bg-muted/30 border",children:[e.jsx("h4",{className:"font-medium mb-4",children:"How It Works"}),e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"h-12 w-12 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-2",children:e.jsx(qe,{className:"h-5 w-5 text-primary"})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Patient scans"})]}),e.jsx(He,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"h-12 w-12 rounded-full bg-amber-100 flex items-center justify-center mx-auto mb-2",children:e.jsx(Oe,{className:"h-5 w-5 text-amber-600"})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Rates experience"})]}),e.jsx(He,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"h-12 w-12 rounded-full bg-emerald-100 flex items-center justify-center mx-auto mb-2",children:e.jsx(xe,{className:"h-5 w-5 text-emerald-600"})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"‚Üí Google"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"h-12 w-12 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-2",children:e.jsx(le,{className:"h-5 w-5 text-red-600"})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"‚Üí Private"})]})]})]})]})]})]}),e.jsxs(u,{children:[e.jsx(H,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-amber-100 flex items-center justify-center",children:e.jsx(Re,{className:"h-6 w-6 text-amber-600"})}),e.jsxs("div",{children:[e.jsx(Y,{children:"Notifications"}),e.jsx(I,{children:"Configure alerts for reputation events"})]})]})}),e.jsxs(p,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl bg-muted/50 border",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(me,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx(M,{className:"font-medium",children:"Email Alerts"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Receive email for negative feedback"})]})]}),e.jsx(ie,{defaultChecked:!0})]}),e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl bg-muted/50 border",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ae,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx(M,{className:"font-medium",children:"Rating Drop Alerts"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Alert when rating drops significantly"})]})]}),e.jsx(ie,{defaultChecked:!0})]}),e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl bg-muted/50 border",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(qe,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx(M,{className:"font-medium",children:"Dashboard Notifications"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Show alerts in your dashboard"})]})]}),e.jsx(ie,{defaultChecked:!0})]})]})]})]})}const Fe=[{id:"modern",name:"Modern",gradient:"from-primary to-teal",colors:{from:"#0ea5e9",to:"#14b8a6"}},{id:"classic",name:"Classic",gradient:"from-slate-800 to-slate-900",colors:{from:"#1e293b",to:"#0f172a"}},{id:"warm",name:"Warm",gradient:"from-amber-500 to-orange-600",colors:{from:"#f59e0b",to:"#ea580c"}},{id:"fresh",name:"Fresh",gradient:"from-emerald-500 to-teal-600",colors:{from:"#10b981",to:"#0d9488"}},{id:"purple",name:"Purple",gradient:"from-purple-500 to-pink-500",colors:{from:"#8b5cf6",to:"#ec4899"}},{id:"dark",name:"Dark",gradient:"from-gray-900 to-gray-800",colors:{from:"#111827",to:"#1f2937"}}];function Ms({clinicId:n,clinicName:k,clinicSlug:v}){const b=j.useRef(null),f=j.useRef(null),g=Le(),y={selectedStyle:"modern",customTitle:k,customSubtitle:"Share your experience with us!",customCTA:"How did we do?",customFooter:"Your feedback helps us improve.",showStars:!0,showLogo:!1,customLogo:null,showBranding:!0},[s,_]=j.useState(y),[l,o]=j.useState("preview"),[A,m]=j.useState(!1);j.useState(!1);const[c,z]=j.useState(!1),h=`${window.location.origin}/review/${v}?source=qr_code`,S=Fe.find(x=>x.id===s.selectedStyle)||Fe[0],{data:R}=Q({queryKey:["qr-settings",n],queryFn:async()=>{const{data:x}=await C.from("clinic_oauth_tokens").select("gmb_data").eq("clinic_id",n).maybeSingle();return x?.gmb_data&&typeof x.gmb_data=="object"&&x.gmb_data.qr_settings||null}}),{data:P}=Q({queryKey:["qr-scan-stats",n],queryFn:async()=>{const x=W(new Date,30).toISOString(),{data:D,error:O}=await C.from("review_funnel_events").select("created_at, event_type, source").eq("clinic_id",n).eq("source","qr_code").gte("created_at",x);if(O)return{total:0,conversions:0,rate:0};const T=D?.length||0,K=D?.filter(re=>re.event_type==="thumbs_up").length||0;return{total:T,conversions:K,rate:T>0?Math.round(K/T*100):0}}});j.useEffect(()=>{R&&_({...y,...R,customTitle:R.customTitle||k})},[R,k]);const L=x=>{_(D=>({...D,...x})),z(!0)},d=je({mutationFn:async x=>{const{data:D}=await C.from("clinic_oauth_tokens").select("gmb_data").eq("clinic_id",n).maybeSingle(),T={...D?.gmb_data||{},qr_settings:x};D?await C.from("clinic_oauth_tokens").update({gmb_data:T}).eq("clinic_id",n):await C.from("clinic_oauth_tokens").insert({clinic_id:n,gmb_data:T})},onSuccess:()=>{g.invalidateQueries({queryKey:["qr-settings",n]}),z(!1),$.success("QR code settings saved!")},onError:x=>$.error(x.message)}),a=x=>{const D=x.target.files?.[0];if(D){const O=new FileReader;O.onloadend=()=>{L({customLogo:O.result,showLogo:!0})},O.readAsDataURL(D)}},i=async()=>{if(b.current){m(!0);try{const x=await Ns(b.current,{scale:2,useCORS:!0,allowTaint:!0,backgroundColor:"#ffffff"}),D=document.createElement("a");D.download=`${v}-review-qr.png`,D.href=x.toDataURL("image/png"),D.click(),$.success("QR code downloaded!")}catch{$.error("Failed to download")}finally{m(!1)}}},F=()=>{const x=window.open("","_blank");x&&(x.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Review QR - ${s.customTitle}</title>
        <style>
          @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
          * { margin: 0; padding: 0; box-sizing: border-box; }
          @media print { @page { size: auto; margin: 0; } body { -webkit-print-color-adjust: exact !important; } }
          body { font-family: 'Inter', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: white; padding: 20px; }
          .card { width: 400px; border-radius: 24px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); background: white; border: 1px solid #e2e8f0; }
          .header { background: linear-gradient(135deg, ${S.colors.from}, ${S.colors.to}) !important; padding: 40px 24px 30px; text-align: center; color: white !important; -webkit-print-color-adjust: exact !important; }
          .header h1 { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
          .header p { font-size: 14px; opacity: 0.9; margin-bottom: 14px; }
          .stars { font-size: 18px; letter-spacing: 4px; color: #fbbf24 !important; }
          .qr-section { padding: 36px; text-align: center; background: white !important; }
          .qr-wrapper { display: inline-block; padding: 20px; background: #f8fafc !important; border-radius: 20px; border: 2px solid #e2e8f0; }
          .scan-hint { margin-top: 18px; padding: 10px 18px; background: #f1f5f9 !important; border-radius: 12px; font-size: 13px; color: #475569 !important; }
          .instructions { padding: 0 36px 36px; text-align: center; }
          .instructions h2 { font-size: 20px; font-weight: 700; color: #1e293b !important; margin-bottom: 10px; }
          .instructions p { font-size: 13px; color: #64748b !important; }
          .footer { padding: 14px; text-align: center; border-top: 1px solid #e2e8f0; color: #0ea5e9 !important; font-size: 11px; background: #fafafa !important; }
        </style>
      </head>
      <body>
        <div class="card">
          <div class="header">
            ${s.showLogo&&s.customLogo?`<img src="${s.customLogo}" alt="Logo" style="width:60px;height:60px;border-radius:50%;margin-bottom:12px;border:3px solid rgba(255,255,255,0.3);" />`:""}
            <h1>${s.customTitle}</h1>
            <p>${s.customSubtitle}</p>
            ${s.showStars?'<div class="stars">‚≠ê ‚≠ê ‚≠ê ‚≠ê ‚≠ê</div>':""}
          </div>
          <div class="qr-section">
            <div class="qr-wrapper">${document.querySelector("#qr-code-svg")?.outerHTML||""}</div>
            <div class="scan-hint">üì± Scan with your phone camera</div>
          </div>
          <div class="instructions">
            <h2>${s.customCTA}</h2>
            <p>${s.customFooter}</p>
          </div>
          ${s.showBranding?'<div class="footer">Powered by AppointPanda</div>':""}
        </div>
        <script>window.onload = function() { setTimeout(function() { window.print(); window.close(); }, 500); }<\/script>
      </body>
      </html>
    `),x.document.close())},q=async()=>{await navigator.clipboard.writeText(h),$.success("Link copied!")};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[e.jsx(u,{children:e.jsx(p,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(he,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:P?.total||0}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Scans"})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-emerald-100 flex items-center justify-center",children:e.jsx(Ke,{className:"h-6 w-6 text-emerald-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:P?.conversions||0}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Conversions"})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-amber-100 flex items-center justify-center",children:e.jsx(bs,{className:"h-6 w-6 text-amber-600"})}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-2xl font-bold",children:[P?.rate||0,"%"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Conversion Rate"})]})]})})})]}),e.jsxs(u,{children:[e.jsx(H,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-5 w-5 text-primary"}),"QR Code Studio"]}),e.jsx(I,{children:"Create print-ready QR codes for in-clinic use"})]}),e.jsx("div",{className:"flex gap-2",children:c&&e.jsxs(w,{onClick:()=>d.mutate(s),disabled:d.isPending,children:[d.isPending?e.jsx(ne,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(ss,{className:"h-4 w-4 mr-2"}),"Save Design"]})})]})}),e.jsx(p,{children:e.jsxs(Je,{value:l,onValueChange:o,children:[e.jsxs(Xe,{className:"grid w-full grid-cols-2 mb-6",children:[e.jsxs(Ue,{value:"preview",className:"gap-2",children:[e.jsx(Ve,{className:"h-4 w-4"}),"Preview"]}),e.jsxs(Ue,{value:"customize",className:"gap-2",children:[e.jsx(ps,{className:"h-4 w-4"}),"Customize"]})]}),e.jsx(ee,{value:"preview",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3 justify-center p-4 bg-muted/50 rounded-xl",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Theme:"}),Fe.map(x=>e.jsx("button",{onClick:()=>L({selectedStyle:x.id}),className:`h-8 w-8 rounded-full bg-gradient-to-br ${x.gradient} transition-all ${s.selectedStyle===x.id?"ring-2 ring-offset-2 ring-primary scale-110":"opacity-70 hover:opacity-100"}`,title:x.name},x.id))]}),e.jsx("div",{ref:b,className:"mx-auto max-w-sm",children:e.jsxs(u,{className:"overflow-hidden shadow-2xl border-0",style:{backgroundColor:"#ffffff"},children:[e.jsxs("div",{className:`bg-gradient-to-r ${S.gradient} p-6 text-center text-white`,children:[s.showLogo&&s.customLogo&&e.jsx("img",{src:s.customLogo,alt:"Logo",className:"h-14 w-14 rounded-full object-cover mx-auto mb-3 border-2 border-white/30"}),e.jsx("h2",{className:"text-xl font-bold mb-1.5",children:s.customTitle}),e.jsx("p",{className:"text-sm opacity-90 mb-2",children:s.customSubtitle}),s.showStars&&e.jsx("div",{className:"flex justify-center gap-1",children:[1,2,3,4,5].map(x=>e.jsx(se,{className:"h-4 w-4 text-yellow-400 fill-yellow-400"},x))})]}),e.jsxs(p,{className:"p-8 flex flex-col items-center bg-white",children:[e.jsx("div",{className:"p-4 bg-slate-50 rounded-2xl border-2 border-slate-100",children:e.jsx(fs,{id:"qr-code-svg",value:h,size:180,level:"H",bgColor:"#f8fafc",fgColor:"#0f172a"})}),e.jsxs("div",{className:"mt-4 flex items-center gap-2 px-3 py-2 bg-slate-100 rounded-xl",children:[e.jsx(qe,{className:"h-4 w-4 text-slate-500"}),e.jsx("span",{className:"text-xs text-slate-600",children:"Scan with your phone camera"})]})]}),e.jsxs("div",{className:"px-6 pb-6 text-center bg-white",children:[e.jsx("h3",{className:"font-bold text-lg mb-2 text-slate-800",children:s.customCTA}),e.jsx("p",{className:"text-sm text-slate-500",children:s.customFooter})]}),s.showBranding&&e.jsx("div",{className:"border-t border-slate-100 py-3 text-center bg-slate-50",children:e.jsxs("span",{className:"text-xs text-slate-400",children:["Powered by ",e.jsx("span",{className:"font-semibold text-primary",children:"AppointPanda"})]})})]})}),e.jsxs("div",{className:"flex justify-center gap-3",children:[e.jsxs(w,{onClick:i,variant:"outline",disabled:A,children:[A?e.jsx(ne,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(ys,{className:"h-4 w-4 mr-2"}),"Download PNG"]}),e.jsxs(w,{onClick:F,children:[e.jsx(vs,{className:"h-4 w-4 mr-2"}),"Print"]}),e.jsxs(w,{variant:"outline",onClick:q,children:[e.jsx(as,{className:"h-4 w-4 mr-2"}),"Copy Link"]})]})]})}),e.jsx(ee,{value:"customize",children:e.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h4",{className:"font-semibold flex items-center gap-2",children:[e.jsx(Ss,{className:"h-4 w-4 text-primary"}),"Text & Content"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:"Title"}),e.jsx(B,{value:s.customTitle,onChange:x=>L({customTitle:x.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:"Subtitle"}),e.jsx(B,{value:s.customSubtitle,onChange:x=>L({customSubtitle:x.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:"Call to Action"}),e.jsx(B,{value:s.customCTA,onChange:x=>L({customCTA:x.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:"Footer Text"}),e.jsx(B,{value:s.customFooter,onChange:x=>L({customFooter:x.target.value})})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h4",{className:"font-semibold flex items-center gap-2",children:[e.jsx(_s,{className:"h-4 w-4 text-primary"}),"Display Options"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg bg-muted/50",children:[e.jsx(M,{children:"Show Stars"}),e.jsx(ie,{checked:s.showStars,onCheckedChange:x=>L({showStars:x})})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg bg-muted/50",children:[e.jsx(M,{children:"Show AppointPanda Branding"}),e.jsx(ie,{checked:s.showBranding,onCheckedChange:x=>L({showBranding:x})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:"Custom Logo"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{ref:f,type:"file",accept:"image/*",className:"hidden",onChange:a}),e.jsxs(w,{variant:"outline",onClick:()=>f.current?.click(),children:[e.jsx(Cs,{className:"h-4 w-4 mr-2"}),"Upload Logo"]}),s.customLogo&&e.jsx(w,{variant:"outline",onClick:()=>L({customLogo:null,showLogo:!1}),children:"Remove"})]}),s.customLogo&&e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx("img",{src:s.customLogo,alt:"Logo preview",className:"h-10 w-10 rounded-full object-cover"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Logo uploaded"})]})]})]})]})]})})]})})]})]})}const Me=[{id:"1",type:"rating",question:"How would you rate your overall experience?",required:!0},{id:"2",type:"yesno",question:"Would you recommend us to friends and family?",required:!0},{id:"3",type:"text",question:"What could we do better?",required:!1}];function Es({clinicId:n,clinicName:k}){const v=Le(),[b,f]=j.useState(!1),[g,y]=j.useState(null),[s,_]=j.useState(""),[l,o]=j.useState(Me),[A,m]=j.useState(!1),[c,z]=j.useState("email"),[h,S]=j.useState(""),[R,P]=j.useState(""),{data:L=[],isLoading:d}=Q({queryKey:["clinic-surveys",n],queryFn:async()=>{const{data:r}=await C.from("global_settings").select("value").eq("key",`survey_templates_${n}`).maybeSingle();return r?.value?Array.isArray(r.value)?r.value:[]:[]}}),{data:a=[],isLoading:i}=Q({queryKey:["negative-feedback",n],queryFn:async()=>{const{data:r}=await C.from("review_funnel_events").select("*").eq("clinic_id",n).eq("event_type","thumbs_down").order("created_at",{ascending:!1}).limit(100);return r||[]}}),F=j.useMemo(()=>{const t=W(new Date,30),N=a.filter(J=>new Date(J.created_at)>=t),Z=[0,0,0,0,0];a.forEach(J=>{J.rating&&J.rating>=1&&J.rating<=5&&Z[J.rating-1]++});const V=a.length>0?a.reduce((J,is)=>J+(is.rating||0),0)/a.filter(J=>J.rating).length:0;return{totalResponses:a.length,last30Responses:N.length,avgRating:V||0,ratingBreakdown:Z,withComments:a.filter(J=>J.comment).length}},[a]),q=je({mutationFn:async()=>{const r={id:g?.id||crypto.randomUUID(),name:s,questions:l,is_active:!0,version:g?(g.version||0)+1:1,created_at:g?.created_at||new Date().toISOString(),updated_at:new Date().toISOString()},t=g?L.map(N=>N.id===g.id?{...N,is_active:!1}:N).concat([r]):[...L,r];await C.from("global_settings").upsert({key:`survey_templates_${n}`,value:t,updated_at:new Date().toISOString()}),await es({action:g?"update_survey":"create_survey",entityType:"survey_template",entityId:r.id,newValues:r})},onSuccess:()=>{$.success(g?"Survey updated (new version created)":"Survey created"),v.invalidateQueries({queryKey:["clinic-surveys"]}),O()},onError:r=>$.error(r.message)}),x=je({mutationFn:async()=>{const{error:r}=await C.functions.invoke("send-review-request",{body:{clinicId:n,recipientName:h,recipientEmail:c==="email"?R:void 0,recipientPhone:c!=="email"?R:void 0,channel:c,customMessage:`Hi ${h}, we'd love to hear about your experience at ${k}. Please take a moment to share your feedback.`,type:"survey"}});if(r)throw r},onSuccess:()=>{$.success("Survey sent!"),m(!1),S(""),P("")},onError:r=>$.error(r.message)}),D=r=>{r?(y(r),_(r.name),o(r.questions)):(y(null),_(""),o(Me)),f(!0)},O=()=>{f(!1),y(null),_(""),o(Me)},T=()=>{o([...l,{id:crypto.randomUUID(),type:"text",question:"",required:!1}])},K=(r,t)=>{o(l.map(N=>N.id===r?{...N,...t}:N))},re=r=>{o(l.filter(t=>t.id!==r))},te=L.filter(r=>r.is_active);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid md:grid-cols-4 gap-4",children:[e.jsx(u,{children:e.jsx(p,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(ae,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:F.totalResponses}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Responses"})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-amber-100 flex items-center justify-center",children:e.jsx(se,{className:"h-6 w-6 text-amber-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:F.avgRating.toFixed(1)}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Avg Satisfaction"})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-emerald-100 flex items-center justify-center",children:e.jsx(Ke,{className:"h-6 w-6 text-emerald-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:F.last30Responses}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Last 30 Days"})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-blue-100 flex items-center justify-center",children:e.jsx(ye,{className:"h-6 w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:F.withComments}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"With Comments"})]})]})})})]}),e.jsxs("div",{className:"grid lg:grid-cols-2 gap-6",children:[e.jsxs(u,{children:[e.jsx(H,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(ye,{className:"h-5 w-5 text-primary"}),"Survey Templates"]}),e.jsx(I,{children:"Create and manage feedback surveys"})]}),e.jsxs(w,{onClick:()=>D(),size:"sm",children:[e.jsx(ze,{className:"h-4 w-4 mr-2"}),"New Survey"]})]})}),e.jsx(p,{children:d?e.jsx("div",{className:"space-y-3",children:[1,2].map(r=>e.jsx(U,{className:"h-20"},r))}):te.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ye,{className:"h-12 w-12 mx-auto text-muted-foreground/50 mb-4"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"No survey templates yet"}),e.jsx(w,{onClick:()=>D(),variant:"outline",children:"Create Your First Survey"})]}):e.jsx("div",{className:"space-y-3",children:te.map(r=>e.jsxs("div",{className:"p-4 rounded-xl border bg-card",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:r.name}),e.jsxs(E,{variant:"outline",className:"text-xs",children:["v",r.version]}),e.jsx(E,{className:"bg-emerald-100 text-emerald-700 text-xs",children:"Active"})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(w,{size:"sm",variant:"ghost",onClick:()=>D(r),children:e.jsx(ks,{className:"h-4 w-4"})}),e.jsx(w,{size:"sm",variant:"ghost",onClick:()=>m(!0),children:e.jsx(X,{className:"h-4 w-4"})})]})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[r.questions.length," questions ‚Ä¢ Updated ",oe(new Date(r.updated_at),"MMM d, yyyy")]})]},r.id))})})]}),e.jsxs(u,{children:[e.jsxs(H,{children:[e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-5 w-5 text-red-500"}),"Private Feedback"]}),e.jsx(I,{children:"Negative feedback captured privately"})]}),e.jsx(p,{children:i?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(r=>e.jsx(U,{className:"h-16"},r))}):a.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(de,{className:"h-12 w-12 mx-auto text-emerald-500/50 mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"No negative feedback. Great work!"})]}):e.jsx(be,{className:"h-[400px]",children:e.jsx("div",{className:"space-y-3 pr-4",children:a.slice(0,20).map(r=>e.jsxs("div",{className:"p-3 rounded-lg bg-muted/50 border",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[r.rating&&e.jsx("div",{className:"flex gap-0.5",children:[1,2,3,4,5].map(t=>e.jsx(se,{className:`h-3 w-3 ${t<=r.rating?"text-amber-500 fill-amber-500":"text-muted"}`},t))}),e.jsx("span",{className:"text-xs text-muted-foreground",children:oe(new Date(r.created_at),"MMM d, HH:mm")})]}),r.comment&&e.jsx("p",{className:"text-sm",children:r.comment})]},r.id))})})})]})]}),e.jsx(Se,{open:b,onOpenChange:f,children:e.jsxs(_e,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(Ce,{children:[e.jsx(ke,{children:g?"Edit Survey":"Create Survey"}),e.jsx(Ee,{children:g&&"Editing creates a new version. Previous version will be archived."})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:"Survey Name"}),e.jsx(B,{value:s,onChange:r=>_(r.target.value),placeholder:"e.g., Post-Visit Feedback"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(M,{children:"Questions"}),e.jsxs(w,{size:"sm",variant:"outline",onClick:T,children:[e.jsx(ze,{className:"h-4 w-4 mr-1"}),"Add Question"]})]}),l.map((r,t)=>e.jsxs("div",{className:"p-4 rounded-lg border bg-muted/30 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm font-medium",children:["Question ",t+1]}),e.jsx(w,{size:"sm",variant:"ghost",onClick:()=>re(r.id),children:e.jsx(Rs,{className:"h-4 w-4 text-destructive"})})]}),e.jsx(B,{value:r.question,onChange:N=>K(r.id,{question:N.target.value}),placeholder:"Enter question..."}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(fe,{value:r.type,onValueChange:N=>K(r.id,{type:N}),children:[e.jsx(ve,{className:"w-[150px]",children:e.jsx(Ne,{})}),e.jsxs(we,{children:[e.jsx(G,{value:"rating",children:"Rating (1-5)"}),e.jsx(G,{value:"yesno",children:"Yes/No"}),e.jsx(G,{value:"text",children:"Text Answer"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{checked:r.required,onCheckedChange:N=>K(r.id,{required:N})}),e.jsx(M,{className:"text-sm",children:"Required"})]})]})]},r.id))]})]}),e.jsxs($e,{children:[e.jsx(w,{variant:"outline",onClick:O,children:"Cancel"}),e.jsxs(w,{onClick:()=>q.mutate(),disabled:!s.trim()||q.isPending,children:[q.isPending&&e.jsx(ne,{className:"h-4 w-4 mr-2 animate-spin"}),g?"Save New Version":"Create Survey"]})]})]})}),e.jsx(Se,{open:A,onOpenChange:m,children:e.jsxs(_e,{children:[e.jsxs(Ce,{children:[e.jsx(ke,{children:"Send Survey"}),e.jsx(Ee,{children:"Send a feedback survey to a patient"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:"Recipient Name"}),e.jsx(B,{value:h,onChange:r=>S(r.target.value),placeholder:"Patient name"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:"Channel"}),e.jsx("div",{className:"flex gap-2",children:["email","sms","whatsapp"].map(r=>e.jsxs(w,{variant:c===r?"default":"outline",size:"sm",onClick:()=>z(r),className:"capitalize",children:[r==="email"?e.jsx(me,{className:"h-4 w-4 mr-1"}):e.jsx(qe,{className:"h-4 w-4 mr-1"}),r]},r))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:c==="email"?"Email":"Phone Number"}),e.jsx(B,{value:R,onChange:r=>P(r.target.value),placeholder:c==="email"?"email@example.com":"+1234567890"})]})]}),e.jsxs($e,{children:[e.jsx(w,{variant:"outline",onClick:()=>m(!1),children:"Cancel"}),e.jsxs(w,{onClick:()=>x.mutate(),disabled:!h||!R||x.isPending,children:[x.isPending&&e.jsx(ne,{className:"h-4 w-4 mr-2 animate-spin"}),"Send Survey"]})]})]})})]})}function $s({clinicId:n,rating:k,reviewCount:v}){const{data:b=[],isLoading:f}=Q({queryKey:["reputation-score-funnel",n],queryFn:async()=>{const{data:o}=await C.from("review_funnel_events").select("*").eq("clinic_id",n).order("created_at",{ascending:!1}).limit(500);return o||[]}}),{data:g=[],isLoading:y}=Q({queryKey:["reputation-score-reviews",n],queryFn:async()=>{const{data:o}=await C.from("google_reviews").select("*").eq("clinic_id",n).order("review_time",{ascending:!1}).limit(200);return o||[]}}),s=j.useMemo(()=>{const o=new Date,A=W(o,30),m=b.length,c=b.filter(T=>T.event_type==="thumbs_up").length,z=b.filter(T=>T.event_type==="thumbs_down").length,S=b.filter(T=>new Date(T.created_at)>=A).filter(T=>T.event_type==="thumbs_up").length,R=g.filter(T=>T.reply_status!=="posted").length,P=k||0,L=Math.round(P/5*40),d=Math.round(Math.min(S/10,1)*25),a=g.length>0?Math.round((g.length-R)/g.length*20):10,i=m>0?Math.round(c/m*15):8,F=L+d+a+i,q=W(o,60),D=b.filter(T=>{const K=new Date(T.created_at);return K>=q&&K<A}).filter(T=>T.event_type==="thumbs_up").length,O=S-D;return{totalScore:F,ratingScore:L,velocityScore:d,responseScore:a,sentimentScore:i,avgRating:P,thumbsUp:c,thumbsDown:z,unreplied:R,last30Up:S,trend:O,totalReviews:v||g.length}},[b,g,k,v]);if(f||y)return e.jsxs("div",{className:"space-y-6",children:[e.jsx(U,{className:"h-48"}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsx(U,{className:"h-32"}),e.jsx(U,{className:"h-32"})]})]});const _=o=>o>=80?"from-emerald-500 to-teal-500":o>=60?"from-primary to-teal":o>=40?"from-amber-500 to-orange-500":"from-red-500 to-rose-500",l=o=>o>=80?"Excellent":o>=60?"Good":o>=40?"Fair":"Needs Attention";return e.jsxs("div",{className:"space-y-6",children:[e.jsx(u,{className:`bg-gradient-to-br ${_(s.totalScore)} text-white`,children:e.jsx(p,{className:"p-8",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-white/80 text-lg mb-2",children:"Your Reputation Score"}),e.jsx("p",{className:"text-7xl font-bold mb-2",children:s.totalScore}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"bg-white/20 text-white border-0",children:l(s.totalScore)}),s.trend!==0&&e.jsxs(E,{className:`border-0 ${s.trend>0?"bg-white/20":"bg-red-500/30"}`,children:[s.trend>0?e.jsx(qs,{className:"h-3 w-3 mr-1"}):e.jsx(Ls,{className:"h-3 w-3 mr-1"}),Math.abs(s.trend)," this month"]})]})]}),e.jsx("div",{className:"text-right",children:e.jsx("div",{className:"h-32 w-32 rounded-full border-8 border-white/30 flex items-center justify-center",children:e.jsx(ge,{className:"h-16 w-16 text-white/80"})})})]})})}),e.jsxs(u,{children:[e.jsxs(H,{children:[e.jsx(Y,{children:"Score Breakdown"}),e.jsx(I,{children:"How your reputation score is calculated"})]}),e.jsxs(p,{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-5 w-5 text-amber-500"}),e.jsx("span",{className:"font-medium",children:"Average Rating"})]}),e.jsxs("span",{className:"font-bold text-lg",children:[s.ratingScore,"/40"]})]}),e.jsx(ce,{value:s.ratingScore/40*100,className:"h-3"}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[s.avgRating.toFixed(1)," stars from ",s.totalReviews," reviews"]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ke,{className:"h-5 w-5 text-emerald-500"}),e.jsx("span",{className:"font-medium",children:"Review Velocity"})]}),e.jsxs("span",{className:"font-bold text-lg",children:[s.velocityScore,"/25"]})]}),e.jsx(ce,{value:s.velocityScore/25*100,className:"h-3"}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[s.last30Up," new positive reviews in the last 30 days"]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-5 w-5 text-blue-500"}),e.jsx("span",{className:"font-medium",children:"Response Rate"})]}),e.jsxs("span",{className:"font-bold text-lg",children:[s.responseScore,"/20"]})]}),e.jsx(ce,{value:s.responseScore/20*100,className:"h-3"}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[s.unreplied," reviews awaiting response"]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-medium",children:"Patient Sentiment"})]}),e.jsxs("span",{className:"font-bold text-lg",children:[s.sentimentScore,"/15"]})]}),e.jsx(ce,{value:s.sentimentScore/15*100,className:"h-3"}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[s.thumbsUp," positive vs ",s.thumbsDown," private feedback"]})]})]})]}),e.jsxs("div",{className:"grid md:grid-cols-4 gap-4",children:[e.jsx(u,{children:e.jsxs(p,{className:"p-6 text-center",children:[e.jsx(se,{className:"h-8 w-8 text-amber-500 mx-auto mb-2"}),e.jsx("p",{className:"text-2xl font-bold",children:s.avgRating.toFixed(1)}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Average Rating"})]})}),e.jsx(u,{children:e.jsxs(p,{className:"p-6 text-center",children:[e.jsx(xe,{className:"h-8 w-8 text-emerald-500 mx-auto mb-2"}),e.jsx("p",{className:"text-2xl font-bold",children:s.thumbsUp}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Positive Funnel"})]})}),e.jsx(u,{children:e.jsxs(p,{className:"p-6 text-center",children:[e.jsx(le,{className:"h-8 w-8 text-red-500 mx-auto mb-2"}),e.jsx("p",{className:"text-2xl font-bold",children:s.thumbsDown}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Private Feedback"})]})}),e.jsx(u,{children:e.jsxs(p,{className:"p-6 text-center",children:[e.jsx(ae,{className:"h-8 w-8 text-blue-500 mx-auto mb-2"}),e.jsx("p",{className:"text-2xl font-bold",children:s.totalReviews}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Reviews"})]})})]})]})}function Us({clinicId:n,rating:k}){const{data:v=[],isLoading:b}=Q({queryKey:["alerts-funnel",n],queryFn:async()=>{const{data:c}=await C.from("review_funnel_events").select("*").eq("clinic_id",n).order("created_at",{ascending:!1}).limit(500);return c||[]}}),{data:f=[],isLoading:g}=Q({queryKey:["alerts-reviews",n],queryFn:async()=>{const{data:c}=await C.from("google_reviews").select("*").eq("clinic_id",n).order("review_time",{ascending:!1}).limit(100);return c||[]}}),y=j.useMemo(()=>{const c=new Date,z=W(c,7),h=W(c,30),S=[],R=f.filter(d=>d.reply_status!=="posted");R.length>3&&S.push({id:"unreplied",type:"unreplied",severity:R.length>10?"high":"medium",title:`${R.length} Unreplied Reviews`,description:"Responding to reviews quickly improves your reputation and shows patients you care.",timestamp:c,actionable:!0}),k&&k<4&&S.push({id:"low_rating",type:"rating_drop",severity:k<3.5?"high":"medium",title:"Rating Below 4.0",description:`Your current rating is ${k.toFixed(1)}. Focus on improving patient experience and collecting positive reviews.`,timestamp:c,actionable:!0});const P=v.filter(d=>d.event_type==="thumbs_down"&&new Date(d.created_at)>=z);return P.length>=5&&S.push({id:"negative_surge",type:"negative_surge",severity:"high",title:"Spike in Negative Feedback",description:`${P.length} patients gave negative feedback in the last 7 days. Review the feedback to identify issues.`,timestamp:c,actionable:!0}),v.filter(d=>d.event_type==="thumbs_up"&&new Date(d.created_at)>=h).length<5&&v.length>10&&S.push({id:"low_velocity",type:"low_velocity",severity:"medium",title:"Low Review Collection",description:"Only a few patients have been directed to leave reviews recently. Consider sending more review requests.",timestamp:c,actionable:!0}),S.length===0&&S.push({id:"all_good",type:"recommendation",severity:"low",title:"Your Reputation Looks Great!",description:"Keep up the good work. Continue collecting reviews and responding to feedback promptly.",timestamp:c,actionable:!1}),S},[v,f,k]);if(b||g)return e.jsx("div",{className:"space-y-4",children:[1,2,3].map(c=>e.jsx(U,{className:"h-24"},c))});const s=c=>{switch(c){case"high":return"border-red-500/50 bg-red-50";case"medium":return"border-amber-500/50 bg-amber-50";default:return"border-emerald-500/50 bg-emerald-50"}},_=c=>{switch(c){case"high":return e.jsx(E,{variant:"destructive",children:"High Priority"});case"medium":return e.jsx(E,{className:"bg-amber-100 text-amber-700",children:"Medium"});default:return e.jsx(E,{className:"bg-emerald-100 text-emerald-700",children:"Info"})}},l=c=>{switch(c){case"rating_drop":return e.jsx(Ds,{className:"h-5 w-5 text-red-500"});case"unreplied":return e.jsx(ae,{className:"h-5 w-5 text-blue-500"});case"negative_surge":return e.jsx(le,{className:"h-5 w-5 text-red-500"});case"low_velocity":return e.jsx(De,{className:"h-5 w-5 text-amber-500"});default:return e.jsx(Oe,{className:"h-5 w-5 text-emerald-500"})}},o=y.filter(c=>c.severity==="high"),A=y.filter(c=>c.severity==="medium"),m=y.filter(c=>c.severity==="low");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[e.jsx(u,{className:o.length>0?"border-red-500/50":"",children:e.jsx(p,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`h-12 w-12 rounded-xl flex items-center justify-center ${o.length>0?"bg-red-100":"bg-muted"}`,children:e.jsx(Pe,{className:`h-6 w-6 ${o.length>0?"text-red-500":"text-muted-foreground"}`})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:o.length}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"High Priority"})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-amber-100 flex items-center justify-center",children:e.jsx(Re,{className:"h-6 w-6 text-amber-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:A.length}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Medium Priority"})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-emerald-100 flex items-center justify-center",children:e.jsx(de,{className:"h-6 w-6 text-emerald-500"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:m.length}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Recommendations"})]})]})})})]}),e.jsxs(u,{children:[e.jsxs(H,{children:[e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(Re,{className:"h-5 w-5 text-primary"}),"Alerts & Insights"]}),e.jsx(I,{children:"Actionable recommendations for your reputation"})]}),e.jsx(p,{children:e.jsx("div",{className:"space-y-4",children:y.map(c=>e.jsx("div",{className:`p-4 rounded-xl border ${s(c.severity)}`,children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"mt-0.5",children:l(c.type)}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-semibold",children:c.title}),_(c.severity)]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:c.description})]}),c.actionable&&e.jsxs(w,{size:"sm",variant:"outline",children:[e.jsx(Ve,{className:"h-4 w-4 mr-1"}),"View"]})]})},c.id))})})]})]})}const Qs=[{id:"email",label:"Email",icon:me,description:"Send via email"},{id:"sms",label:"SMS",icon:Ge,description:"Send text message"},{id:"whatsapp",label:"WhatsApp",icon:rs,description:"Send WhatsApp message"}];function zs({clinicId:n,clinicName:k,clinicSlug:v,googlePlaceId:b}){Le();const[f,g]=j.useState(!1),[y,s]=j.useState("email"),[_,l]=j.useState(""),[o,A]=j.useState(""),[m,c]=j.useState(""),[z,h]=j.useState(""),[S,R]=j.useState(null),[P,L]=j.useState(""),[d,a]=j.useState("all"),{data:i=[],isLoading:F,refetch:q}=Q({queryKey:["review-requests-tab",n],queryFn:async()=>{const{data:t,error:N}=await C.from("review_requests").select("*").eq("clinic_id",n).order("created_at",{ascending:!1}).limit(200);if(N)throw N;return t||[]}}),{data:x=[]}=Q({queryKey:["patients-for-requests",n],queryFn:async()=>{const{data:t,error:N}=await C.from("patients").select("id, name, phone, email").eq("clinic_id",n).order("name").limit(200);if(N)throw N;return t||[]}}),D=je({mutationFn:async()=>{const{error:t}=await C.functions.invoke("send-review-request",{body:{clinicId:n,recipientName:_,recipientEmail:y==="email"?o:void 0,recipientPhone:y!=="email"?m:void 0,channel:y,customMessage:z||void 0}});if(t)throw t},onSuccess:()=>{$.success("Review request sent!"),g(!1),O(),q()},onError:t=>{$.error(t.message||"Failed to send request")}}),O=()=>{l(""),A(""),c(""),h(""),R(null)},T=t=>{const N=x.find(Z=>Z.id===t);N&&(R(t),l(N.name),A(N.email||""),c(N.phone))},K=v?`${window.location.origin}/review/${v}`:"",re=async()=>{try{await navigator.clipboard.writeText(K),$.success("Link copied!")}catch{$.error("Failed to copy")}},te=j.useMemo(()=>{const N=W(new Date,30),Z=i.filter(V=>new Date(V.created_at)>=N);return{total:i.length,last30:Z.length,sentViaEmail:i.filter(V=>V.channel==="email").length,sentViaSMS:i.filter(V=>V.channel==="sms").length,sentViaWhatsApp:i.filter(V=>V.channel==="whatsapp").length,successful:i.filter(V=>V.status==="sent").length,pending:i.filter(V=>V.status==="pending").length,failed:i.filter(V=>V.status==="failed").length}},[i]),r=j.useMemo(()=>{let t=i;if(P){const N=P.toLowerCase();t=t.filter(Z=>Z.recipient_name.toLowerCase().includes(N)||Z.recipient_email?.toLowerCase().includes(N)||Z.recipient_phone?.includes(N))}return d!=="all"&&(t=t.filter(N=>N.status===d)),t},[i,P,d]);return F?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"grid md:grid-cols-4 gap-4",children:[1,2,3,4].map(t=>e.jsx(U,{className:"h-24"},t))}),e.jsx(U,{className:"h-96"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid md:grid-cols-4 gap-4",children:[e.jsx(u,{children:e.jsx(p,{className:"p-5",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-11 w-11 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(X,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:te.total}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Sent"})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-5",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-11 w-11 rounded-xl bg-emerald-100 flex items-center justify-center",children:e.jsx(de,{className:"h-5 w-5 text-emerald-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:te.successful}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Delivered"})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-5",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-11 w-11 rounded-xl bg-amber-100 flex items-center justify-center",children:e.jsx(De,{className:"h-5 w-5 text-amber-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:te.pending}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Pending"})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-5",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-11 w-11 rounded-xl bg-blue-100 flex items-center justify-center",children:e.jsx(me,{className:"h-5 w-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:te.last30}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"This Month"})]})]})})})]}),e.jsx(u,{className:"bg-gradient-to-r from-primary/5 to-teal/5 border-primary/20",children:e.jsx(p,{className:"p-5",children:e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(Qe,{className:"h-5 w-5 text-primary"}),e.jsx("h3",{className:"font-semibold",children:"Your Review Collection Link"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Share this link to collect reviews. Positive feedback redirects to Google."})]}),e.jsxs("div",{className:"flex gap-2 flex-1",children:[e.jsx(B,{value:K,readOnly:!0,className:"bg-background"}),e.jsx(w,{variant:"outline",size:"icon",onClick:re,children:e.jsx(as,{className:"h-4 w-4"})}),K&&e.jsx(w,{variant:"outline",size:"icon",onClick:()=>window.open(K,"_blank"),children:e.jsx(ts,{className:"h-4 w-4"})})]})]})})}),e.jsxs(u,{children:[e.jsx(H,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-5 w-5 text-primary"}),"Review Requests"]}),e.jsx(I,{children:"Send and track review requests"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(w,{variant:"outline",size:"sm",onClick:()=>q(),children:[e.jsx(Be,{className:"h-4 w-4 mr-2"}),"Refresh"]}),e.jsxs(w,{size:"sm",onClick:()=>g(!0),children:[e.jsx(ze,{className:"h-4 w-4 mr-2"}),"Send Request"]})]})]})}),e.jsxs(p,{children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-3 mb-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(We,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(B,{placeholder:"Search by name, email, or phone...",value:P,onChange:t=>L(t.target.value),className:"pl-9"})]}),e.jsxs(fe,{value:d,onValueChange:a,children:[e.jsx(ve,{className:"w-40",children:e.jsx(Ne,{placeholder:"Status"})}),e.jsxs(we,{className:"bg-background border shadow-lg z-50",children:[e.jsx(G,{value:"all",children:"All Status"}),e.jsx(G,{value:"sent",children:"Delivered"}),e.jsx(G,{value:"pending",children:"Pending"}),e.jsx(G,{value:"failed",children:"Failed"})]})]})]}),e.jsx(be,{className:"h-[400px]",children:e.jsx("div",{className:"space-y-3",children:r.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(X,{className:"h-12 w-12 mx-auto mb-3 opacity-30"}),e.jsx("p",{className:"font-medium",children:"No requests yet"}),e.jsx("p",{className:"text-sm",children:"Send your first review request"})]}):r.map(t=>e.jsxs("div",{className:"flex items-center gap-4 p-4 rounded-xl bg-muted/50 hover:bg-muted transition-colors",children:[e.jsxs("div",{className:"h-10 w-10 rounded-xl bg-background flex items-center justify-center",children:[t.channel==="email"&&e.jsx(me,{className:"h-5 w-5 text-blue-500"}),t.channel==="sms"&&e.jsx(Ge,{className:"h-5 w-5 text-emerald-500"}),t.channel==="whatsapp"&&e.jsx(rs,{className:"h-5 w-5 text-green-500"})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:t.recipient_name}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:t.recipient_email||t.recipient_phone})]}),e.jsxs("div",{className:"text-right",children:[e.jsx(E,{className:t.status==="sent"?"bg-emerald-100 text-emerald-700":t.status==="pending"?"bg-amber-100 text-amber-700":"bg-red-100 text-red-700",children:t.status}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:oe(new Date(t.created_at),"MMM d, h:mm a")})]})]},t.id))})})]})]}),e.jsx(Se,{open:f,onOpenChange:g,children:e.jsxs(_e,{className:"max-w-lg",children:[e.jsxs(Ce,{children:[e.jsxs(ke,{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-5 w-5 text-primary"}),"Send Review Request"]}),e.jsx(Ee,{children:"Request a review from your patient via their preferred channel"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"grid grid-cols-3 gap-2",children:Qs.map(t=>e.jsxs("button",{type:"button",onClick:()=>s(t.id),className:`p-3 rounded-xl border-2 text-center transition-all ${y===t.id?"border-primary bg-primary/5":"border-muted hover:border-primary/50"}`,children:[e.jsx(t.icon,{className:`h-5 w-5 mx-auto mb-1 ${y===t.id?"text-primary":"text-muted-foreground"}`}),e.jsx("p",{className:"text-sm font-medium",children:t.label})]},t.id))}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:"Select Patient"}),e.jsxs(fe,{value:S||"",onValueChange:T,children:[e.jsx(ve,{children:e.jsx(Ne,{placeholder:"Choose a patient or enter manually"})}),e.jsx(we,{className:"bg-background border shadow-lg z-50 max-h-60",children:x.map(t=>e.jsx(G,{value:t.id,children:t.name},t.id))})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:"Recipient Name"}),e.jsx(B,{value:_,onChange:t=>l(t.target.value),placeholder:"Patient name"})]}),y==="email"?e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:"Email Address"}),e.jsx(B,{type:"email",value:o,onChange:t=>A(t.target.value),placeholder:"patient@example.com"})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:"Phone Number"}),e.jsx(B,{type:"tel",value:m,onChange:t=>c(t.target.value),placeholder:"+971 50 123 4567"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:"Custom Message (optional)"}),e.jsx(ms,{value:z,onChange:t=>h(t.target.value),placeholder:"Add a personalized message...",rows:3})]})]})]}),e.jsxs($e,{children:[e.jsx(w,{variant:"outline",onClick:()=>g(!1),children:"Cancel"}),e.jsxs(w,{onClick:()=>D.mutate(),disabled:D.isPending||!_||(y==="email"?!o:!m),children:[D.isPending?e.jsx(ne,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(X,{className:"h-4 w-4 mr-2"}),"Send Request"]})]})]})})]})}function Gs({clinicId:n}){const[k,v]=j.useState(""),[b,f]=j.useState("all"),[g,y]=j.useState("30d"),{data:s=[],isLoading:_}=Q({queryKey:["logs-requests",n],queryFn:async()=>{const{data:a}=await C.from("review_requests").select("*").eq("clinic_id",n).order("created_at",{ascending:!1}).limit(200);return a||[]}}),{data:l=[],isLoading:o}=Q({queryKey:["logs-funnel",n],queryFn:async()=>{const{data:a}=await C.from("review_funnel_events").select("*").eq("clinic_id",n).order("created_at",{ascending:!1}).limit(500);return a||[]}}),{data:A=[],isLoading:m}=Q({queryKey:["logs-reviews",n],queryFn:async()=>{const{data:a}=await C.from("google_reviews").select("*").eq("clinic_id",n).order("review_time",{ascending:!1}).limit(100);return a||[]}}),{data:c=[],isLoading:z}=Q({queryKey:["logs-audit",n],queryFn:async()=>{const{data:a}=await C.from("audit_logs").select("*").eq("entity_id",n).or("entity_type.eq.clinic,entity_type.eq.dentist_settings").order("created_at",{ascending:!1}).limit(100);return a||[]}}),h=j.useMemo(()=>{const a=[];return s.forEach(i=>{a.push({id:`req-${i.id}`,type:"request",title:`Review request sent to ${i.recipient_name}`,description:`Via ${i.channel}: ${i.recipient_email||i.recipient_phone}`,timestamp:new Date(i.created_at),status:i.status})}),l.forEach(i=>{a.push({id:`funnel-${i.id}`,type:"funnel",title:i.event_type==="thumbs_up"?"Positive feedback received":"Private feedback captured",description:i.comment||`Rating: ${i.rating||"N/A"} via ${i.source||"link"}`,timestamp:new Date(i.created_at),status:i.event_type})}),A.filter(i=>i.reply_status==="posted").forEach(i=>{a.push({id:`reply-${i.id}`,type:"reply",title:`Reply posted to ${i.author_name}`,description:`${i.rating}‚òÖ review replied`,timestamp:new Date(i.reply_posted_at||i.review_time),status:"posted"})}),c.forEach(i=>{(i.action?.includes("reputation")||i.action?.includes("review")||i.action?.includes("funnel"))&&a.push({id:`audit-${i.id}`,type:"setting",title:`Settings updated: ${i.action}`,description:i.user_email||"System",timestamp:new Date(i.created_at)})}),a.sort((i,F)=>F.timestamp.getTime()-i.timestamp.getTime()),a},[s,l,A,c]),S=j.useMemo(()=>{const a=new Date;let i=null;g==="7d"?i=W(a,7):g==="30d"?i=W(a,30):g==="90d"&&(i=W(a,90));let F=h;if(i&&(F=F.filter(q=>q.timestamp>=i)),b!=="all"&&(F=F.filter(q=>q.type===b)),k){const q=k.toLowerCase();F=F.filter(x=>x.title.toLowerCase().includes(q)||x.description.toLowerCase().includes(q))}return F},[h,g,b,k]),R=j.useMemo(()=>{const i=W(new Date,30),F=h.filter(q=>q.timestamp>=i);return{total:h.length,last30:F.length,requests:h.filter(q=>q.type==="request").length,funnelEvents:h.filter(q=>q.type==="funnel").length,replies:h.filter(q=>q.type==="reply").length,settings:h.filter(q=>q.type==="setting").length}},[h]),P=_||o||m||z,L=a=>{switch(a){case"request":return e.jsx(X,{className:"h-4 w-4 text-blue-500"});case"funnel":return e.jsx(xe,{className:"h-4 w-4 text-emerald-500"});case"reply":return e.jsx(ae,{className:"h-4 w-4 text-purple-500"});case"setting":return e.jsx(Ze,{className:"h-4 w-4 text-amber-500"});default:return e.jsx(ue,{className:"h-4 w-4 text-muted-foreground"})}},d=a=>{if(!a)return null;switch(a){case"sent":case"thumbs_up":case"posted":return e.jsx(E,{className:"bg-emerald-100 text-emerald-700",children:"Success"});case"pending":return e.jsx(E,{className:"bg-amber-100 text-amber-700",children:"Pending"});case"failed":case"thumbs_down":return e.jsx(E,{className:"bg-red-100 text-red-700",children:"Private"});default:return e.jsx(E,{variant:"outline",children:a})}};return P?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"grid md:grid-cols-4 gap-4",children:[1,2,3,4].map(a=>e.jsx(U,{className:"h-24"},a))}),e.jsx(U,{className:"h-96"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid md:grid-cols-4 gap-4",children:[e.jsx(u,{children:e.jsx(p,{className:"p-5",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-11 w-11 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(ue,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:R.total}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Events"})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-5",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-11 w-11 rounded-xl bg-blue-100 flex items-center justify-center",children:e.jsx(X,{className:"h-5 w-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:R.requests}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Requests Sent"})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-5",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-11 w-11 rounded-xl bg-emerald-100 flex items-center justify-center",children:e.jsx(xe,{className:"h-5 w-5 text-emerald-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:R.funnelEvents}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Funnel Events"})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-5",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-11 w-11 rounded-xl bg-purple-100 flex items-center justify-center",children:e.jsx(ae,{className:"h-5 w-5 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:R.replies}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Replies Posted"})]})]})})})]}),e.jsxs(u,{children:[e.jsx(H,{children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-5 w-5 text-primary"}),"Activity Log"]}),e.jsx(I,{children:"Complete history of reputation events"})]})})}),e.jsxs(p,{children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-3 mb-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(We,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(B,{placeholder:"Search events...",value:k,onChange:a=>v(a.target.value),className:"pl-9"})]}),e.jsxs(fe,{value:b,onValueChange:a=>f(a),children:[e.jsx(ve,{className:"w-40",children:e.jsx(Ne,{placeholder:"Event Type"})}),e.jsxs(we,{className:"bg-background border shadow-lg z-50",children:[e.jsx(G,{value:"all",children:"All Types"}),e.jsx(G,{value:"request",children:"Requests"}),e.jsx(G,{value:"funnel",children:"Funnel"}),e.jsx(G,{value:"reply",children:"Replies"}),e.jsx(G,{value:"setting",children:"Settings"})]})]}),e.jsxs(fe,{value:g,onValueChange:a=>y(a),children:[e.jsx(ve,{className:"w-32",children:e.jsx(Ne,{placeholder:"Date Range"})}),e.jsxs(we,{className:"bg-background border shadow-lg z-50",children:[e.jsx(G,{value:"7d",children:"Last 7 days"}),e.jsx(G,{value:"30d",children:"Last 30 days"}),e.jsx(G,{value:"90d",children:"Last 90 days"}),e.jsx(G,{value:"all",children:"All Time"})]})]})]}),e.jsx(be,{className:"h-[500px]",children:e.jsx("div",{className:"space-y-1",children:S.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(ue,{className:"h-12 w-12 mx-auto mb-3 opacity-30"}),e.jsx("p",{className:"font-medium",children:"No activity found"}),e.jsx("p",{className:"text-sm",children:"Events will appear here as they happen"})]}):S.map((a,i)=>e.jsxs("div",{className:"flex gap-4 p-3 rounded-xl hover:bg-muted/50 transition-colors relative",children:[i<S.length-1&&e.jsx("div",{className:"absolute left-[27px] top-12 w-0.5 h-[calc(100%-24px)] bg-border"}),e.jsx("div",{className:"h-10 w-10 rounded-xl bg-muted flex items-center justify-center shrink-0 relative z-10",children:L(a.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("p",{className:"font-medium",children:a.title}),d(a.status)]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:a.description})]}),e.jsxs("div",{className:"text-right shrink-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:oe(a.timestamp,"MMM d")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:oe(a.timestamp,"h:mm a")})]})]},a.id))})})]})]})]})}const Os=[{id:"overview",label:"Overview",icon:gs,description:"Reputation snapshot"},{id:"setup",label:"Setup",icon:Ze,description:"Configure integrations"},{id:"requests",label:"Review Requests",icon:X,description:"Send & track requests"},{id:"qr-codes",label:"QR Codes",icon:he,description:"In-clinic collection"},{id:"surveys",label:"Surveys",icon:ye,description:"Private feedback"},{id:"score",label:"Score",icon:ge,description:"Performance metrics"},{id:"alerts",label:"Alerts",icon:Re,description:"Insights & warnings"},{id:"logs",label:"History",icon:ue,description:"Activity timeline"}];function Ye(){const{user:n,isAdmin:k,isSuperAdmin:v}=Ie(),[b,f]=j.useState("overview"),[g,y]=j.useState(!1);j.useState(!1);const{data:s,isLoading:_}=Q({queryKey:["reputation-suite-clinic",n?.id],queryFn:async()=>{const{data:m,error:c}=await C.from("clinics").select("id, name, slug, google_place_id, rating, review_count").eq("claimed_by",n?.id).limit(1).maybeSingle();if(c)throw c;return m},enabled:!!n?.id&&!k&&!v}),l=()=>{f("requests")},o=()=>{y(!0)},A=async()=>{if(!s?.google_place_id){$.error("Please configure Google Business Profile first"),f("setup");return}$.info("Sync initiated. Reviews will update shortly.")};return _?e.jsxs("div",{className:"space-y-6",children:[e.jsx(U,{className:"h-20 rounded-2xl"}),e.jsx("div",{className:"grid grid-cols-4 gap-4",children:[1,2,3,4].map(m=>e.jsx(U,{className:"h-32 rounded-2xl"},m))}),e.jsx(U,{className:"h-64 rounded-2xl"})]}):!s&&!k&&!v?e.jsx(Ps,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center justify-between gap-4 p-5 rounded-2xl bg-gradient-to-br from-slate-800 via-slate-800 to-slate-900 border border-slate-700/50 shadow-xl relative overflow-hidden",children:[e.jsxs("div",{className:"absolute inset-0 pointer-events-none",children:[e.jsx("div",{className:"absolute top-0 right-0 w-64 h-64 bg-primary/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"}),e.jsx("div",{className:"absolute bottom-0 left-0 w-48 h-48 bg-teal/10 rounded-full blur-2xl translate-y-1/2 -translate-x-1/2"})]}),e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"h-12 w-12 rounded-2xl bg-gradient-to-br from-primary to-teal flex items-center justify-center shadow-lg shadow-primary/30",children:e.jsx(xs,{className:"h-6 w-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-display font-bold text-white",children:"Reputation Suite"}),e.jsx("p",{className:"text-white/60 text-sm",children:"Enterprise reputation management"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-3",children:[e.jsxs(E,{className:"bg-emerald-500/20 text-emerald-300 border-emerald-500/30",children:[e.jsx(Oe,{className:"h-3 w-3 mr-1"}),"AI Powered"]}),s.rating&&e.jsxs(E,{className:"bg-amber-500/20 text-amber-300 border-amber-500/30",children:[e.jsx(se,{className:"h-3 w-3 mr-1 fill-current"}),s.rating.toFixed(1)," Rating"]})]})]}),e.jsxs("div",{className:"relative flex gap-3",children:[e.jsxs(w,{variant:"outline",className:"gap-2 border-white/10 bg-white/5 text-white hover:bg-white/10",onClick:o,children:[e.jsx(he,{className:"h-4 w-4"}),"QR Code"]}),e.jsxs(w,{className:"gap-2 bg-gradient-to-r from-primary to-teal text-white shadow-lg shadow-primary/30",onClick:l,children:[e.jsx(X,{className:"h-4 w-4"}),"Send Request"]})]})]}),e.jsxs(Je,{value:b,onValueChange:f,className:"space-y-6",children:[e.jsx("div",{className:"overflow-x-auto pb-2 -mb-2",children:e.jsx(Xe,{className:"inline-flex h-auto bg-muted/50 p-1.5 rounded-xl border gap-1 w-auto min-w-full md:min-w-0",children:Os.map(m=>e.jsxs(Ue,{value:m.id,className:pe("flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all","data-[state=active]:bg-background data-[state=active]:shadow-sm","data-[state=inactive]:text-muted-foreground data-[state=inactive]:hover:text-foreground"),children:[e.jsx(m.icon,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden md:inline",children:m.label})]},m.id))})}),e.jsx(ee,{value:"overview",className:"mt-0",children:e.jsx(As,{clinicId:s.id,clinicName:s.name,googlePlaceId:s.google_place_id,rating:s.rating||void 0,reviewCount:s.review_count||void 0,onSendRequest:l,onOpenQR:o,onSync:A})}),e.jsx(ee,{value:"setup",className:"mt-0",children:e.jsx(Fs,{clinicId:s.id,clinicName:s.name,googlePlaceId:s.google_place_id})}),e.jsx(ee,{value:"requests",className:"mt-0",children:e.jsx(zs,{clinicId:s.id,clinicName:s.name,clinicSlug:s.slug,googlePlaceId:s.google_place_id})}),e.jsx(ee,{value:"qr-codes",className:"mt-0",children:e.jsx(Ms,{clinicId:s.id,clinicName:s.name,clinicSlug:s.slug})}),e.jsx(ee,{value:"surveys",className:"mt-0",children:e.jsx(Es,{clinicId:s.id,clinicName:s.name})}),e.jsx(ee,{value:"score",className:"mt-0",children:e.jsx($s,{clinicId:s.id,rating:s.rating,reviewCount:s.review_count})}),e.jsx(ee,{value:"alerts",className:"mt-0",children:e.jsx(Us,{clinicId:s.id,rating:s.rating||void 0})}),e.jsx(ee,{value:"logs",className:"mt-0",children:e.jsx(Gs,{clinicId:s.id})})]}),e.jsx(Se,{open:g,onOpenChange:y,children:e.jsxs(_e,{className:"max-w-2xl",children:[e.jsx(Ce,{children:e.jsxs(ke,{className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-5 w-5 text-primary"}),"Review QR Code Studio"]})}),e.jsx(ws,{clinicName:s.name,clinicSlug:s.slug,clinicId:s.id,googlePlaceId:s.google_place_id||void 0})]})})]})}function Qt(){const{isAdmin:n,isSuperAdmin:k}=Ie(),{data:v,isLoading:b,error:f}=ns();return b?e.jsxs("div",{className:"space-y-6",children:[e.jsx(U,{className:"h-20 w-full rounded-2xl"}),e.jsx("div",{className:"grid grid-cols-4 gap-4",children:[1,2,3,4].map(g=>e.jsx(U,{className:"h-32 rounded-2xl"},g))}),e.jsx(U,{className:"h-64 rounded-2xl"})]}):f?e.jsx(u,{className:"border-destructive/50",children:e.jsxs(p,{className:"py-12 text-center",children:[e.jsx("div",{className:"h-16 w-16 rounded-2xl bg-destructive/10 flex items-center justify-center mx-auto mb-4",children:e.jsx(Pe,{className:"h-8 w-8 text-destructive"})}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Error Loading Practice"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"There was an error loading your practice information."}),e.jsx(w,{variant:"outline",onClick:()=>window.location.reload(),children:"Try Again"})]})}):!v&&(n||k)?e.jsx(Ye,{}):v?e.jsx(Ye,{}):e.jsx(u,{className:"border-2 border-dashed border-primary/30 bg-primary/5",children:e.jsxs(p,{className:"py-12 text-center",children:[e.jsx("div",{className:"h-16 w-16 rounded-2xl bg-primary/10 flex items-center justify-center mx-auto mb-6",children:e.jsx(hs,{className:"h-8 w-8 text-primary"})}),e.jsx("h3",{className:"text-2xl font-bold mb-3",children:"No Practice Linked"}),e.jsx("p",{className:"text-muted-foreground max-w-lg mx-auto mb-8",children:"Your account is not linked to a dental practice yet. Claim your practice profile or contact support if you believe this is an error."}),e.jsx(w,{asChild:!0,className:"gap-2",children:e.jsx(us,{to:"/claim-profile",children:"Claim Your Practice"})})]})})}export{Qt as default};
