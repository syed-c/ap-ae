import{b as J,u as k,c as R,j as e}from"./chunk-CPh6voF3.js";import{r as n}from"./chunk-CffrGP6S.js";import{f as W,a9 as ee,bc as se,B as v,y as te,aa as ae,ab as ie,ac as re,ad as le,a as b,p as $,I as y,S as ne,x as ce,C as M,w as K,a2 as oe,a3 as de,a5 as me,a6 as xe,a7 as c,Q as T,al as he,ae as ue,t as B,i as I,m as pe,Z as ge,s as u,a1 as be,b as _}from"./index-DflORfjh.js";import{C,d as S,a as fe,b as je,c as Ne}from"./chunk-Dwq_v72W.js";import{T as we,a as ve,b as L,c as f,d as ye,e as h}from"./chunk-NLs5Ye4A.js";import{c as Q}from"./chunk-BSjc5zjM.js";import{C as V}from"./chunk-DI0yTdYZ.js";import{A as _e}from"./chunk-bmpXwoJk.js";import{C as Ce}from"./chunk-CbEmr7WL.js";import{i as O}from"./chunk-w-lBasWP.js";import{a as Se}from"./chunk-BcyAVLmp.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-Drd-rt-S.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const D=W("Gift",[["rect",{x:"3",y:"8",width:"18",height:"4",rx:"1",key:"bkv52"}],["path",{d:"M12 8v13",key:"1c76mn"}],["path",{d:"M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7",key:"6wjy6b"}],["path",{d:"M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5",key:"1ihvrl"}]]);async function De(){const p=[];let j=0;const o=1e3;let r=!0;for(;r;){const{data:d,error:m}=await u.from("clinics").select("id, name, slug, is_active, city:cities(name, state:states(name))").order("name").range(j,j+o-1);if(m)throw m;d&&d.length>0?(p.push(...d),j+=o,r=d.length===o):r=!1}return p}function Ve(){const p=J(),[j,o]=n.useState(!1),[r,d]=n.useState(""),[m,H]=n.useState(""),[a,x]=n.useState({clinic_id:"",plan_id:"",duration:"30",custom_end_date:"",reason:""}),{data:w,isLoading:z}=k({queryKey:["admin-promotions"],queryFn:async()=>{const{data:s,error:t}=await u.from("clinic_subscriptions").select(`
          *,
          clinic:clinics(id, name, slug),
          plan:subscription_plans(id, name, slug, price_monthly)
        `).not("expires_at","is",null).order("created_at",{ascending:!1});if(t)throw t;return(s||[]).filter(i=>i.stripe_subscription_id===null||i.stripe_subscription_id==="promotion")}}),{data:g=[],isLoading:U}=k({queryKey:["all-clinics-promo-unlimited"],queryFn:De}),{data:P}=k({queryKey:["subscription-plans"],queryFn:async()=>{const{data:s}=await u.from("subscription_plans").select("*").eq("is_active",!0).order("display_order");return s||[]}}),A=n.useMemo(()=>{if(!r.trim())return g;const s=r.toLowerCase();return g.filter(t=>t.name.toLowerCase().includes(s)||t.slug.toLowerCase().includes(s)||t.city?.name?.toLowerCase().includes(s)||t.city?.state?.name?.toLowerCase().includes(s))},[g,r]),N=n.useMemo(()=>{if(!m.trim())return w;const s=m.toLowerCase();return w?.filter(t=>t.clinic?.name?.toLowerCase().includes(s)||t.plan?.name?.toLowerCase().includes(s))},[w,m]),q=n.useMemo(()=>g.find(s=>s.id===a.clinic_id),[g,a.clinic_id]);n.useMemo(()=>P?.find(s=>s.id===a.plan_id),[P,a.plan_id]);const E=R({mutationFn:async s=>{const t=new Date;let i;if(s.duration==="custom"&&s.custom_end_date)i=new Date(s.custom_end_date);else{const l=parseInt(s.duration);i=l>=30?Se(t,l/30):be(t,l)}const{data:Y}=await u.from("clinic_subscriptions").select("id, plan_id").eq("clinic_id",s.clinic_id).maybeSingle();if(Y){const{error:l}=await u.from("clinic_subscriptions").update({plan_id:s.plan_id,status:"active",starts_at:t.toISOString(),expires_at:i.toISOString(),stripe_subscription_id:"promotion",updated_at:new Date().toISOString()}).eq("clinic_id",s.clinic_id);if(l)throw l}else{const{error:l}=await u.from("clinic_subscriptions").insert({clinic_id:s.clinic_id,plan_id:s.plan_id,status:"active",starts_at:t.toISOString(),expires_at:i.toISOString(),stripe_subscription_id:"promotion"});if(l)throw l}await Q({action:"GRANT_PROMOTION",entityType:"clinic_subscription",entityId:s.clinic_id,newValues:{plan_id:s.plan_id,reason:s.reason,expires_at:i.toISOString()}})},onSuccess:()=>{p.invalidateQueries({queryKey:["admin-promotions"]}),p.invalidateQueries({queryKey:["clinic-subscriptions-admin"]}),_.success("Promotion granted successfully"),o(!1),x({clinic_id:"",plan_id:"",duration:"30",custom_end_date:"",reason:""}),d("")},onError:s=>_.error("Failed: "+s.message)}),F=R({mutationFn:async s=>{const{error:t}=await u.from("clinic_subscriptions").update({status:"expired",expires_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",s);if(t)throw t;await Q({action:"REVOKE_PROMOTION",entityType:"clinic_subscription",entityId:s})},onSuccess:()=>{p.invalidateQueries({queryKey:["admin-promotions"]}),_.success("Promotion revoked")},onError:s=>_.error("Failed: "+s.message)}),Z=N?.filter(s=>s.status==="active"&&(!s.expires_at||!O(new Date(s.expires_at)))),X=N?.filter(s=>s.status!=="active"||s.expires_at&&O(new Date(s.expires_at))),G=s=>{switch(s){case"autopilot-growth":return{bg:"bg-gradient-to-r from-amber-500 to-orange-500",text:"text-white",badge:"bg-amber-100 text-amber-700 border-amber-300"};case"growth-engine":return{bg:"bg-gradient-to-r from-purple-500 to-indigo-500",text:"text-white",badge:"bg-purple-100 text-purple-700 border-purple-300"};case"verified-presence":return{bg:"bg-gradient-to-r from-blue-500 to-cyan-500",text:"text-white",badge:"bg-blue-100 text-blue-700 border-blue-300"};default:return{bg:"bg-gradient-to-r from-slate-400 to-slate-500",text:"text-white",badge:"bg-slate-100 text-slate-700 border-slate-300"}}};return z?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"bg-gradient-to-r from-violet-600 via-purple-600 to-indigo-600 rounded-2xl p-6 text-white shadow-xl",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-14 w-14 rounded-xl bg-white/20 backdrop-blur flex items-center justify-center",children:e.jsx(D,{className:"h-7 w-7 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Promotional Access"}),e.jsx("p",{className:"text-white/80",children:"Grant free premium plan access to clinics"})]})]}),e.jsxs(ee,{open:j,onOpenChange:o,children:[e.jsx(se,{asChild:!0,children:e.jsxs(v,{className:"gap-2 bg-white text-purple-700 hover:bg-white/90 shadow-lg font-semibold",children:[e.jsx(te,{className:"h-4 w-4"}),"Grant New Promotion"]})}),e.jsxs(ae,{className:"max-w-xl",children:[e.jsxs(ie,{children:[e.jsxs(re,{className:"flex items-center gap-3 text-xl",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center",children:e.jsx(D,{className:"h-5 w-5 text-white"})}),"Grant Free Plan Access"]}),e.jsxs(le,{children:["Select from ",g.length.toLocaleString()," clinics and grant promotional access"]})]}),e.jsxs("div",{className:"space-y-5 py-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(b,{className:"text-sm font-bold text-foreground",children:"Select Clinic"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(y,{placeholder:"Search by clinic name, city, or state...",value:r,onChange:s=>d(s.target.value),className:"pl-10 h-11 border-2 focus:border-purple-500"})]}),e.jsx(ne,{className:"h-44 border-2 rounded-xl bg-slate-50",children:e.jsx("div",{className:"p-2 space-y-1",children:U?e.jsx("div",{className:"text-center py-6 text-muted-foreground",children:"Loading clinics..."}):A.length===0?e.jsx("div",{className:"text-center py-6 text-muted-foreground",children:r?"No clinics found matching your search":"No clinics available"}):A.map(s=>e.jsx("button",{type:"button",onClick:()=>x({...a,clinic_id:s.id}),className:`w-full text-left px-4 py-3 rounded-lg transition-all ${a.clinic_id===s.id?"bg-gradient-to-r from-purple-500 to-indigo-600 text-white shadow-md":"hover:bg-white hover:shadow-sm"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:s.name}),s.city&&e.jsxs("p",{className:`text-xs flex items-center gap-1 ${a.clinic_id===s.id?"text-white/80":"text-muted-foreground"}`,children:[e.jsx(ce,{className:"h-3 w-3"}),s.city.name,s.city.state?.name&&`, ${s.city.state.name}`]})]}),a.clinic_id===s.id&&e.jsx(M,{className:"h-5 w-5"})]})},s.id))})}),q&&e.jsxs("div",{className:"bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-xl p-3 flex items-center gap-3",children:[e.jsx(K,{className:"h-5 w-5 text-purple-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-purple-600 font-medium",children:"Selected Clinic"}),e.jsx("p",{className:"font-bold text-purple-800",children:q.name})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(b,{className:"text-sm font-bold text-foreground",children:"Select Plan"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:P?.filter(s=>s.slug!=="free").map(s=>{G(s.slug);const t=a.plan_id===s.id;return e.jsxs("button",{type:"button",onClick:()=>x({...a,plan_id:s.id}),className:`relative p-4 rounded-xl border-2 transition-all text-left ${t?"border-purple-500 bg-purple-50 shadow-lg ring-2 ring-purple-200":"border-slate-200 hover:border-slate-300 bg-white"}`,children:[t&&e.jsx("div",{className:"absolute -top-2 -right-2 h-6 w-6 bg-purple-600 rounded-full flex items-center justify-center",children:e.jsx(M,{className:"h-4 w-4 text-white"})}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(V,{className:`h-5 w-5 ${s.slug==="autopilot-growth"?"text-amber-500":s.slug==="growth-engine"?"text-purple-500":"text-blue-500"}`}),e.jsx("span",{className:"font-bold text-foreground",children:s.name})]}),e.jsxs("div",{className:"flex items-baseline gap-1",children:[e.jsxs("span",{className:"text-2xl font-black text-foreground",children:["$",s.price_monthly||0]}),e.jsx("span",{className:"text-muted-foreground text-sm",children:"/month"})]})]},s.id)})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{className:"text-sm font-bold text-foreground",children:"Duration"}),e.jsxs(oe,{value:a.duration,onValueChange:s=>x({...a,duration:s}),children:[e.jsx(de,{className:"h-11 border-2",children:e.jsx(me,{})}),e.jsxs(xe,{children:[e.jsx(c,{value:"7",children:"7 Days"}),e.jsx(c,{value:"14",children:"14 Days"}),e.jsx(c,{value:"30",children:"1 Month"}),e.jsx(c,{value:"60",children:"2 Months"}),e.jsx(c,{value:"90",children:"3 Months"}),e.jsx(c,{value:"180",children:"6 Months"}),e.jsx(c,{value:"365",children:"1 Year"}),e.jsx(c,{value:"custom",children:"Custom Date"})]})]})]}),a.duration==="custom"?e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{className:"text-sm font-bold text-foreground",children:"End Date"}),e.jsx(y,{type:"date",value:a.custom_end_date,onChange:s=>x({...a,custom_end_date:s.target.value}),min:T(new Date,"yyyy-MM-dd"),className:"h-11 border-2"})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{className:"text-sm font-bold text-foreground",children:"Reason"}),e.jsx(y,{value:a.reason,onChange:s=>x({...a,reason:s.target.value}),placeholder:"VIP, Partner, etc.",className:"h-11 border-2"})]})]}),a.duration==="custom"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{className:"text-sm font-bold text-foreground",children:"Reason (Internal Note)"}),e.jsx(he,{value:a.reason,onChange:s=>x({...a,reason:s.target.value}),placeholder:"e.g., Partner clinic, VIP onboarding...",rows:2,className:"resize-none border-2"})]})]}),e.jsxs(ue,{className:"gap-2",children:[e.jsx(v,{variant:"outline",onClick:()=>o(!1),children:"Cancel"}),e.jsxs(v,{onClick:()=>E.mutate(a),disabled:!a.clinic_id||!a.plan_id||E.isPending,className:"gap-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700",children:[e.jsx(D,{className:"h-4 w-4"}),"Grant Promotion"]})]})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-5",children:[e.jsx(C,{className:"border-0 shadow-lg bg-gradient-to-br from-emerald-500 to-teal-600 text-white overflow-hidden",children:e.jsxs(S,{className:"p-6 relative",children:[e.jsx("div",{className:"absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-14 w-14 rounded-xl bg-white/20 backdrop-blur flex items-center justify-center",children:e.jsx(M,{className:"h-7 w-7"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-4xl font-black",children:Z?.length||0}),e.jsx("p",{className:"text-emerald-100 font-medium",children:"Active Promotions"})]})]})]})}),e.jsx(C,{className:"border-0 shadow-lg bg-gradient-to-br from-slate-500 to-slate-600 text-white overflow-hidden",children:e.jsxs(S,{className:"p-6 relative",children:[e.jsx("div",{className:"absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-14 w-14 rounded-xl bg-white/20 backdrop-blur flex items-center justify-center",children:e.jsx(B,{className:"h-7 w-7"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-4xl font-black",children:X?.length||0}),e.jsx("p",{className:"text-slate-200 font-medium",children:"Expired"})]})]})]})}),e.jsx(C,{className:"border-0 shadow-lg bg-gradient-to-br from-amber-500 to-orange-500 text-white overflow-hidden",children:e.jsxs(S,{className:"p-6 relative",children:[e.jsx("div",{className:"absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-14 w-14 rounded-xl bg-white/20 backdrop-blur flex items-center justify-center",children:e.jsx(_e,{className:"h-7 w-7"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-4xl font-black",children:w?.length||0}),e.jsx("p",{className:"text-amber-100 font-medium",children:"Total Granted"})]})]})]})})]}),e.jsxs(C,{className:"shadow-lg border-0 overflow-hidden",children:[e.jsx(fe,{className:"bg-gradient-to-r from-slate-50 to-slate-100 border-b",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx(je,{className:"text-xl font-bold text-slate-800",children:"All Promotions"}),e.jsx(Ne,{className:"text-slate-600",children:"Manage promotional plan grants with auto-expiry"})]}),e.jsxs("div",{className:"relative w-80",children:[e.jsx($,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400"}),e.jsx(y,{placeholder:"Search by clinic or plan...",value:m,onChange:s=>H(s.target.value),className:"pl-10 border-2 border-slate-200 focus:border-purple-500"})]})]})}),e.jsx(S,{className:"p-0",children:e.jsxs(we,{children:[e.jsx(ve,{children:e.jsxs(L,{className:"bg-slate-50 hover:bg-slate-50",children:[e.jsx(f,{className:"font-bold text-slate-700 py-4",children:"Clinic"}),e.jsx(f,{className:"font-bold text-slate-700",children:"Plan"}),e.jsx(f,{className:"font-bold text-slate-700",children:"Started"}),e.jsx(f,{className:"font-bold text-slate-700",children:"Expires"}),e.jsx(f,{className:"font-bold text-slate-700",children:"Status"}),e.jsx(f,{className:"text-right font-bold text-slate-700",children:"Actions"})]})}),e.jsxs(ye,{children:[N?.map(s=>{const t=s.status==="expired"||s.expires_at&&O(new Date(s.expires_at)),i=G(s.plan?.slug||"");return e.jsxs(L,{className:"hover:bg-slate-50/50",children:[e.jsx(h,{className:"py-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-purple-100 to-indigo-100 flex items-center justify-center",children:e.jsx(K,{className:"h-5 w-5 text-purple-600"})}),e.jsx("span",{className:"font-semibold text-slate-800",children:s.clinic?.name||"Unknown"})]})}),e.jsx(h,{children:e.jsxs(I,{className:`${i.badge} border font-semibold gap-1`,children:[e.jsx(V,{className:"h-3 w-3"}),s.plan?.name||"Unknown",s.plan?.price_monthly&&e.jsxs("span",{className:"ml-1",children:["($",s.plan.price_monthly,"/mo)"]})]})}),e.jsx(h,{className:"text-slate-600 font-medium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-4 w-4 text-slate-400"}),s.starts_at?T(new Date(s.starts_at),"MMM d, yyyy"):"-"]})}),e.jsx(h,{className:"text-slate-600 font-medium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-4 w-4 text-slate-400"}),s.expires_at?T(new Date(s.expires_at),"MMM d, yyyy"):"Never"]})}),e.jsx(h,{children:t?e.jsx(I,{className:"bg-slate-100 text-slate-600 border-slate-300 border font-semibold",children:"Expired"}):e.jsxs(I,{className:"bg-emerald-100 text-emerald-700 border-emerald-300 border font-semibold",children:[e.jsx(ge,{className:"h-3 w-3 mr-1"}),"Active"]})}),e.jsx(h,{className:"text-right",children:!t&&e.jsxs(v,{variant:"outline",size:"sm",onClick:()=>F.mutate(s.id),disabled:F.isPending,className:"border-red-200 text-red-600 hover:bg-red-50 hover:text-red-700 font-semibold",children:[e.jsx(Ce,{className:"h-4 w-4 mr-1"}),"Revoke"]})})]},s.id)}),(!N||N.length===0)&&e.jsx(L,{children:e.jsx(h,{colSpan:6,className:"text-center py-16",children:e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"h-16 w-16 rounded-2xl bg-gradient-to-br from-purple-100 to-indigo-100 flex items-center justify-center mb-4",children:e.jsx(D,{className:"h-8 w-8 text-purple-500"})}),e.jsx("p",{className:"font-bold text-slate-700 text-lg",children:"No promotions found"}),e.jsx("p",{className:"text-slate-500",children:"Grant a promotion to get started"})]})})})]})]})})]})]})}export{Ve as default};
