import{u as F,c as L,j as e}from"./chunk-CPh6voF3.js";import{r}from"./chunk-CffrGP6S.js";import{s as u,w as C,o as D,y as W,aj as S,a as w,n as Y,I as O,al as $,B as V,C as Z,b as c}from"./index-DflORfjh.js";import{b as K}from"./chunk-Drd-rt-S.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";function ie(){const{clinicId:n,clinicSlug:o}=K(),[E]=r.useState(()=>new URLSearchParams(window.location.search)),g=E.get("source")||"link";r.useEffect(()=>{console.log("[ReviewFunnel] Component mounted with params:",{clinicId:n,clinicSlug:o,source:g})},[n,o]);const[f,x]=r.useState("initial"),[h,U]=r.useState(0),[v,P]=r.useState(""),[b,A]=r.useState(""),[q,j]=r.useState(0),[N,y]=r.useState(!1),{data:a,isLoading:B}=F({queryKey:["clinic-review",n||o],queryFn:async()=>{const t=n||o;if(!t)throw new Error("No clinic identifier provided");const s=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t);let m=u.from("clinics").select("id, name, slug, google_place_id, cover_image_url");s?m=m.eq("id",t):m=m.eq("slug",t);const{data:I,error:R}=await m.single();if(R)throw R;return I},enabled:!!(n||o)});r.useEffect(()=>{console.log("[ReviewFunnel] Clinic data loaded:",a)},[a]);const{data:i,isLoading:p,error:_}=F({queryKey:["clinic-oauth-review-url",a?.id],queryFn:async()=>{console.log("[ReviewFunnel] Fetching oauth data for clinic:",a.id);const{data:t,error:s}=await u.from("clinic_oauth_tokens").select("gmb_data").eq("clinic_id",a.id).maybeSingle();if(s)throw console.error("[ReviewFunnel] Error fetching oauth data:",s),s;return console.log("[ReviewFunnel] OAuth query returned:",t),t},enabled:!!a?.id,retry:2,staleTime:0});r.useEffect(()=>{console.log("[ReviewFunnel] OAuth state - data:",i,"loading:",p,"error:",_),console.log("[ReviewFunnel] Clinic data:",a)},[i,p,_,a]);const G=()=>{if(console.log("[ReviewFunnel] getGoogleReviewUrl called"),console.log("[ReviewFunnel] oauthData:",i),console.log("[ReviewFunnel] clinic:",a),i?.gmb_data){let t={};if(typeof i.gmb_data=="string")try{t=JSON.parse(i.gmb_data)}catch(s){console.error("[ReviewFunnel] Failed to parse gmb_data string:",s)}else typeof i.gmb_data=="object"&&(t=i.gmb_data);if(console.log("[ReviewFunnel] gmb_data parsed:",t),t.custom_review_url&&t.custom_review_url.trim()){const s=t.custom_review_url.trim();return console.log("[ReviewFunnel] Using custom review URL:",s),s}}if(a?.google_place_id&&a.google_place_id.trim()){const t=`https://search.google.com/local/writereview?placeid=${a.google_place_id.trim()}`;return console.log("[ReviewFunnel] Using Google Place ID URL:",t),t}return console.log("[ReviewFunnel] No review URL found - oauth data:",i,"clinic place id:",a?.google_place_id),null},d=L({mutationFn:async t=>{a?.id&&await u.from("review_clicks").insert({clinic_id:a.id,action:t,user_agent:navigator.userAgent,metadata:{source:g,slug:o||n}})}}),l=L({mutationFn:async t=>{if(!a?.id)throw new Error("Clinic not loaded");const{error:s}=await u.from("review_funnel_events").insert({clinic_id:a.id,source:g,event_type:t.event_type,rating:t.rating,comment:t.comment});if(s)throw s;t.event_type==="thumbs_down"&&t.rating&&await u.from("internal_reviews").insert({clinic_id:a.id,patient_name:b||"Anonymous",rating:t.rating,comment:t.comment||null})}});r.useEffect(()=>{let t=document.querySelector('meta[name="robots"]');return t||(t=document.createElement("meta"),t.setAttribute("name","robots"),document.head.appendChild(t)),t.setAttribute("content","noindex, nofollow"),()=>{t?.setAttribute("content","index, follow")}},[]),r.useEffect(()=>{a?.id&&d.mutate("link_opened")},[a?.id]);const H=async()=>{if(!a){console.error("[ReviewFunnel] Cannot proceed - clinic data not loaded"),c.error("Please wait while we load clinic information...");return}if(p){console.log("[ReviewFunnel] Waiting for OAuth data to load..."),c.info("Loading review settings...");return}y(!0),d.mutate("thumbs_up");try{await l.mutateAsync({event_type:"thumbs_up"})}catch(s){console.error("[ReviewFunnel] Failed to record event:",s)}let t=G();!t&&a.google_place_id&&(t=`https://search.google.com/local/writereview?placeid=${a.google_place_id}`,console.log("[ReviewFunnel] Using fallback place ID URL:",t)),console.log("[ReviewFunnel] Thumbs up clicked, final Google URL:",t),t?(d.mutate("google_redirect"),c.success("Redirecting to Google Reviews..."),console.log("[ReviewFunnel] Redirecting now to:",t),window.location.href=t):(console.warn("[ReviewFunnel] No Google review URL configured for clinic:",a.id,a.name),c.info("Thank you for your feedback! Google review link not yet configured."),x("success"),y(!1))},M=()=>{d.mutate("thumbs_down"),x("negative")},T=async()=>{if(h===0){c.error("Please select a rating");return}d.mutate("feedback_submitted"),await l.mutateAsync({event_type:"thumbs_down",rating:h,comment:v.trim()||void 0}),x("success"),c.success("Thank you for your feedback")};if(B)return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"relative w-16 h-16 mx-auto mb-4",children:[e.jsx("div",{className:"absolute inset-0 rounded-full border-4 border-primary/20"}),e.jsx("div",{className:"absolute inset-0 rounded-full border-4 border-transparent border-t-primary animate-spin"})]}),e.jsx("p",{className:"text-muted-foreground",children:"Loading..."})]})});if(!a)return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100 p-4",children:e.jsxs("div",{className:"max-w-sm w-full text-center p-8 bg-white rounded-3xl shadow-xl",children:[e.jsx("div",{className:"h-16 w-16 rounded-2xl bg-destructive/10 flex items-center justify-center mx-auto mb-4",children:e.jsx(C,{className:"h-8 w-8 text-destructive"})}),e.jsx("h1",{className:"text-xl font-bold mb-2",children:"Link Not Found"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"This review link is invalid or has expired."})]})});const k=a.cover_image_url;return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 via-white to-primary/5 flex flex-col",children:[e.jsx("header",{className:"w-full py-4 px-4 flex justify-center",children:e.jsxs("div",{className:"flex items-center gap-3",children:[k?e.jsx("img",{src:k,alt:a.name,className:"h-10 w-10 rounded-xl object-cover shadow-md"}):e.jsx("div",{className:"h-10 w-10 rounded-xl bg-gradient-to-br from-primary to-teal flex items-center justify-center shadow-md",children:e.jsx(C,{className:"h-5 w-5 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-sm font-bold text-foreground leading-tight",children:a.name}),e.jsxs("p",{className:"text-[10px] text-muted-foreground flex items-center gap-1",children:[e.jsx(D,{className:"h-3 w-3"})," Verified Practice"]})]})]})}),e.jsx("main",{className:"flex-1 flex items-center justify-center px-4 pb-8",children:e.jsxs("div",{className:"w-full max-w-[360px]",children:[f==="initial"&&e.jsxs("div",{className:"text-center animate-fade-in",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"inline-flex items-center gap-1.5 px-3 py-1.5 bg-primary/10 rounded-full text-xs font-medium text-primary mb-4",children:[e.jsx(W,{className:"h-3 w-3"}),"Quick Feedback"]}),e.jsx("h2",{className:"text-2xl font-bold text-foreground mb-1",children:"How was your visit?"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Your feedback helps us improve"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{onClick:H,disabled:l.isPending||N,className:"w-full group relative flex items-center gap-4 p-5 rounded-2xl bg-white border-2 border-emerald-200 hover:border-emerald-400 hover:bg-emerald-50/50 transition-all duration-300 shadow-sm hover:shadow-lg active:scale-[0.98]",children:[N?e.jsx("div",{className:"h-12 w-12 flex items-center justify-center rounded-xl bg-emerald-100",children:e.jsx("div",{className:"w-6 h-6 border-3 border-emerald-300 border-t-emerald-600 rounded-full animate-spin"})}):e.jsx("div",{className:"h-12 w-12 flex items-center justify-center rounded-xl bg-gradient-to-br from-emerald-400 to-emerald-600 shadow-lg shadow-emerald-200 transition-transform group-hover:scale-110",children:e.jsxs("svg",{className:"h-6 w-6 text-white",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M7 10v12"}),e.jsx("path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"})]})}),e.jsxs("div",{className:"text-left flex-1",children:[e.jsx("span",{className:"text-lg font-bold text-emerald-700 block",children:"Great Experience!"}),e.jsx("span",{className:"text-xs text-emerald-600/70",children:"I loved my visit"})]}),e.jsx(S,{className:"h-5 w-5 text-emerald-400 opacity-0 group-hover:opacity-100 transition-opacity"})]}),e.jsxs("button",{onClick:M,disabled:l.isPending,className:"w-full group relative flex items-center gap-4 p-5 rounded-2xl bg-white border-2 border-slate-200 hover:border-amber-300 hover:bg-amber-50/50 transition-all duration-300 shadow-sm hover:shadow-lg active:scale-[0.98]",children:[e.jsx("div",{className:"h-12 w-12 flex items-center justify-center rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 shadow-lg shadow-amber-200 transition-transform group-hover:scale-110",children:e.jsxs("svg",{className:"h-6 w-6 text-white",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M17 14V2"}),e.jsx("path",{d:"M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L14 22h0a3.13 3.13 0 0 1-3-3.88Z"})]})}),e.jsxs("div",{className:"text-left flex-1",children:[e.jsx("span",{className:"text-lg font-bold text-slate-700 block",children:"Could Be Better"}),e.jsx("span",{className:"text-xs text-slate-500",children:"Share what we can improve"})]})]})]}),e.jsx("p",{className:"text-[11px] text-muted-foreground mt-6",children:"Your response is confidential"})]}),f==="negative"&&e.jsxs("div",{className:"animate-fade-in",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"h-14 w-14 rounded-2xl bg-amber-100 flex items-center justify-center mx-auto mb-3",children:e.jsxs("svg",{className:"h-7 w-7 text-amber-600",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M17 14V2"}),e.jsx("path",{d:"M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L14 22h0a3.13 3.13 0 0 1-3-3.88Z"})]})}),e.jsx("h2",{className:"text-xl font-bold text-foreground mb-1",children:"We're sorry to hear that"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Help us improve your next visit"})]}),e.jsxs("div",{className:"bg-white rounded-2xl border shadow-sm p-5 space-y-5",children:[e.jsxs("div",{children:[e.jsx(w,{className:"text-sm font-medium mb-2 block",children:"Your Rating"}),e.jsx("div",{className:"flex justify-center gap-1",children:[1,2,3,4,5].map(t=>e.jsx("button",{type:"button",onClick:()=>U(t),onMouseEnter:()=>j(t),onMouseLeave:()=>j(0),className:"p-1.5 transition-transform hover:scale-110 active:scale-95",children:e.jsx(Y,{className:`h-9 w-9 transition-colors ${t<=(q||h)?"fill-amber-400 text-amber-400":"text-slate-200"}`})},t))})]}),e.jsxs("div",{children:[e.jsx(w,{className:"text-sm font-medium mb-1.5 block",children:"Your Name (optional)"}),e.jsx(O,{placeholder:"Enter your name",value:b,onChange:t=>A(t.target.value),className:"rounded-xl"})]}),e.jsxs("div",{children:[e.jsx(w,{className:"text-sm font-medium mb-1.5 block",children:"What can we improve?"}),e.jsx($,{placeholder:"Please share your experience...",value:v,onChange:t=>P(t.target.value),rows:3,className:"rounded-xl resize-none"})]}),e.jsx(V,{onClick:T,disabled:h===0||l.isPending,className:"w-full h-12 rounded-xl font-semibold",children:l.isPending?"Submitting...":"Submit Feedback"}),e.jsx("button",{onClick:()=>x("initial"),className:"w-full text-sm text-muted-foreground hover:text-foreground transition-colors",children:"‚Üê Go back"})]})]}),f==="success"&&e.jsxs("div",{className:"text-center animate-fade-in",children:[e.jsxs("div",{className:"relative mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-emerald-400 to-teal-400 rounded-full blur-2xl opacity-30 animate-pulse"}),e.jsx("div",{className:"relative h-20 w-20 rounded-full bg-gradient-to-br from-emerald-400 to-teal-500 flex items-center justify-center mx-auto shadow-xl",children:e.jsx(Z,{className:"h-10 w-10 text-white"})})]}),e.jsx("h2",{className:"text-2xl font-bold text-foreground mb-2",children:"Thank You!"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Your feedback helps us serve you better."}),e.jsxs("div",{className:"inline-flex items-center gap-2 px-4 py-2 bg-primary/10 rounded-full",children:[e.jsx(S,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"text-sm font-medium text-primary",children:"We appreciate you"})]})]})]})}),e.jsx("footer",{className:"py-3 text-center",children:e.jsx("p",{className:"text-[10px] text-muted-foreground",children:"Powered by smart reputation management"})})]})}export{ie as default};
