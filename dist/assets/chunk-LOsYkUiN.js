import{u as b,b as p,c as h}from"./chunk-CPh6voF3.js";import{s,b as u}from"./index-DflORfjh.js";function E(){return b({queryKey:["admin-users"],queryFn:async()=>{const{data:{session:i}}=await s.auth.getSession();if(!i?.access_token)throw new Error("Not authenticated");const{data:a,error:r}=await s.functions.invoke("admin-list-users",{headers:{Authorization:`Bearer ${i.access_token}`}});if(r)throw console.error("Failed to fetch users:",r),new Error(r.message||"Failed to fetch users");let t=null;const{data:o,error:m}=await s.from("user_roles").select("user_id, role, created_at").order("created_at",{ascending:!1});m?console.error("Failed to fetch roles:",m):t=o;const{data:v}=await s.from("clinics").select("claimed_by, google_place_id, verification_status, slug"),c=new Map;for(const e of t||[])c.has(e.user_id)||c.set(e.user_id,[]),c.get(e.user_id).push(e.role);const g=new Map;for(const e of v||[])e.claimed_by&&g.set(e.claimed_by,{gmb_connected:!!e.google_place_id,verification_status:e.verification_status,slug:e.slug||null});return(a?.users||[]).map(e=>{const w=c.get(e.id)||["patient"],n=g.get(e.id);let l="unknown";const y=e.app_metadata?.providers||[],_=e.app_metadata?.provider;y.includes("google")||_==="google"?l=n?.gmb_connected?"gmb":"google":e.user_metadata?.created_by_admin?l="admin_created":(_==="email"||!_)&&(l="manual");let f="active";e.banned_until?f="suspended":!e.email_confirmed_at&&!e.confirmed_at&&(f="pending");let d="unverified";return n?.verification_status==="verified"?d="verified":n?.verification_status==="pending"?d="pending":(e.email_confirmed_at||e.confirmed_at)&&(d="verified"),{id:e.id,user_id:e.id,email:e.email||null,full_name:e.user_metadata?.full_name||e.user_metadata?.name||null,phone:e.phone||null,avatar_url:e.user_metadata?.avatar_url||null,created_at:e.created_at,updated_at:e.updated_at||e.created_at,roles:w,signup_method:l,account_status:f,verification_status:d,gmb_connected:n?.gmb_connected||!1,last_sign_in_at:e.last_sign_in_at||null,clinic_slug:n?.slug||null}})}})}function S(){const i=p();return h({mutationFn:async({userId:a,role:r})=>{await s.from("user_roles").delete().eq("user_id",a);const{error:t}=await s.from("user_roles").insert({user_id:a,role:r});if(t)throw t},onSuccess:()=>{i.invalidateQueries({queryKey:["admin-users"]}),u.success("Role updated")},onError:a=>u.error("Failed: "+a.message)})}function M(){const i=p();return h({mutationFn:async({userId:a,action:r})=>{const{data:{session:t}}=await s.auth.getSession();if(!t?.access_token)throw new Error("Not authenticated");const{error:o}=await s.functions.invoke("admin-manage-user",{headers:{Authorization:`Bearer ${t.access_token}`},body:{userId:a,action:r}});if(o)throw o},onSuccess:()=>{i.invalidateQueries({queryKey:["admin-users"]}),u.success("User updated")},onError:a=>u.error("Failed: "+a.message)})}export{S as a,M as b,E as u};
