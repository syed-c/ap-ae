import{b as J,u as Z,c as ee,j as e}from"./chunk-CPh6voF3.js";import{r as p}from"./chunk-CffrGP6S.js";import{o as se,i as f,Q as T,B,L as te,S as re,w as ie,U as ne,s as A,b as _}from"./index-DflORfjh.js";import{C as v,d as g,a as k,b as H,c as ae}from"./chunk-Dwq_v72W.js";import{P as ce}from"./chunk-DSDQubI6.js";import{T as M,a as P,b as E,c as o,d as I,e as l}from"./chunk-NLs5Ye4A.js";import{A as le,a as de,b as oe,c as me,d as xe,e as ue,f as he,g as je}from"./chunk--UsBvJF_.js";import{H as U}from"./chunk-C077LRJi.js";import{T as K}from"./chunk-DbdCK11k.js";import{D as G}from"./chunk-CedtSHBb.js";import{C as O}from"./chunk-f2aNMA4v.js";import{T as pe}from"./chunk-BRVan1jG.js";import{C as fe}from"./chunk-CbEmr7WL.js";import{R as q}from"./chunk-3oqKMbN4.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-Drd-rt-S.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";import"./chunk-BSjc5zjM.js";import"./chunk-k8HiDHrE.js";import"./chunk-C2VW2Ml6.js";import"./chunk-I1o_Hd8I.js";import"./chunk-CyRXX0qx.js";import"./chunk-DncHrJ4I.js";import"./chunk-CbETxTmt.js";import"./chunk-j7XJPWWF.js";import"./chunk-BaL04tya.js";import"./chunk-GLPyMM0F.js";import"./chunk-B7d2qnKb.js";import"./chunk-D2X27E5n.js";import"./chunk-Bl7VVhKV.js";import"./chunk-B_ghW3Ra.js";const ve={DELETE_ALL:"destructive",BULK_DELETE:"destructive",DELETE:"warning",UPDATE:"info",ROLE_CHANGE:"warning"},F={clinic:ie,dentist:ne,default:G};function ge(a){const t=ve[a];return t==="destructive"?"destructive":t==="warning"?"secondary":"outline"}function Ee(a){const t=a.new_values?.count;switch(a.action){case"DELETE_ALL":return`Mass deletion of ${t?t.toLocaleString():"all"} ${a.entity_type}s. Revert will trigger full recovery from Google Places API.`;case"BULK_DELETE":return`Bulk deletion of ${t?t.toLocaleString():"multiple"} ${a.entity_type}s. Revert will re-import affected records.`;case"DELETE":return`Single ${a.entity_type} deleted (ID: ${a.entity_id?.slice(0,8)}...). Revert will restore this record.`;default:return`${a.action} on ${a.entity_type}. Review details before reverting.`}}function z(a){return["DELETE_ALL","BULK_DELETE","DELETE"].includes(a.action)&&["clinic","dentist"].includes(a.entity_type)}function ss(){const a=J(),[t,w]=p.useState(null),[Q,L]=p.useState(new Set),[R,C]=p.useState({}),[V,j]=p.useState({}),D=p.useRef(new Set),{data:S,isLoading:Y}=Z({queryKey:["admin-revert-actions"],queryFn:async()=>{const{data:s,error:r}=await A.from("audit_logs").select("*").in("action",["DELETE_ALL","BULK_DELETE","DELETE","ROLE_CHANGE","UPDATE"]).gte("created_at",new Date(Date.now()-1728e5).toISOString()).order("created_at",{ascending:!1}).limit(100);if(r)throw r;return s}}),W=ee({mutationFn:async s=>{if(L(r=>new Set(r).add(s.id)),D.current.delete(s.id),s.entity_type==="clinic"&&(s.action==="DELETE_ALL"||s.action==="BULK_DELETE")){const{data:r,error:i}=await A.functions.invoke("recover-clinics",{body:{action:"get-place-ids"}});if(i)throw i;const c=r.place_ids||[],m=c.length;j(d=>({...d,[s.id]:{total:m,processed:0,imported:0,skipped:0,errors:0,running:!0}}));let n=0,u=0,h=0;const N=10;for(let d=0;d<c.length;d+=N){if(D.current.has(s.id))return j(x=>({...x,[s.id]:{...x[s.id],running:!1}})),{success:!0,message:`Cancelled after recovering ${n} clinics (${u} skipped, ${h} errors). ${c.length-d} remaining.`};const b=c.slice(d,d+N);try{const{data:x,error:X}=await A.functions.invoke("recover-clinics",{body:{action:"recover-batch",placeIds:b}});X?h+=b.length:(n+=x.imported||0,u+=x.skipped||0,h+=x.errors||0)}catch{h+=b.length}j(x=>({...x,[s.id]:{total:m,processed:Math.min(d+N,m),imported:n,skipped:u,errors:h,running:!0}})),d+N<c.length&&await new Promise(x=>setTimeout(x,300))}return j(d=>({...d,[s.id]:{total:m,processed:m,imported:n,skipped:u,errors:h,running:!1}})),{success:!0,message:`Recovered ${n} clinics (${u} skipped, ${h} errors) out of ${m} total`}}return s.entity_type==="dentist"?{success:!1,message:"Dentist recovery requires manual re-creation. Use the Data Recovery tab for bulk clinic restoration which will also restore associated data."}:{success:!1,message:"This action type cannot be automatically reverted. Please use the Data Recovery tab."}},onSuccess:(s,r)=>{C(i=>({...i,[r.id]:s})),L(i=>{const c=new Set(i);return c.delete(r.id),c}),s.success?_.success(s.message):_.info(s.message),a.invalidateQueries({queryKey:["admin-revert-actions"]})},onError:(s,r)=>{C(i=>({...i,[r.id]:{success:!1,message:s.message}})),L(i=>{const c=new Set(i);return c.delete(r.id),c}),j(i=>i[r.id]?{...i,[r.id]:{...i[r.id],running:!1}}:i),_.error(`Revert failed: ${s.message}`)}}),y=S?.filter(s=>["DELETE_ALL","BULK_DELETE","DELETE"].includes(s.action))||[],$=S?.filter(s=>!["DELETE_ALL","BULK_DELETE","DELETE"].includes(s.action))||[];return Y?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-display font-bold text-foreground flex items-center gap-3",children:[e.jsx(U,{className:"h-8 w-8 text-primary"}),"Admin Action Revert Center"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Review and revert recent admin actions. Destructive actions from the last 48 hours are shown below."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(v,{className:"border-destructive/30 bg-destructive/5",children:e.jsxs(g,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-destructive/10 flex items-center justify-center",children:e.jsx(K,{className:"h-6 w-6 text-destructive"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-destructive",children:y.length}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Destructive Actions"})]})]})}),e.jsx(v,{children:e.jsxs(g,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(G,{className:"h-6 w-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:y.reduce((s,r)=>s+(r.new_values?.count||1),0).toLocaleString()}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Records Affected"})]})]})}),e.jsx(v,{children:e.jsxs(g,{className:"p-4 flex items-center gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-xl bg-green-500/10 flex items-center justify-center",children:e.jsx(O,{className:"h-6 w-6 text-green-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:Object.values(R).filter(s=>s.success).length}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Successfully Reverted"})]})]})})]}),e.jsxs(v,{className:"border-destructive/20",children:[e.jsxs(k,{children:[e.jsxs(H,{className:"flex items-center gap-2 text-destructive",children:[e.jsx(pe,{className:"h-5 w-5"}),"Destructive Actions (Deletions)"]}),e.jsx(ae,{children:'These are delete operations that removed data. Click "Revert" to restore.'})]}),e.jsx(g,{className:"p-0",children:e.jsxs(M,{children:[e.jsx(P,{children:e.jsxs(E,{children:[e.jsx(o,{children:"Action"}),e.jsx(o,{children:"Entity"}),e.jsx(o,{children:"Records"}),e.jsx(o,{children:"User"}),e.jsx(o,{children:"Time"}),e.jsx(o,{children:"Status"}),e.jsx(o,{className:"text-right",children:"Revert"})]})}),e.jsx(I,{children:y.length===0?e.jsx(E,{children:e.jsxs(l,{colSpan:7,className:"text-center py-8 text-muted-foreground",children:[e.jsx(se,{className:"h-10 w-10 mx-auto mb-2 opacity-40"}),e.jsx("p",{children:"No destructive actions in the last 48 hours"})]})}):y.map(s=>{const r=F[s.entity_type]||F.default,i=s.new_values?.count||1,c=Q.has(s.id),m=R[s.id],n=V[s.id],u=n&&n.total>0?Math.round(n.processed/n.total*100):0;return e.jsxs(E,{className:"hover:bg-destructive/5",children:[e.jsx(l,{children:e.jsx(f,{variant:ge(s.action),children:s.action})}),e.jsx(l,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(r,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium capitalize",children:s.entity_type})]})}),e.jsx(l,{children:e.jsx("span",{className:"font-mono font-bold text-destructive",children:i.toLocaleString()})}),e.jsx(l,{className:"text-muted-foreground text-sm",children:s.user_email||"—"}),e.jsx(l,{className:"text-muted-foreground text-sm",children:T(new Date(s.created_at),"MMM d, HH:mm")}),e.jsx(l,{children:n&&n.running?e.jsxs("div",{className:"space-y-1 min-w-[140px]",children:[e.jsx(ce,{value:u,className:"h-2"}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[n.processed,"/",n.total," — ",n.imported," recovered"]})]}):m?m.success?e.jsxs(f,{className:"bg-green-600 text-white",children:[e.jsx(O,{className:"h-3 w-3 mr-1"})," Reverted"]}):e.jsxs(f,{variant:"secondary",className:"text-xs",children:[e.jsx(fe,{className:"h-3 w-3 mr-1"})," Manual"]}):e.jsx(f,{variant:"outline",className:"text-xs",children:"Pending"})}),e.jsx(l,{className:"text-right",children:c&&n?.running?e.jsx(B,{size:"sm",variant:"outline",onClick:()=>D.current.add(s.id),children:"Cancel"}):z(s)&&!m?.success?e.jsx(B,{size:"sm",variant:"destructive",disabled:c,onClick:()=>w(s),children:c?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"h-3.5 w-3.5 mr-1 animate-spin"})," Reverting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"h-3.5 w-3.5 mr-1"})," Revert"]})}):z(s)?null:e.jsx("span",{className:"text-xs text-muted-foreground",children:"N/A"})})]},s.id)})})]})})]}),$.length>0&&e.jsxs(v,{children:[e.jsx(k,{children:e.jsxs(H,{className:"text-base flex items-center gap-2",children:[e.jsx(U,{className:"h-4 w-4"}),"Other Recent Actions"]})}),e.jsx(g,{className:"p-0",children:e.jsx(re,{className:"max-h-[300px]",children:e.jsxs(M,{children:[e.jsx(P,{children:e.jsxs(E,{children:[e.jsx(o,{children:"Action"}),e.jsx(o,{children:"Entity"}),e.jsx(o,{children:"User"}),e.jsx(o,{children:"Time"})]})}),e.jsx(I,{children:$.map(s=>e.jsxs(E,{children:[e.jsx(l,{children:e.jsx(f,{variant:"outline",children:s.action})}),e.jsx(l,{className:"capitalize",children:s.entity_type}),e.jsx(l,{className:"text-muted-foreground text-sm",children:s.user_email||"—"}),e.jsx(l,{className:"text-muted-foreground text-sm",children:T(new Date(s.created_at),"MMM d, HH:mm")})]},s.id))})]})})})]}),e.jsx(le,{open:!!t,onOpenChange:s=>!s&&w(null),children:e.jsxs(de,{children:[e.jsxs(oe,{children:[e.jsxs(me,{className:"flex items-center gap-2 text-destructive",children:[e.jsx(K,{className:"h-5 w-5"}),"Confirm Revert Action"]}),e.jsxs(xe,{className:"space-y-3",children:[e.jsx("p",{children:t&&Ee(t)}),e.jsxs("div",{className:"bg-muted p-3 rounded-lg text-sm space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Action:"})," ",t?.action]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Entity:"})," ",t?.entity_type]}),e.jsxs("p",{children:[e.jsx("strong",{children:"By:"})," ",t?.user_email]}),e.jsxs("p",{children:[e.jsx("strong",{children:"When:"})," ",t&&T(new Date(t.created_at),"MMM d, yyyy HH:mm:ss")]})]}),t?.entity_type==="clinic"&&e.jsx("p",{className:"text-orange-600 text-sm font-medium",children:"⚠️ This will call Google Places API for each clinic. Large reverts may take several minutes and incur API costs."})]})]}),e.jsxs(ue,{children:[e.jsx(he,{children:"Cancel"}),e.jsxs(je,{className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",onClick:()=>{t&&(W.mutate(t),w(null))},children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),"Confirm Revert"]})]})]})})]})}export{ss as default};
