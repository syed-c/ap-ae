import{b as Y,u as F,c as D,j as e}from"./chunk-CPh6voF3.js";import{r as l}from"./chunk-CffrGP6S.js";import{a9 as R,aa as H,ab as U,x as W,ac as G,ad as J,a as j,a2 as E,a3 as I,a5 as P,a6 as k,a7 as K,B as h,I as O,L as X,s as n,b as t}from"./index-DflORfjh.js";import{P as Z}from"./chunk-HAC-i_a2.js";import{T as $}from"./chunk-DbdCK11k.js";function ie({open:c,onOpenChange:d,clinicId:f,detectedCity:b,detectedCityId:g,onLocationSelected:v}){const N=Y(),[s,S]=l.useState(g||null),[u,y]=l.useState(null),[i,m]=l.useState(!1),[p,w]=l.useState(""),[_,x]=l.useState(!1);l.useEffect(()=>{c&&(S(g||null),y(null),m(!1),w(""))},[c,g]);const{data:M,isLoading:C}=F({queryKey:["cities-for-selection"],queryFn:async()=>{const{data:a,error:r}=await n.from("cities").select("id, name, slug").eq("is_active",!0).order("name");if(r)throw r;return a},enabled:c}),{data:Q,isLoading:L}=F({queryKey:["areas-for-selection",s],queryFn:async()=>{if(!s)return[];const{data:a,error:r}=await n.from("areas").select("id, name, slug").eq("city_id",s).eq("is_active",!0).order("name");if(r)throw r;return a},enabled:c&&!!s}),T=D({mutationFn:async({cityId:a,areaId:r})=>{const{error:o}=await n.from("clinics").update({city_id:a,area_id:r,location_verified:!0,location_pending_approval:!1,is_active:!0,updated_at:new Date().toISOString()}).eq("id",f);if(o)throw o},onSuccess:()=>{N.invalidateQueries({queryKey:["user-clinic"]}),t.success("Location confirmed! Your clinic is now live."),v?.(),d(!1)},onError:a=>{t.error(a.message||"Failed to update location")}}),z=D({mutationFn:async({cityId:a,areaName:r})=>{const{data:{user:o}}=await n.auth.getUser();if(!o)throw new Error("Not authenticated");const V=r.toLowerCase().replace(/[^a-z0-9\s]/g,"").replace(/\s+/g,"-").trim(),{error:q}=await n.from("pending_areas").insert([{clinic_id:f,city_id:a,area_name:r,suggested_name:r,suggested_slug:V,submitted_by:o.id,status:"pending"}]);if(q)throw q;const{error:A}=await n.from("clinics").update({city_id:a,location_verified:!1,location_pending_approval:!0,is_active:!1,updated_at:new Date().toISOString()}).eq("id",f);if(A)throw A},onSuccess:()=>{N.invalidateQueries({queryKey:["user-clinic"]}),t.success("Area request submitted! Our team will review it shortly."),v?.(),d(!1)},onError:a=>{t.error(a.message||"Failed to submit area request")}}),B=async()=>{if(!s){t.error("Please select a city");return}if(i){if(!p.trim()){t.error("Please enter an area name");return}x(!0),await z.mutateAsync({cityId:s,areaName:p.trim()}),x(!1)}else{if(!u){t.error("Please select an area or add a new one");return}x(!0),await T.mutateAsync({cityId:s,areaId:u}),x(!1)}};return e.jsx(R,{open:c,onOpenChange:d,children:e.jsxs(H,{className:"sm:max-w-md",children:[e.jsxs(U,{children:[e.jsx("div",{className:"mx-auto h-14 w-14 rounded-full bg-amber-100 flex items-center justify-center mb-4",children:e.jsx(W,{className:"h-7 w-7 text-amber-600"})}),e.jsx(G,{className:"text-center text-xl",children:"Confirm Your Location"}),e.jsx(J,{className:"text-center",children:"We couldn't confidently match your practice area. Please select where your clinic is located so we can list you correctly."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"city",children:"City"}),e.jsxs(E,{value:s||"",onValueChange:a=>{S(a),y(null),m(!1)},disabled:C,children:[e.jsx(I,{id:"city",children:e.jsx(P,{placeholder:C?"Loading...":"Select your city"})}),e.jsx(k,{children:M?.map(a=>e.jsx(K,{value:a.id,children:a.name},a.id))})]}),b&&s&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Detected from address: ",b]})]}),s&&!i&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"area",children:"Area / Neighborhood"}),e.jsxs(E,{value:u||"",onValueChange:y,disabled:L,children:[e.jsx(I,{id:"area",children:e.jsx(P,{placeholder:L?"Loading...":"Select your area"})}),e.jsx(k,{children:Q?.map(a=>e.jsx(K,{value:a.id,children:a.name},a.id))})]}),e.jsxs(h,{type:"button",variant:"ghost",size:"sm",onClick:()=>m(!0),className:"w-full text-primary",children:[e.jsx(Z,{className:"h-4 w-4 mr-1"}),"My area is not listed"]})]}),s&&i&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"newArea",children:"New Area Name"}),e.jsx(O,{id:"newArea",placeholder:"Enter your area name",value:p,onChange:a=>w(a.target.value)}),e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-amber-50 rounded-lg border border-amber-200",children:[e.jsx($,{className:"h-4 w-4 text-amber-600 mt-0.5 flex-shrink-0"}),e.jsx("p",{className:"text-xs text-amber-800",children:"New areas require admin approval. Your clinic will remain unlisted until approved (usually within 24 hours)."})]}),e.jsx(h,{type:"button",variant:"ghost",size:"sm",onClick:()=>{m(!1),w("")},className:"text-muted-foreground",children:"â† Back to area list"})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(h,{variant:"outline",onClick:()=>d(!1),className:"flex-1",children:"Cancel"}),e.jsx(h,{onClick:B,disabled:_||!s||!u&&!i,className:"flex-1",children:_?e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"h-4 w-4 mr-2 animate-spin"}),i?"Submitting...":"Confirming..."]}):i?"Submit for Review":"Confirm Location"})]})]})})}export{ie as L};
