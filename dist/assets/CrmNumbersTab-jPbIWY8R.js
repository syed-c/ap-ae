import{b as L,u as T,c as g,j as e}from"./chunk-CPh6voF3.js";import{r as C}from"./chunk-CffrGP6S.js";import{a9 as O,bc as V,B as b,aa as W,ab as H,ac as z,a as f,I as U,a2 as q,a3 as A,a5 as P,a6 as D,a7 as m,L as G,P as E,C as J,w as F,i as S,Q as Y,s as d,b as o}from"./index-DflORfjh.js";import{C as h,d as x,a as Z,b as $,c as ee}from"./chunk-Dwq_v72W.js";import{S as R}from"./chunk-DfjE-bP6.js";import{T as se,a as ae,b as N,c as l,d as ie,e as r}from"./chunk-NLs5Ye4A.js";import{P as re}from"./chunk-HAC-i_a2.js";import{M as ne}from"./chunk-B7d2qnKb.js";import{S as te}from"./chunk-B51FxpoB.js";import{T as le}from"./chunk-BRVan1jG.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-Drd-rt-S.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";function ye(){const u=L(),[k,p]=C.useState(!1),[n,v]=C.useState(null),[a,c]=C.useState({phone_number:"",provider:"twilio",clinic_id:"",is_whatsapp_enabled:!1}),{data:t,isLoading:B}=T({queryKey:["admin-crm-numbers"],queryFn:async()=>{const{data:s,error:i}=await d.from("crm_numbers").select("*, clinic:clinics(id, name)").order("created_at",{ascending:!1});if(i)throw i;return s}}),{data:Q}=T({queryKey:["clinics-for-assignment"],queryFn:async()=>{const{data:s,error:i}=await d.from("clinics").select("id, name").eq("claim_status","claimed").order("name");if(i)throw i;return s}}),_=g({mutationFn:async()=>{const{error:s}=await d.from("crm_numbers").insert({phone_number:a.phone_number,provider:a.provider,clinic_id:a.clinic_id||null,is_whatsapp_enabled:a.is_whatsapp_enabled,assigned_at:a.clinic_id?new Date().toISOString():null});if(s)throw s},onSuccess:()=>{u.invalidateQueries({queryKey:["admin-crm-numbers"]}),p(!1),y(),o.success("CRM number added")},onError:s=>o.error(s.message||"Failed to add number")}),w=g({mutationFn:async()=>{if(!n)return;const{error:s}=await d.from("crm_numbers").update({phone_number:a.phone_number,provider:a.provider,clinic_id:a.clinic_id||null,is_whatsapp_enabled:a.is_whatsapp_enabled,assigned_at:a.clinic_id&&!n.assigned_at?new Date().toISOString():n.assigned_at}).eq("id",n.id);if(s)throw s},onSuccess:()=>{u.invalidateQueries({queryKey:["admin-crm-numbers"]}),p(!1),v(null),y(),o.success("CRM number updated")},onError:s=>o.error(s.message||"Failed to update")}),X=g({mutationFn:async({id:s,is_active:i})=>{const{error:M}=await d.from("crm_numbers").update({is_active:i}).eq("id",s);if(M)throw M},onSuccess:()=>{u.invalidateQueries({queryKey:["admin-crm-numbers"]})}}),K=g({mutationFn:async s=>{const{error:i}=await d.from("crm_numbers").delete().eq("id",s);if(i)throw i},onSuccess:()=>{u.invalidateQueries({queryKey:["admin-crm-numbers"]}),o.success("CRM number deleted")},onError:s=>o.error(s.message||"Failed to delete")}),y=()=>{c({phone_number:"",provider:"twilio",clinic_id:"",is_whatsapp_enabled:!1})},I=s=>{v(s),c({phone_number:s.phone_number,provider:s.provider,clinic_id:s.clinic_id||"",is_whatsapp_enabled:s.is_whatsapp_enabled}),p(!0)},j={total:t?.length||0,active:t?.filter(s=>s.is_active).length||0,assigned:t?.filter(s=>s.clinic_id).length||0,whatsapp:t?.filter(s=>s.is_whatsapp_enabled).length||0};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-display font-bold text-foreground",children:"CRM Numbers"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Manage virtual phone numbers for SMS/WhatsApp"})]}),e.jsxs(O,{open:k,onOpenChange:s=>{p(s),s||(v(null),y())},children:[e.jsx(V,{asChild:!0,children:e.jsxs(b,{children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Add Number"]})}),e.jsxs(W,{children:[e.jsx(H,{children:e.jsx(z,{children:n?"Edit CRM Number":"Add CRM Number"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"Phone Number"}),e.jsx(U,{value:a.phone_number,onChange:s=>c({...a,phone_number:s.target.value}),placeholder:"+971 4 XXX XXXX"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"Provider"}),e.jsxs(q,{value:a.provider,onValueChange:s=>c({...a,provider:s}),children:[e.jsx(A,{children:e.jsx(P,{})}),e.jsxs(D,{children:[e.jsx(m,{value:"twilio",children:"Twilio"}),e.jsx(m,{value:"vonage",children:"Vonage"}),e.jsx(m,{value:"messagebird",children:"MessageBird"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{children:"Assign to Clinic"}),e.jsxs(q,{value:a.clinic_id,onValueChange:s=>c({...a,clinic_id:s}),children:[e.jsx(A,{children:e.jsx(P,{placeholder:"Select clinic (optional)"})}),e.jsxs(D,{children:[e.jsx(m,{value:"",children:"Unassigned"}),Q?.map(s=>e.jsx(m,{value:s.id,children:s.name},s.id))]})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(f,{children:"WhatsApp Enabled"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Enable WhatsApp messaging on this number"})]}),e.jsx(R,{checked:a.is_whatsapp_enabled,onCheckedChange:s=>c({...a,is_whatsapp_enabled:s})})]}),e.jsxs(b,{className:"w-full",onClick:()=>n?w.mutate():_.mutate(),disabled:_.isPending||w.isPending,children:[(_.isPending||w.isPending)&&e.jsx(G,{className:"h-4 w-4 mr-2 animate-spin"}),n?"Update Number":"Add Number"]})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsx(h,{children:e.jsx(x,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-primary/10 flex items-center justify-center",children:e.jsx(E,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:j.total}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total Numbers"})]})]})})}),e.jsx(h,{children:e.jsx(x,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-green-100 flex items-center justify-center",children:e.jsx(J,{className:"h-5 w-5 text-green-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:j.active}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Active"})]})]})})}),e.jsx(h,{children:e.jsx(x,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-blue-100 flex items-center justify-center",children:e.jsx(F,{className:"h-5 w-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:j.assigned}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Assigned"})]})]})})}),e.jsx(h,{children:e.jsx(x,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-teal-100 flex items-center justify-center",children:e.jsx(ne,{className:"h-5 w-5 text-teal-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:j.whatsapp}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"WhatsApp"})]})]})})})]}),e.jsxs(h,{children:[e.jsxs(Z,{children:[e.jsx($,{children:"CRM Phone Numbers"}),e.jsx(ee,{children:"Virtual numbers for clinic messaging"})]}),e.jsx(x,{className:"p-0",children:e.jsxs(se,{children:[e.jsx(ae,{children:e.jsxs(N,{children:[e.jsx(l,{children:"Number"}),e.jsx(l,{children:"Provider"}),e.jsx(l,{children:"Clinic"}),e.jsx(l,{children:"WhatsApp"}),e.jsx(l,{children:"Status"}),e.jsx(l,{children:"Assigned"}),e.jsx(l,{className:"text-right",children:"Actions"})]})}),e.jsx(ie,{children:B?e.jsx(N,{children:e.jsx(r,{colSpan:7,className:"text-center py-8",children:"Loading..."})}):t&&t.length>0?t.map(s=>e.jsxs(N,{children:[e.jsx(r,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-mono",children:s.phone_number})]})}),e.jsx(r,{children:e.jsx(S,{variant:"outline",className:"capitalize",children:s.provider})}),e.jsx(r,{children:s.clinic?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:s.clinic.name})]}):e.jsx("span",{className:"text-muted-foreground",children:"Unassigned"})}),e.jsx(r,{children:s.is_whatsapp_enabled?e.jsx(S,{className:"bg-teal-100 text-teal-800",children:"Enabled"}):e.jsx(S,{variant:"secondary",children:"Disabled"})}),e.jsx(r,{children:e.jsx(R,{checked:s.is_active,onCheckedChange:i=>X.mutate({id:s.id,is_active:i})})}),e.jsx(r,{className:"text-muted-foreground text-sm",children:s.assigned_at?Y(new Date(s.assigned_at),"MMM d, yyyy"):"-"}),e.jsx(r,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-1",children:[e.jsx(b,{size:"sm",variant:"ghost",onClick:()=>I(s),children:e.jsx(te,{className:"h-4 w-4"})}),e.jsx(b,{size:"sm",variant:"ghost",className:"text-destructive",onClick:()=>K.mutate(s.id),children:e.jsx(le,{className:"h-4 w-4"})})]})})]},s.id)):e.jsx(N,{children:e.jsx(r,{colSpan:7,className:"text-center py-8 text-muted-foreground",children:"No CRM numbers configured"})})})]})})]})]})}export{ye as default};
