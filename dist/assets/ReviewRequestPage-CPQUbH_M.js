import{u as B,c as b,j as e}from"./chunk-CPh6voF3.js";import{r}from"./chunk-CffrGP6S.js";import{w as H,y as C,aj as W,a as x,I as S,n as M,al as O,B as q,C as z,s as n,b as c}from"./index-DflORfjh.js";import{C as g,d as v}from"./chunk-Dwq_v72W.js";import{b as G}from"./chunk-Drd-rt-S.js";import{C as E}from"./chunk-GLPyMM0F.js";import{T as U,a as F}from"./chunk-BLd3XU4A.js";import"./chunk-B8auUmee.js";import"./chunk-DK8nT4cj.js";import"./chunk-BEQ5VEiB.js";import"./chunk-yff5u8mE.js";import"./chunk-xExVBHTi.js";function ie(){const{requestCode:h}=G(),[d,o]=r.useState("initial"),[a,P]=r.useState(0),[p,T]=r.useState(""),[m,j]=r.useState(""),[N,w]=r.useState(""),[D,y]=r.useState(0),{data:s,isLoading:R,error:I}=B({queryKey:["review-request",h],queryFn:async()=>{const{data:t,error:i}=await n.from("review_requests").select(`
          id, clinic_id, patient_id, patient_name, patient_email, recipient_name, short_code, status, expires_at,
          clinic:clinics(id, name, slug, google_place_id, cover_image_url)
        `).eq("short_code",h).single();if(i)throw i;return t},enabled:!!h});r.useEffect(()=>{let t=document.querySelector('meta[name="robots"]');return t||(t=document.createElement("meta"),t.setAttribute("name","robots"),document.head.appendChild(t)),t.setAttribute("content","noindex, nofollow"),()=>{t?.setAttribute("content","index, follow")}},[]),r.useEffect(()=>{s?.expires_at&&new Date(s.expires_at)<new Date&&o("expired");const t=s?.patient_name||s?.recipient_name;t&&j(t),s?.patient_email&&w(s.patient_email)},[s]);const l=b({mutationFn:async t=>{if(!s?.clinic?.id)return;const{error:i}=await n.from("review_clicks").insert({request_id:s.id,clinic_id:s.clinic.id,action:t,user_agent:navigator.userAgent,metadata:{source:"review_request_page"}});i&&console.error("Failed to record click:",i)}}),f=b({mutationFn:async t=>{if(!s?.id)return;const{error:i}=await n.from("review_requests").update(t).eq("id",s.id);i&&console.error("Failed to update request:",i)}}),_=b({mutationFn:async()=>{if(!s?.clinic?.id)throw new Error("No clinic");const{error:t}=await n.from("internal_reviews").insert({clinic_id:s.clinic.id,request_id:s.id,patient_id:s.patient_id,patient_name:m,patient_email:N||null,rating:a,comment:p.trim()||null});if(t)throw t},onSuccess:()=>{l.mutate("feedback_submitted"),f.mutate({status:"completed",completed_at:new Date().toISOString(),outcome:"negative"}),o("success"),c.success("Thank you for your feedback")},onError:t=>{c.error("Failed to submit: "+t.message)}});r.useEffect(()=>{s?.id&&s?.status==="sent"&&(l.mutate("link_opened"),f.mutate({status:"opened",opened_at:new Date().toISOString()}))},[s?.id]);const L=async()=>{l.mutate("thumbs_up"),s?.clinic?.google_place_id?(l.mutate("google_redirect"),f.mutate({status:"completed",completed_at:new Date().toISOString(),outcome:"positive",google_redirect_clicked:!0}),await n.from("review_funnel_events").insert({clinic_id:s.clinic.id,source:"review_request",event_type:"thumbs_up"}),window.location.href=`https://search.google.com/local/writereview?placeid=${s.clinic.google_place_id}`):(c.success("Thank you for your positive feedback!"),o("success"))},Y=()=>{l.mutate("thumbs_down"),o("negative_form")},A=async()=>{if(!m.trim()){c.error("Please enter your name");return}if(a===0){c.error("Please select a rating");return}await n.from("review_funnel_events").insert({clinic_id:s?.clinic?.id,source:"review_request",event_type:"thumbs_down",rating:a,comment:p.trim()||null}),_.mutate()};if(R)return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-primary/5 via-background to-teal/5",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading..."})]})});if(I||!s)return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-primary/5 via-background to-teal/5 p-4",children:e.jsx(g,{className:"max-w-md w-full",children:e.jsxs(v,{className:"pt-8 pb-8 text-center",children:[e.jsx("div",{className:"h-16 w-16 rounded-full bg-destructive/10 flex items-center justify-center mx-auto mb-4",children:e.jsx(E,{className:"h-8 w-8 text-destructive"})}),e.jsx("h1",{className:"text-2xl font-bold mb-2",children:"Invalid Link"}),e.jsx("p",{className:"text-muted-foreground",children:"This review link is invalid or has been used."})]})})});if(d==="expired")return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-primary/5 via-background to-teal/5 p-4",children:e.jsx(g,{className:"max-w-md w-full",children:e.jsxs(v,{className:"pt-8 pb-8 text-center",children:[e.jsx("div",{className:"h-16 w-16 rounded-full bg-amber-100 flex items-center justify-center mx-auto mb-4",children:e.jsx(E,{className:"h-8 w-8 text-amber-600"})}),e.jsx("h1",{className:"text-2xl font-bold mb-2",children:"Link Expired"}),e.jsx("p",{className:"text-muted-foreground",children:"This review request has expired. Please contact the clinic for a new link."})]})})});const u=s.clinic,k=s.patient_name||s.recipient_name;return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-primary/5 via-background to-teal/5 flex items-center justify-center p-4",children:e.jsxs("div",{className:"w-full max-w-lg",children:[e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx("div",{className:"absolute top-20 left-10 w-32 h-32 bg-primary/10 rounded-full blur-3xl"}),e.jsx("div",{className:"absolute bottom-20 right-10 w-40 h-40 bg-teal/10 rounded-full blur-3xl"})]}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("div",{className:"text-center mb-8",children:[u?.cover_image_url?e.jsx("img",{src:u.cover_image_url,alt:u.name,className:"h-20 w-20 rounded-2xl object-cover mx-auto mb-4 shadow-lg border-2 border-white"}):e.jsx("div",{className:"h-20 w-20 rounded-2xl bg-gradient-to-br from-primary to-teal flex items-center justify-center mx-auto mb-4 shadow-lg",children:e.jsx(H,{className:"h-10 w-10 text-white"})}),e.jsx("h1",{className:"text-3xl font-display font-bold bg-gradient-to-r from-primary to-teal bg-clip-text text-transparent",children:u?.name}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"We value your feedback!"}),k&&e.jsxs("p",{className:"text-sm text-primary mt-1",children:["Hi ",k,"!"]})]}),e.jsxs(g,{className:"shadow-2xl border-0 overflow-hidden",children:[e.jsx("div",{className:"h-2 bg-gradient-to-r from-primary via-teal to-primary"}),e.jsxs(v,{className:"p-8",children:[d==="initial"&&e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"inline-flex items-center gap-2 px-4 py-2 bg-primary/10 rounded-full text-sm font-medium text-primary mb-6",children:[e.jsx(C,{className:"h-4 w-4"}),"Your opinion matters"]}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"How was your experience?"}),e.jsx("p",{className:"text-muted-foreground mb-8",children:"Your feedback helps us serve you better"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("button",{onClick:L,disabled:l.isPending,className:"group relative flex flex-col items-center gap-4 p-8 rounded-2xl bg-gradient-to-br from-teal/10 to-teal/5 hover:from-teal/20 hover:to-teal/10 border-2 border-teal/20 hover:border-teal/40 transition-all duration-300 hover:shadow-lg hover:shadow-teal/20 hover:-translate-y-1",children:[e.jsx("div",{className:"h-24 w-24 rounded-full bg-gradient-to-br from-teal/30 to-teal/10 flex items-center justify-center group-hover:scale-110 transition-transform duration-300 shadow-lg",children:e.jsx(U,{className:"h-12 w-12 text-teal"})}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xl font-bold text-teal block",children:"Great!"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Love it"})]}),e.jsx(W,{className:"absolute top-4 right-4 h-5 w-5 text-teal/40 group-hover:text-teal group-hover:scale-125 transition-all"})]}),e.jsxs("button",{onClick:Y,disabled:l.isPending,className:"group relative flex flex-col items-center gap-4 p-8 rounded-2xl bg-gradient-to-br from-coral/10 to-coral/5 hover:from-coral/20 hover:to-coral/10 border-2 border-coral/20 hover:border-coral/40 transition-all duration-300 hover:shadow-lg hover:shadow-coral/20 hover:-translate-y-1",children:[e.jsx("div",{className:"h-24 w-24 rounded-full bg-gradient-to-br from-coral/30 to-coral/10 flex items-center justify-center group-hover:scale-110 transition-transform duration-300 shadow-lg",children:e.jsx(F,{className:"h-12 w-12 text-coral"})}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xl font-bold text-coral block",children:"Not Great"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Could improve"})]})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-8",children:"Your response is tracked and helps us improve"})]}),d==="negative_form"&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"h-14 w-14 rounded-full bg-coral/10 flex items-center justify-center mx-auto mb-3",children:e.jsx(F,{className:"h-7 w-7 text-coral"})}),e.jsx("h2",{className:"text-xl font-bold mb-1",children:"We're sorry to hear that"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Your feedback will help us do better"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs(x,{htmlFor:"patientName",className:"text-sm font-semibold",children:["Your Name ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(S,{id:"patientName",value:m,onChange:t=>j(t.target.value),placeholder:"Enter your name",className:"mt-1"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs(x,{htmlFor:"patientEmail",className:"text-sm font-semibold",children:["Email ",e.jsx("span",{className:"text-muted-foreground font-normal",children:"(optional)"})]}),e.jsx(S,{id:"patientEmail",type:"email",value:N,onChange:t=>w(t.target.value),placeholder:"your@email.com",className:"mt-1"})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs(x,{className:"text-sm font-semibold mb-3 block",children:["Rate your experience ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx("div",{className:"flex justify-center gap-2",children:[1,2,3,4,5].map(t=>e.jsx("button",{onClick:()=>P(t),onMouseEnter:()=>y(t),onMouseLeave:()=>y(0),className:"p-1 transition-all duration-200 hover:scale-110",children:e.jsx(M,{className:`h-10 w-10 transition-all duration-200 ${t<=(D||a)?"text-gold fill-gold":"text-muted hover:text-gold/50"}`})},t))}),a>0&&e.jsxs("p",{className:"text-center text-sm text-muted-foreground mt-2",children:[a===1&&"Very Dissatisfied",a===2&&"Dissatisfied",a===3&&"Neutral",a===4&&"Satisfied",a===5&&"Very Satisfied"]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs(x,{htmlFor:"comment",className:"text-sm font-semibold",children:["What could we do better? ",e.jsx("span",{className:"text-muted-foreground font-normal",children:"(optional)"})]}),e.jsx(O,{id:"comment",value:p,onChange:t=>T(t.target.value),placeholder:"Tell us about your experience...",rows:3,className:"mt-1 resize-none"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(q,{variant:"outline",onClick:()=>o("initial"),className:"flex-1",children:"Back"}),e.jsx(q,{onClick:A,disabled:_.isPending||!m.trim()||a===0,className:"flex-1 bg-gradient-to-r from-primary to-teal",children:"Submit Feedback"})]})]}),d==="success"&&e.jsxs("div",{className:"text-center py-6",children:[e.jsxs("div",{className:"relative inline-block mb-6",children:[e.jsx("div",{className:"h-20 w-20 rounded-full bg-gradient-to-br from-teal to-primary flex items-center justify-center mx-auto shadow-lg",children:e.jsx(z,{className:"h-10 w-10 text-white"})}),e.jsx(C,{className:"absolute -top-1 -right-1 h-6 w-6 text-gold animate-pulse"})]}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Thank You!"}),e.jsx("p",{className:"text-muted-foreground max-w-xs mx-auto",children:"Your feedback is invaluable and helps us deliver better care."}),e.jsx("div",{className:"mt-6 p-4 bg-primary/5 rounded-xl",children:e.jsx("p",{className:"text-sm text-primary font-medium",children:"We appreciate you taking the time to share your thoughts."})})]})]})]}),e.jsx("div",{className:"text-center mt-6",children:e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Request ID: ",s.short_code||s.id.slice(0,8)," â€¢ Powered by ",e.jsx("span",{className:"font-semibold text-primary",children:"AppointPanda"})]})})]})]})})}export{ie as default};
